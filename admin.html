<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - متجرنا</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Runtime config generated at build time -->
    <script src="/config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Cairo', sans-serif; }
        .sidebar-link.active { background-color: #2563eb; color: white; }
        .status-new { background: #dbeafe; color: #1d4ed8; }
        .status-pending { background: #fef3c7; color: #b45309; }
        .status-confirmed { background: #d1fae5; color: #047857; }
        .status-sent { background: #e0e7ff; color: #4338ca; }
        .status-delivered { background: #10b981; color: white; }
        .status-refused { background: #fee2e2; color: #dc2626; }
        .status-returned { background: #fecaca; color: #991b1b; }
        .status-cancelled { background: #f3f4f6; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800">لوحة التحكم</h1>
                <p class="text-gray-500">تسجيل دخول المسؤول</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">البريد الإلكتروني</label>
                    <input type="email" name="email" required
                           class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">كلمة المرور</label>
                    <input type="password" name="password" required
                           class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" id="loginBtn"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">
                    تسجيل الدخول
                </button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden"></p>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Sidebar -->
        <aside class="fixed right-0 top-0 h-full w-64 bg-gray-900 text-white z-50">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold">لوحة التحكم</h1>
                <p id="userRole" class="text-sm text-gray-400"></p>
            </div>
            <nav class="p-4 space-y-2">
                <button onclick="navigateAdmin('orders')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    الطلبات
                </button>
                <button onclick="navigateAdmin('products')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                    المنتجات
                </button>
                <button onclick="navigateAdmin('categories')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    التصنيفات
                </button>
                <button onclick="navigateAdmin('shipping')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/></svg>
                    أسعار التوصيل
                </button>
                <button onclick="navigateAdmin('abandoned')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    السلات المتروكة
                </button>
                <button onclick="navigateAdmin('reviews')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                    التقييمات
                </button>
                <button onclick="navigateAdmin('upsells')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    Upsell/Downsell
                </button>
                <button onclick="navigateAdmin('analytics')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    التحليلات
                </button>
                <button onclick="navigateAdmin('settings')" class="sidebar-link w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    الإعدادات
                </button>
            </nav>
            <div class="absolute bottom-0 right-0 left-0 p-4 border-t border-gray-700">
                <button onclick="handleLogout()" class="w-full text-right px-4 py-3 rounded-lg hover:bg-gray-800 flex items-center gap-3 text-red-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    تسجيل الخروج
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="mr-64 p-8">
            <div id="adminContent">
                <!-- Dynamic content loaded here -->
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modalContainer"></div>

    <script>
        // ========================================
        // CONFIGURATION (loaded from /config.js)
        // ========================================
        const ENV = (window.__APP_CONFIG__ || {});
        const CONFIG = {
            SUPABASE_URL: ENV.NEXT_PUBLIC_SUPABASE_URL || '',
            SUPABASE_ANON_KEY: ENV.NEXT_PUBLIC_SUPABASE_ANON_KEY || '',
            CLOUDFLARE_IMAGES_ACCOUNT: ENV.NEXT_PUBLIC_CF_IMAGES_ACCOUNT_ID || '',
            ABANDONED_CART_MINUTES: 60
        };

        function ensureConfigOrShowError() {
            const missing = [];
            if (!CONFIG.SUPABASE_URL) missing.push('NEXT_PUBLIC_SUPABASE_URL');
            if (!CONFIG.SUPABASE_ANON_KEY) missing.push('NEXT_PUBLIC_SUPABASE_ANON_KEY');
            if (!CONFIG.CLOUDFLARE_IMAGES_ACCOUNT) missing.push('NEXT_PUBLIC_CF_IMAGES_ACCOUNT_ID');

            if (missing.length) {
                const el = document.getElementById('loginError');
                if (el) {
                    el.textContent = `إعدادات Supabase غير مكتملة: ${missing.join(', ')}. راجع INSTALL.md (Step 3) ثم أعد توليد config.js`;
                    el.classList.remove('hidden');
                }
                return false;
            }
            return true;
        }

        function mapSupabaseAuthError(errJson) {
            const msg = String(errJson?.error_description || errJson?.msg || errJson?.message || errJson?.error || '').toLowerCase();

            // Common Supabase auth errors
            if (msg.includes('invalid login credentials') || msg.includes('invalid_grant')) {
                return 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
            }
            if (msg.includes('email not confirmed') || msg.includes('not confirmed')) {
                return 'البريد الإلكتروني غير مؤكد. فعّل الحساب من Supabase Auth أو عطّل Email Confirmations.';
            }
            if (msg.includes('invalid api key') || msg.includes('apikey') || msg.includes('jwt')) {
                return 'مفاتيح Supabase غير صحيحة (Anon Key). راجع config.js / .env.local.';
            }
            if (msg.includes('user is banned') || msg.includes('banned')) {
                return 'تم تعطيل هذا المستخدم في Supabase Auth.';
            }
            if (msg.includes('rate limit') || msg.includes('too many requests')) {
                return 'محاولات كثيرة. انتظر قليلاً ثم أعد المحاولة.';
            }

            // Fallback
            return errJson?.error_description || errJson?.message || 'تعذر تسجيل الدخول. تحقق من الإعدادات ثم أعد المحاولة.';
        }

        // ========================================
        // STATE
        // ========================================
        const adminState = {
            user: null,
            role: null,
            accessToken: null,
            currentSection: 'orders',
            products: [],
            categories: [],
            orders: [],
            wilayas: [],
            shippingRates: [],
            reviews: [],
            settings: {}
        };

        const ORDER_STATUSES = {
            'new': 'جديد',
            'pending_confirmation': 'بانتظار التأكيد',
            'confirmed': 'مؤكد',
            'sent_to_carrier': 'تم الإرسال للناقل',
            'out_for_delivery': 'في الطريق',
            'delivered': 'تم التوصيل',
            'refused': 'مرفوض',
            'returned': 'مسترجع',
            'cancelled': 'ملغي'
        };

        const STATUS_CLASSES = {
            'new': 'status-new',
            'pending_confirmation': 'status-pending',
            'confirmed': 'status-confirmed',
            'sent_to_carrier': 'status-sent',
            'out_for_delivery': 'status-sent',
            'delivered': 'status-delivered',
            'refused': 'status-refused',
            'returned': 'status-returned',
            'cancelled': 'status-cancelled'
        };

        // ========================================
        // API HELPERS
        // ========================================
        async function supabaseAuth(email, password) {
            let response;
            try {
                response = await fetch(`${CONFIG.SUPABASE_URL}/auth/v1/token?grant_type=password`, {
                    method: 'POST',
                    headers: {
                        'apikey': CONFIG.SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
            } catch (e) {
                throw new Error('تعذر الاتصال بـ Supabase. تحقق من NEXT_PUBLIC_SUPABASE_URL وأنك تستخدم سيرفر (ليس file://).');
            }

            // Handle non-2xx responses with best-effort error parsing.
            if (!response.ok) {
                const status = response.status;
                const ct = String(response.headers.get('content-type') || '').toLowerCase();

                // Try JSON first (Supabase standard), fallback to text/HTML.
                if (ct.includes('application/json')) {
                    let errJson = null;
                    try { errJson = await response.json(); } catch { errJson = null; }
                    throw new Error(mapSupabaseAuthError(errJson));
                }

                let text = '';
                try { text = await response.text(); } catch { text = ''; }
                const snippet = text ? text.replace(/\s+/g, ' ').slice(0, 220) : '';

                // Most common root causes here: wrong SUPABASE_URL, wrong ANON KEY, blocked request/CORS, or hitting an HTML error page.
                throw new Error(
                    `تعذر تسجيل الدخول (HTTP ${status}). غالباً يوجد خطأ في NEXT_PUBLIC_SUPABASE_URL أو NEXT_PUBLIC_SUPABASE_ANON_KEY أو مشكلة اتصال/CORS.` +
                    (snippet ? `\nتفاصيل مختصرة: ${snippet}` : '')
                );
            }

            // Even on success, ensure the response is JSON.
            try {
                return await response.json();
            } catch {
                throw new Error('تم استلام رد غير صالح من Supabase (ليس JSON). تحقق من NEXT_PUBLIC_SUPABASE_URL.');
            }
        }

        async function adminQuery(table, options = {}) {
            let url = `${CONFIG.SUPABASE_URL}/rest/v1/${table}`;
            const params = new URLSearchParams();
            
            if (options.select) params.append('select', options.select);
            if (options.filter) {
                Object.entries(options.filter).forEach(([key, value]) => {
                    params.append(key, value);
                });
            }
            if (options.order) params.append('order', options.order);
            if (options.limit) params.append('limit', options.limit);
            if (options.offset) params.append('offset', options.offset);
            
            const queryString = params.toString();
            if (queryString) url += '?' + queryString;
            
            const response = await fetch(url, {
                headers: {
                    'apikey': CONFIG.SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${adminState.accessToken}`,
                    'Prefer': 'count=exact'
                }
            });
            
            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            const count = response.headers.get('content-range')?.split('/')[1];
            return { data, count: parseInt(count) || data.length };
        }

        async function adminInsert(table, data) {
            const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/${table}`, {
                method: 'POST',
                headers: {
                    'apikey': CONFIG.SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${adminState.accessToken}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Insert Error');
            return response.json();
        }

        async function adminUpdate(table, id, data) {
            const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
                method: 'PATCH',
                headers: {
                    'apikey': CONFIG.SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${adminState.accessToken}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Update Error');
            return response.json();
        }

        async function adminDelete(table, id) {
            const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
                method: 'DELETE',
                headers: {
                    'apikey': CONFIG.SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${adminState.accessToken}`
                }
            });
            if (!response.ok) throw new Error('Delete Error');
        }

        async function callAdminFunction(name, body) {
            // NOTE: Some Supabase Edge setups validate JWT at the gateway level.
            // In some cases admin access tokens are ES256 and may be rejected by the gateway as "Invalid JWT".
            // To stay secure and compatible, for the image upload function we:
            // - Send Authorization as the *anon key JWT* (HS256) to satisfy any gateway JWT verification
            // - Send the real admin JWT in a separate header (x-admin-token)
            // - The Edge Function then verifies x-admin-token via supabase.auth.getUser + admin_roles check.

            const headers = {
                'apikey': CONFIG.SUPABASE_ANON_KEY,
                'Content-Type': 'application/json'
            };

            if (name === 'cloudflare-images-upload') {
                headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
                headers['x-admin-token'] = `Bearer ${adminState.accessToken}`;
            } else {
                headers['Authorization'] = `Bearer ${adminState.accessToken}`;
            }

            const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/${name}`, {
                method: 'POST',
                headers,
                body: JSON.stringify(body)
            });

            const ct = String(response.headers.get('content-type') || '').toLowerCase();
            const data = ct.includes('application/json') ? await response.json().catch(() => ({})) : {};
            if (!response.ok) throw new Error(data.error || `Function Error (HTTP ${response.status})`);
            return data;
        }

        // ========================================
        // AUTH
        // ========================================
        async function handleLogin(e) {
            e.preventDefault();

            const form = e.target;
            const email = String(form.email.value || '').trim();
            const password = String(form.password.value || '');

            const btn = document.getElementById('loginBtn');
            const error = document.getElementById('loginError');

            error.classList.add('hidden');

            // Early config check
            if (!ensureConfigOrShowError()) {
                return;
            }

            btn.disabled = true;
            btn.textContent = 'جاري الدخول...';

            try {
                const auth = await supabaseAuth(email, password);
                adminState.accessToken = auth.access_token;
                adminState.user = auth.user;

                // Check admin role
                const { data: roles } = await adminQuery('admin_roles', {
                    filter: { user_id: `eq.${auth.user.id}` }
                });

                if (!roles.length) {
                    throw new Error('تم تسجيل الدخول لكن ليس لديك صلاحية لوحة التحكم. تأكد من إضافة user_id إلى جدول admin_roles.');
                }

                adminState.role = roles[0].role;
                localStorage.setItem('adminToken', auth.access_token);
                localStorage.setItem('adminRole', roles[0].role);

                showDashboard();
            } catch (err) {
                error.textContent = err.message || 'حدث خطأ أثناء تسجيل الدخول';
                error.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'تسجيل الدخول';
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminRole');
            adminState.accessToken = null;
            adminState.user = null;
            adminState.role = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        async function checkAuth() {
            const token = localStorage.getItem('adminToken');
            const role = localStorage.getItem('adminRole');
            
            if (token && role) {
                adminState.accessToken = token;
                adminState.role = role;
                try {
                    // Verify token is still valid
                    await adminQuery('admin_roles', { limit: 1 });
                    showDashboard();
                } catch {
                    handleLogout();
                }
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userRole').textContent = 
                adminState.role === 'admin' ? 'مسؤول' : 'دعم';
            loadInitialData();
            navigateAdmin('orders');
        }

        // ========================================
        // DATA LOADING
        // ========================================
        async function loadInitialData() {
            try {
                const [products, categories, wilayas, shippingRates] = await Promise.all([
                    adminQuery('products', { order: 'created_at.desc' }),
                    adminQuery('categories', { order: 'sort_order.asc' }),
                    adminQuery('wilayas', { order: 'code.asc' }),
                    adminQuery('shipping_rates')
                ]);
                
                adminState.products = products.data;
                adminState.categories = categories.data;
                adminState.wilayas = wilayas.data;
                adminState.shippingRates = shippingRates.data;
                
                // Load settings
                const { data: settings } = await adminQuery('settings');
                adminState.settings = settings.reduce((acc, s) => {
                    acc[s.key] = s.value;
                    return acc;
                }, {});
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // ========================================
        // NAVIGATION
        // ========================================
        function navigateAdmin(section) {
            adminState.currentSection = section;
            
            // Update sidebar
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.textContent.trim().includes(getSectionName(section))) {
                    link.classList.add('active');
                }
            });
            
            // Render section
            switch (section) {
                case 'orders': renderOrders(); break;
                case 'products': renderProducts(); break;
                case 'categories': renderCategories(); break;
                case 'shipping': renderShipping(); break;
                case 'abandoned': renderAbandonedCarts(); break;
                case 'reviews': renderReviews(); break;
                case 'upsells': renderUpsells(); break;
                case 'analytics': renderAnalytics(); break;
                case 'settings': renderSettings(); break;
            }
        }

        function getSectionName(section) {
            const names = {
                orders: 'الطلبات',
                products: 'المنتجات',
                categories: 'التصنيفات',
                shipping: 'أسعار التوصيل',
                abandoned: 'السلات المتروكة',
                reviews: 'التقييمات',
                upsells: 'Upsell',
                analytics: 'التحليلات',
                settings: 'الإعدادات'
            };
            return names[section] || '';
        }

        // ========================================
        // ORDERS SECTION
        // ========================================
        let ordersPage = 1;
        let ordersFilters = { status: '', wilaya: '', date_from: '', date_to: '' };

        async function renderOrders() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">الطلبات</h1>
                    <button onclick="exportOrders()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        تصدير CSV
                    </button>
                </div>
                
                <!-- Filters -->
                <div class="bg-white rounded-xl p-4 mb-6 grid grid-cols-2 md:grid-cols-5 gap-4">
                    <select onchange="ordersFilters.status = this.value; loadOrders()" class="px-3 py-2 border rounded-lg">
                        <option value="">كل الحالات</option>
                        ${Object.entries(ORDER_STATUSES).map(([k,v]) => `<option value="${k}">${v}</option>`).join('')}
                    </select>
                    <select onchange="ordersFilters.wilaya = this.value; loadOrders()" class="px-3 py-2 border rounded-lg">
                        <option value="">كل الولايات</option>
                        ${adminState.wilayas.map(w => `<option value="${w.code}">${w.code} - ${w.name}</option>`).join('')}
                    </select>
                    <input type="date" onchange="ordersFilters.date_from = this.value; loadOrders()" 
                           class="px-3 py-2 border rounded-lg" placeholder="من تاريخ">
                    <input type="date" onchange="ordersFilters.date_to = this.value; loadOrders()" 
                           class="px-3 py-2 border rounded-lg" placeholder="إلى تاريخ">
                    <input type="text" placeholder="بحث برقم الهاتف..." 
                           onkeyup="searchOrderByPhone(this.value)"
                           class="px-3 py-2 border rounded-lg">
                </div>
                
                <!-- Orders Table -->
                <div class="bg-white rounded-xl overflow-hidden shadow">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">رقم الطلب</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">العميل</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">الولاية</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">المبلغ</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">الحالة</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">التاريخ</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="divide-y">
                            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">جاري التحميل...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="ordersPagination" class="flex justify-center gap-2 mt-6"></div>
            `;
            
            await loadOrders();
        }

        async function loadOrders() {
            const tbody = document.getElementById('ordersTableBody');
            const limit = 20;
            const offset = (ordersPage - 1) * limit;
            
            const filter = {};
            if (ordersFilters.status) filter.status = `eq.${ordersFilters.status}`;
            if (ordersFilters.wilaya) filter.wilaya = `eq.${ordersFilters.wilaya}`;
            if (ordersFilters.date_from) filter.created_at = `gte.${ordersFilters.date_from}`;
            if (ordersFilters.date_to) filter.created_at = `lte.${ordersFilters.date_to}T23:59:59`;
            
            try {
                const { data: orders, count } = await adminQuery('orders', {
                    select: '*,order_items(*)',
                    filter,
                    order: 'created_at.desc',
                    limit,
                    offset
                });
                
                adminState.orders = orders;
                
                if (!orders.length) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">لا توجد طلبات</td></tr>';
                    return;
                }
                
                tbody.innerHTML = orders.map(order => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-mono text-sm">#${order.id.slice(0,8)}</td>
                        <td class="px-4 py-3">
                            <div>${order.full_name}</div>
                            <div class="text-sm text-gray-500">${order.phone}</div>
                        </td>
                        <td class="px-4 py-3">${order.wilaya}</td>
                        <td class="px-4 py-3 font-bold">${formatPrice(order.total)}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs ${STATUS_CLASSES[order.status]}">
                                ${ORDER_STATUSES[order.status]}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">${formatDate(order.created_at)}</td>
                        <td class="px-4 py-3">
                            <button onclick="showOrderDetails('${order.id}')" class="text-blue-600 hover:underline">عرض</button>
                        </td>
                    </tr>
                `).join('');
                
                // Pagination
                const totalPages = Math.ceil(count / limit);
                renderPagination('ordersPagination', totalPages, ordersPage, (page) => {
                    ordersPage = page;
                    loadOrders();
                });
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">حدث خطأ</td></tr>';
            }
        }

        function showOrderDetails(orderId) {
            const order = adminState.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const wilaya = adminState.wilayas.find(w => w.code === order.wilaya);
            
            showModal(`
                <div class="max-w-2xl">
                    <h2 class="text-xl font-bold mb-4">تفاصيل الطلب #${order.id.slice(0,8)}</h2>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="font-bold mb-2">معلومات العميل</h3>
                            <p><strong>الاسم:</strong> ${order.full_name}</p>
                            <p><strong>الهاتف:</strong> ${order.phone}</p>
                            <p><strong>الولاية:</strong> ${wilaya?.name || order.wilaya}</p>
                            <p><strong>البلدية:</strong> ${order.commune || '-'}</p>
                            <p><strong>العنوان:</strong> ${order.address || '-'}</p>
                            <p><strong>نوع التوصيل:</strong> ${order.delivery_type === 'home' ? 'منزل' : 'مكتب'}</p>
                            <p><strong>ملاحظات:</strong> ${order.note || '-'}</p>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">معلومات الطلب</h3>
                            <p><strong>التاريخ:</strong> ${formatDate(order.created_at)}</p>
                            <p><strong>الحالة:</strong> <span class="px-2 py-1 rounded-full text-xs ${STATUS_CLASSES[order.status]}">${ORDER_STATUSES[order.status]}</span></p>
                            <p><strong>رقم التتبع:</strong> ${order.tracking_number || '-'}</p>
                            <div class="mt-4">
                                <label class="block text-sm font-medium mb-1">تحديث الحالة</label>
                                <select onchange="updateOrderStatus('${order.id}', this.value)" class="w-full px-3 py-2 border rounded-lg">
                                    ${Object.entries(ORDER_STATUSES).map(([k,v]) => 
                                        `<option value="${k}" ${k === order.status ? 'selected' : ''}>${v}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium mb-1">رقم التتبع (WorldExpress)</label>
                                <input type="text" value="${order.tracking_number || ''}" 
                                       onchange="updateTrackingNumber('${order.id}', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg" placeholder="أدخل رقم التتبع">
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h3 class="font-bold mb-2">المنتجات</h3>
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-right">المنتج</th>
                                    <th class="px-3 py-2 text-right">الكمية</th>
                                    <th class="px-3 py-2 text-right">السعر</th>
                                    <th class="px-3 py-2 text-right">المجموع</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.order_items.map(item => {
                                    const product = adminState.products.find(p => p.id === item.product_id);
                                    return `
                                        <tr>
                                            <td class="px-3 py-2">${product?.name || item.product_id}</td>
                                            <td class="px-3 py-2">${item.quantity}</td>
                                            <td class="px-3 py-2">${formatPrice(item.price)}</td>
                                            <td class="px-3 py-2">${formatPrice(item.price * item.quantity)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot class="border-t">
                                <tr>
                                    <td colspan="3" class="px-3 py-2 text-left">المجموع الفرعي</td>
                                    <td class="px-3 py-2">${formatPrice(order.subtotal)}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="px-3 py-2 text-left">التوصيل</td>
                                    <td class="px-3 py-2">${formatPrice(order.shipping)}</td>
                                </tr>
                                <tr class="font-bold">
                                    <td colspan="3" class="px-3 py-2 text-left">الإجمالي</td>
                                    <td class="px-3 py-2">${formatPrice(order.total)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="border-t pt-4 mt-4">
                        <h3 class="font-bold mb-2">سجل الحالات</h3>
                        <div id="orderHistory" class="text-sm text-gray-600">جاري التحميل...</div>
                    </div>
                </div>
            `);
            
            loadOrderHistory(orderId);
        }

        async function loadOrderHistory(orderId) {
            try {
                const { data: history } = await adminQuery('order_status_history', {
                    filter: { order_id: `eq.${orderId}` },
                    order: 'created_at.desc'
                });
                
                document.getElementById('orderHistory').innerHTML = history.length ? 
                    history.map(h => `
                        <div class="flex justify-between py-1">
                            <span>${ORDER_STATUSES[h.status]}</span>
                            <span>${formatDate(h.created_at)}</span>
                        </div>
                    `).join('') : 'لا يوجد سجل';
            } catch (e) {}
        }

        async function updateOrderStatus(orderId, status) {
            try {
                await adminUpdate('orders', orderId, { status });
                await adminInsert('order_status_history', { order_id: orderId, status });
                await logAudit('update_order_status', { order_id: orderId, status });
                showToast('تم تحديث الحالة');
                loadOrders();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        async function updateTrackingNumber(orderId, trackingNumber) {
            try {
                await adminUpdate('orders', orderId, { tracking_number: trackingNumber });
                await logAudit('update_tracking', { order_id: orderId, tracking_number: trackingNumber });
                showToast('تم تحديث رقم التتبع');
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        async function exportOrders() {
            const { data: orders } = await adminQuery('orders', {
                select: '*',
                filter: ordersFilters.status ? { status: `eq.${ordersFilters.status}` } : {},
                order: 'created_at.desc',
                limit: 10000
            });
            
            const csv = [
                ['رقم الطلب', 'الاسم', 'الهاتف', 'الولاية', 'البلدية', 'العنوان', 'نوع التوصيل', 'المجموع', 'التوصيل', 'الإجمالي', 'الحالة', 'التاريخ', 'رقم التتبع'].join(','),
                ...orders.map(o => [
                    o.id, o.full_name, o.phone, o.wilaya, o.commune || '', o.address || '',
                    o.delivery_type, o.subtotal, o.shipping, o.total,
                    ORDER_STATUSES[o.status], o.created_at, o.tracking_number || ''
                ].map(v => `"${v}"`).join(','))
            ].join('\n');
            
            downloadCSV(csv, `orders_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ========================================
        // PRODUCTS SECTION
        // ========================================
        async function renderProducts() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">المنتجات</h1>
                    <button onclick="showProductModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        + إضافة منتج
                    </button>
                </div>
                
                <div class="bg-white rounded-xl overflow-hidden shadow">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-right">الصورة</th>
                                <th class="px-4 py-3 text-right">الاسم</th>
                                <th class="px-4 py-3 text-right">التصنيف</th>
                                <th class="px-4 py-3 text-right">السعر</th>
                                <th class="px-4 py-3 text-right">الحالة</th>
                                <th class="px-4 py-3 text-right">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="divide-y">
                            ${adminState.products.map(product => {
                                const category = adminState.categories.find(c => c.id === product.category_id);
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <img src="${getImageUrl(product.images?.[0], 'thumbnail')}" 
                                                 class="w-12 h-12 rounded object-cover">
                                        </td>
                                        <td class="px-4 py-3">${product.name}</td>
                                        <td class="px-4 py-3">${category?.name || '-'}</td>
                                        <td class="px-4 py-3">${formatPrice(product.price)}</td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded-full text-xs ${product.is_active ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}">
                                                ${product.is_active ? 'نشط' : 'غير نشط'}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <button onclick="showProductModal('${product.id}')" class="text-blue-600 hover:underline ml-2">تعديل</button>
                                            <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:underline">حذف</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showProductModal(productId = null) {
            const product = productId ? adminState.products.find(p => p.id === productId) : null;
            
            // Escape description for safe display in textarea
            const escapedDescription = product?.description ? 
                product.description.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
            
            showModal(`
                <h2 class="text-xl font-bold mb-4">${product ? 'تعديل المنتج' : 'إضافة منتج جديد'}</h2>
                <form onsubmit="saveProduct(event, '${productId || ''}')" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">اسم المنتج *</label>
                        <input type="text" name="name" value="${product?.name?.replace(/"/g, '&quot;') || ''}" required
                               class="w-full px-3 py-2 border rounded-lg" maxlength="200">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">السعر (د.ج) *</label>
                            <input type="number" name="price" value="${product?.price || ''}" required min="0"
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">السعر قبل التخفيض</label>
                            <input type="number" name="compare_price" value="${product?.compare_price || ''}" min="0"
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">التصنيف</label>
                        <select name="category_id" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">بدون تصنيف</option>
                            ${adminState.categories.map(c => 
                                `<option value="${c.id}" ${product?.category_id === c.id ? 'selected' : ''}>${c.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">وصف المنتج</label>
                        <textarea name="description" rows="5" 
                                  class="w-full px-3 py-2 border rounded-lg resize-y"
                                  maxlength="5000"
                                  placeholder="أدخل وصف المنتج هنا... (اختياري، حد أقصى 5000 حرف)">${escapedDescription}</textarea>
                        <p class="text-xs text-gray-500 mt-1">يمكنك استخدام أسطر جديدة لتنسيق النص. الحد الأقصى: 5000 حرف.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">الصور</label>
                        <div id="productImages" class="flex gap-2 flex-wrap mb-2">
                            ${(product?.images || []).map(img => `
                                <div class="relative">
                                    <img src="${getImageUrl(img, 'thumbnail')}" class="w-20 h-20 rounded object-cover">
                                    <button type="button" onclick="removeProductImage(this, '${img}')" 
                                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs">×</button>
                                </div>
                            `).join('')}
                        </div>
                        <input type="hidden" name="images" id="imagesInput" value='${JSON.stringify(product?.images || [])}'>
                        <input type="file" accept="image/*" multiple onchange="uploadProductImages(this.files)"
                               class="w-full px-3 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">يتم رفع الصور تلقائياً إلى Cloudflare Images</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="is_active" id="is_active" ${product?.is_active !== false ? 'checked' : ''}>
                        <label for="is_active">نشط</label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                            ${product ? 'حفظ التغييرات' : 'إضافة المنتج'}
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300">
                            إلغاء
                        </button>
                    </div>
                </form>
            `);
        }

        let uploadedImages = [];

        async function uploadProductImages(files) {
            for (const file of files) {
                try {
                    const result = await callAdminFunction('cloudflare-images-upload', {
                        filename: file.name,
                        contentType: file.type
                    });
                    
                    // Upload to Cloudflare signed URL (multipart/form-data)
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const uploadResponse = await fetch(result.uploadURL, {
                        method: 'POST',
                        body: formData
                    });

                    // Cloudflare upload responses may be JSON; handle gracefully
                    const upCt = String(uploadResponse.headers.get('content-type') || '').toLowerCase();
                    const upData = upCt.includes('application/json') ? await uploadResponse.json().catch(() => null) : null;
                    
                    if (uploadResponse.ok && upData?.success && upData?.result?.id) {
                        const imageId = upData.result.id;
                        
                        // Add to images
                        const currentImages = JSON.parse(document.getElementById('imagesInput').value || '[]');
                        currentImages.push(imageId);
                        document.getElementById('imagesInput').value = JSON.stringify(currentImages);
                        
                        // Show preview
                        const container = document.getElementById('productImages');
                        container.innerHTML += `
                            <div class="relative">
                                <img src="${getImageUrl(imageId, 'thumbnail')}" class="w-20 h-20 rounded object-cover">
                                <button type="button" onclick="removeProductImage(this, '${imageId}')" 
                                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs">×</button>
                            </div>
                        `;
                    } else {
                        const errMsg =
                            upData?.errors?.[0]?.message ||
                            upData?.messages?.[0] ||
                            upData?.message ||
                            `HTTP ${uploadResponse.status}`;
                        throw new Error(errMsg);
                    }
                } catch (e) {
                    showToast(e?.message || 'فشل رفع الصورة', 'error');
                }
            }
        }

        function removeProductImage(btn, imageId) {
            const currentImages = JSON.parse(document.getElementById('imagesInput').value || '[]');
            const index = currentImages.indexOf(imageId);
            if (index > -1) {
                currentImages.splice(index, 1);
                document.getElementById('imagesInput').value = JSON.stringify(currentImages);
            }
            btn.parentElement.remove();
        }

        async function saveProduct(e, productId) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                compare_price: formData.get('compare_price') ? parseFloat(formData.get('compare_price')) : null,
                category_id: formData.get('category_id') || null,
                description: formData.get('description'),
                images: JSON.parse(formData.get('images') || '[]'),
                is_active: formData.has('is_active')
            };
            
            try {
                if (productId) {
                    await adminUpdate('products', productId, data);
                    await logAudit('update_product', { product_id: productId });
                } else {
                    await adminInsert('products', data);
                    await logAudit('create_product', { name: data.name });
                }
                
                closeModal();
                showToast(productId ? 'تم تحديث المنتج' : 'تم إضافة المنتج');
                await loadInitialData();
                renderProducts();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
            
            try {
                await adminDelete('products', productId);
                await logAudit('delete_product', { product_id: productId });
                showToast('تم حذف المنتج');
                await loadInitialData();
                renderProducts();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        // ========================================
        // CATEGORIES SECTION
        // ========================================
        async function renderCategories() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">التصنيفات</h1>
                    <button onclick="showCategoryModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        + إضافة تصنيف
                    </button>
                </div>
                
                <div class="bg-white rounded-xl overflow-hidden shadow">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-right">الاسم</th>
                                <th class="px-4 py-3 text-right">الترتيب</th>
                                <th class="px-4 py-3 text-right">الحالة</th>
                                <th class="px-4 py-3 text-right">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${adminState.categories.map(cat => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">${cat.name}</td>
                                    <td class="px-4 py-3">${cat.sort_order || 0}</td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded-full text-xs ${cat.is_active ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}">
                                            ${cat.is_active ? 'نشط' : 'غير نشط'}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <button onclick="showCategoryModal('${cat.id}')" class="text-blue-600 hover:underline ml-2">تعديل</button>
                                        <button onclick="deleteCategory('${cat.id}')" class="text-red-600 hover:underline">حذف</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showCategoryModal(categoryId = null) {
            const category = categoryId ? adminState.categories.find(c => c.id === categoryId) : null;

            const parentOptions = adminState.categories
                .filter(c => c.id !== categoryId)
                .map(c => `<option value="${c.id}" ${category?.parent_id === c.id ? 'selected' : ''}>${c.name}</option>`)
                .join('');
            
            showModal(`
                <h2 class="text-xl font-bold mb-4">${category ? 'تعديل التصنيف' : 'إضافة تصنيف جديد'}</h2>
                <form onsubmit="saveCategory(event, '${categoryId || ''}')" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">اسم التصنيف *</label>
                        <input type="text" name="name" value="${category?.name || ''}" required
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">التصنيف الأب (اختياري)</label>
                        <select name="parent_id" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">بدون</option>
                            ${parentOptions}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">يساعد على إنشاء تصنيفات فرعية.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">الترتيب</label>
                        <input type="number" name="sort_order" value="${category?.sort_order || 0}"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="is_active" id="cat_active" ${category?.is_active !== false ? 'checked' : ''}>
                        <label for="cat_active">نشط</label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">حفظ</button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 py-2 rounded-lg">إلغاء</button>
                    </div>
                </form>
            `);
        }

        async function saveCategory(e, categoryId) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                sort_order: parseInt(formData.get('sort_order')) || 0,
                is_active: formData.has('is_active')
            };
            
            try {
                if (categoryId) {
                    await adminUpdate('categories', categoryId, data);
                } else {
                    await adminInsert('categories', data);
                }
                closeModal();
                showToast('تم الحفظ');
                await loadInitialData();
                renderCategories();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('هل أنت متأكد؟')) return;
            try {
                await adminDelete('categories', categoryId);
                showToast('تم الحذف');
                await loadInitialData();
                renderCategories();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        // ========================================
        // SHIPPING SECTION
        // ========================================
        async function renderShipping() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">أسعار التوصيل</h1>
                    <div class="flex gap-2">
                        <button onclick="exportShippingRates()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">تصدير CSV</button>
                        <label class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 cursor-pointer">
                            استيراد CSV
                            <input type="file" accept=".csv" onchange="importShippingRates(this.files[0])" class="hidden">
                        </label>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl overflow-hidden shadow">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-right">الولاية</th>
                                <th class="px-4 py-3 text-right">سعر المكتب</th>
                                <th class="px-4 py-3 text-right">المكتب مفعّل</th>
                                <th class="px-4 py-3 text-right">سعر المنزل</th>
                                <th class="px-4 py-3 text-right">المنزل مفعّل</th>
                                <th class="px-4 py-3 text-right">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${adminState.wilayas.map(wilaya => {
                                const officeRate = adminState.shippingRates.find(r => r.wilaya_code === wilaya.code && r.delivery_type === 'office');
                                const homeRate = adminState.shippingRates.find(r => r.wilaya_code === wilaya.code && r.delivery_type === 'home');
                                return `
                                    <tr class="hover:bg-gray-50" data-wilaya="${wilaya.code}">
                                        <td class="px-4 py-3">${wilaya.code} - ${wilaya.name}</td>
                                        <td class="px-4 py-3">
                                            <input type="number" value="${officeRate?.price || 0}" 
                                                   class="w-24 px-2 py-1 border rounded" data-type="office-price">
                                        </td>
                                        <td class="px-4 py-3">
                                            <input type="checkbox" ${officeRate?.is_enabled ? 'checked' : ''} data-type="office-enabled">
                                        </td>
                                        <td class="px-4 py-3">
                                            <input type="number" value="${homeRate?.price || 0}" 
                                                   class="w-24 px-2 py-1 border rounded" data-type="home-price">
                                        </td>
                                        <td class="px-4 py-3">
                                            <input type="checkbox" ${homeRate?.is_enabled ? 'checked' : ''} data-type="home-enabled">
                                        </td>
                                        <td class="px-4 py-3">
                                            <button onclick="saveShippingRate('${wilaya.code}')" class="text-blue-600 hover:underline">حفظ</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function saveShippingRate(wilayaCode) {
            const row = document.querySelector(`tr[data-wilaya="${wilayaCode}"]`);
            const officePrice = parseInt(row.querySelector('[data-type="office-price"]').value);
            const officeEnabled = row.querySelector('[data-type="office-enabled"]').checked;
            const homePrice = parseInt(row.querySelector('[data-type="home-price"]').value);
            const homeEnabled = row.querySelector('[data-type="home-enabled"]').checked;
            
            try {
                // Upsert office rate
                const existingOffice = adminState.shippingRates.find(r => r.wilaya_code === wilayaCode && r.delivery_type === 'office');
                if (existingOffice) {
                    await adminUpdate('shipping_rates', existingOffice.id, { price: officePrice, is_enabled: officeEnabled });
                } else {
                    await adminInsert('shipping_rates', { wilaya_code: wilayaCode, delivery_type: 'office', price: officePrice, is_enabled: officeEnabled });
                }
                
                // Upsert home rate
                const existingHome = adminState.shippingRates.find(r => r.wilaya_code === wilayaCode && r.delivery_type === 'home');
                if (existingHome) {
                    await adminUpdate('shipping_rates', existingHome.id, { price: homePrice, is_enabled: homeEnabled });
                } else {
                    await adminInsert('shipping_rates', { wilaya_code: wilayaCode, delivery_type: 'home', price: homePrice, is_enabled: homeEnabled });
                }
                
                await logAudit('update_shipping_rate', { wilaya: wilayaCode });
                showToast('تم الحفظ');
                await loadInitialData();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        function exportShippingRates() {
            const csv = [
                ['wilaya_code', 'wilaya_name', 'office_price', 'office_enabled', 'home_price', 'home_enabled'].join(','),
                ...adminState.wilayas.map(w => {
                    const office = adminState.shippingRates.find(r => r.wilaya_code === w.code && r.delivery_type === 'office');
                    const home = adminState.shippingRates.find(r => r.wilaya_code === w.code && r.delivery_type === 'home');
                    return [w.code, w.name, office?.price || 0, office?.is_enabled || false, home?.price || 0, home?.is_enabled || false].join(',');
                })
            ].join('\n');
            downloadCSV(csv, 'shipping_rates.csv');
        }

        // ========================================
        // ABANDONED CARTS SECTION
        // ========================================
        async function renderAbandonedCarts() {
            const threshold = new Date(Date.now() - CONFIG.ABANDONED_CART_MINUTES * 60 * 1000).toISOString();
            
            const { data: carts } = await adminQuery('carts', {
                filter: { updated_at: `lt.${threshold}` },
                order: 'updated_at.desc',
                limit: 50
            });
            
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">السلات المتروكة</h1>
                    <span class="text-gray-500">العتبة: ${CONFIG.ABANDONED_CART_MINUTES} دقيقة</span>
                </div>
                
                <div class="bg-white rounded-xl overflow-hidden shadow">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-right">الهاتف</th>
                                <th class="px-4 py-3 text-right">القيمة</th>
                                <th class="px-4 py-3 text-right">المنتجات</th>
                                <th class="px-4 py-3 text-right">آخر نشاط</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${carts.length ? carts.map(cart => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">${cart.phone || '-'}</td>
                                    <td class="px-4 py-3">${formatPrice(cart.total_value || 0)}</td>
                                    <td class="px-4 py-3">${(cart.items || []).length} منتج</td>
                                    <td class="px-4 py-3 text-gray-500">${formatDate(cart.updated_at)}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">لا توجد سلات متروكة</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ========================================
        // REVIEWS SECTION
        // ========================================
        async function renderReviews() {
            const { data: reviews } = await adminQuery('reviews', {
                select: '*,products(name)',
                order: 'created_at.desc'
            });
            
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <h1 class="text-2xl font-bold mb-6">التقييمات</h1>
                
                <div class="space-y-4">
                    ${reviews.length ? reviews.map(review => `
                        <div class="bg-white rounded-xl p-4 shadow flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold">${review.reviewer_name}</span>
                                    <span class="text-yellow-400">${'★'.repeat(review.rating)}</span>
                                    <span class="px-2 py-0.5 rounded-full text-xs ${
                                        review.status === 'approved' ? 'bg-green-100 text-green-600' :
                                        review.status === 'rejected' ? 'bg-red-100 text-red-600' :
                                        'bg-yellow-100 text-yellow-600'
                                    }">${review.status === 'approved' ? 'موافق' : review.status === 'rejected' ? 'مرفوض' : 'بانتظار المراجعة'}</span>
                                </div>
                                <p class="text-sm text-gray-500 mb-1">المنتج: ${review.products?.name || '-'}</p>
                                <p class="text-gray-600">${review.comment}</p>
                                <span class="text-xs text-gray-400">${formatDate(review.created_at)}</span>
                            </div>
                            <div class="flex gap-2">
                                ${review.status !== 'approved' ? `
                                    <button onclick="updateReviewStatus('${review.id}', 'approved')" 
                                            class="px-3 py-1 bg-green-100 text-green-600 rounded-lg hover:bg-green-200">موافقة</button>
                                ` : ''}
                                ${review.status !== 'rejected' ? `
                                    <button onclick="updateReviewStatus('${review.id}', 'rejected')" 
                                            class="px-3 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">رفض</button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('') : '<p class="text-center text-gray-500 py-8">لا توجد تقييمات</p>'}
                </div>
            `;
        }

        async function updateReviewStatus(reviewId, status) {
            try {
                await adminUpdate('reviews', reviewId, { status });
                showToast('تم التحديث');
                renderReviews();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        // ========================================
        // UPSELLS SECTION
        // ========================================
        async function renderUpsells() {
            const { data: rules } = await adminQuery('upsell_rules', { order: 'created_at.desc' });
            
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">Upsell / Downsell</h1>
                    <button onclick="showUpsellRuleModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        + إضافة قاعدة
                    </button>
                </div>
                
                <div class="bg-white rounded-xl overflow-hidden shadow">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-right">النوع</th>
                                <th class="px-4 py-3 text-right">المنتج المحفّز</th>
                                <th class="px-4 py-3 text-right">المنتج المقترح</th>
                                <th class="px-4 py-3 text-right">الخصم</th>
                                <th class="px-4 py-3 text-right">الحالة</th>
                                <th class="px-4 py-3 text-right">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${rules.map(rule => {
                                const trigger = adminState.products.find(p => p.id === rule.trigger_product_id);
                                const target = adminState.products.find(p => p.id === rule.upsell_product_id);
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">${rule.type === 'upsell' ? 'Upsell' : 'Downsell'}</td>
                                        <td class="px-4 py-3">${trigger?.name || '-'}</td>
                                        <td class="px-4 py-3">${target?.name || '-'}</td>
                                        <td class="px-4 py-3">${rule.discount_percent || 0}%</td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded-full text-xs ${rule.is_active ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}">
                                                ${rule.is_active ? 'نشط' : 'غير نشط'}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <button onclick="deleteUpsellRule('${rule.id}')" class="text-red-600 hover:underline">حذف</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showUpsellRuleModal() {
            showModal(`
                <h2 class="text-xl font-bold mb-4">إضافة قاعدة Upsell/Downsell</h2>
                <form onsubmit="saveUpsellRule(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">النوع</label>
                        <select name="type" class="w-full px-3 py-2 border rounded-lg">
                            <option value="upsell">Upsell (عند الإضافة للسلة)</option>
                            <option value="downsell">Downsell (عند الحذف من السلة)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">المنتج المحفّز</label>
                        <select name="trigger_product_id" required class="w-full px-3 py-2 border rounded-lg">
                            <option value="">اختر المنتج</option>
                            ${adminState.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">المنتج المقترح</label>
                        <select name="upsell_product_id" required class="w-full px-3 py-2 border rounded-lg">
                            <option value="">اختر المنتج</option>
                            ${adminState.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">نسبة الخصم (%)</label>
                        <input type="number" name="discount_percent" min="0" max="100" value="0"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="is_active" id="rule_active" checked>
                        <label for="rule_active">نشط</label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">إضافة</button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 py-2 rounded-lg">إلغاء</button>
                    </div>
                </form>
            `);
        }

        async function saveUpsellRule(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                await adminInsert('upsell_rules', {
                    type: formData.get('type'),
                    trigger_product_id: formData.get('trigger_product_id'),
                    upsell_product_id: formData.get('upsell_product_id'),
                    discount_percent: parseInt(formData.get('discount_percent')) || 0,
                    is_active: formData.has('is_active')
                });
                closeModal();
                showToast('تم الإضافة');
                renderUpsells();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        async function deleteUpsellRule(ruleId) {
            if (!confirm('هل أنت متأكد؟')) return;
            try {
                await adminDelete('upsell_rules', ruleId);
                showToast('تم الحذف');
                renderUpsells();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        // ========================================
        // ANALYTICS SECTION
        // ========================================
        async function renderAnalytics() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `<h1 class="text-2xl font-bold mb-6">التحليلات</h1><div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="analyticsCards">جاري التحميل...</div>`;
            
            try {
                const { data: orders } = await adminQuery('orders', { select: 'status,wilaya,delivery_type,total,created_at' });
                
                const totalOrders = orders.length;
                const totalRevenue = orders.filter(o => o.status === 'delivered').reduce((s, o) => s + o.total, 0);
                const refusedCount = orders.filter(o => o.status === 'refused').length;
                const returnedCount = orders.filter(o => o.status === 'returned').length;
                
                // Orders by status
                const byStatus = {};
                orders.forEach(o => { byStatus[o.status] = (byStatus[o.status] || 0) + 1; });
                
                // Orders by wilaya
                const byWilaya = {};
                orders.forEach(o => { byWilaya[o.wilaya] = (byWilaya[o.wilaya] || 0) + 1; });
                const topWilayas = Object.entries(byWilaya).sort((a, b) => b[1] - a[1]).slice(0, 5);
                
                // Refusal rate by delivery type
                const homeOrders = orders.filter(o => o.delivery_type === 'home');
                const officeOrders = orders.filter(o => o.delivery_type === 'office');
                const homeRefusalRate = homeOrders.length ? (homeOrders.filter(o => o.status === 'refused').length / homeOrders.length * 100).toFixed(1) : 0;
                const officeRefusalRate = officeOrders.length ? (officeOrders.filter(o => o.status === 'refused').length / officeOrders.length * 100).toFixed(1) : 0;
                
                document.getElementById('analyticsCards').innerHTML = `
                    <div class="bg-white rounded-xl p-6 shadow">
                        <h3 class="text-gray-500 text-sm">إجمالي الطلبات</h3>
                        <p class="text-3xl font-bold">${totalOrders}</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow">
                        <h3 class="text-gray-500 text-sm">الإيرادات (المُسلّمة)</h3>
                        <p class="text-3xl font-bold text-green-600">${formatPrice(totalRevenue)}</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow">
                        <h3 class="text-gray-500 text-sm">المرفوضة / المرتجعة</h3>
                        <p class="text-3xl font-bold text-red-600">${refusedCount} / ${returnedCount}</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow">
                        <h3 class="text-gray-500 text-sm mb-4">الطلبات حسب الحالة</h3>
                        ${Object.entries(byStatus).map(([status, count]) => `
                            <div class="flex justify-between text-sm py-1">
                                <span class="px-2 py-0.5 rounded-full text-xs ${STATUS_CLASSES[status]}">${ORDER_STATUSES[status]}</span>
                                <span>${count}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow">
                        <h3 class="text-gray-500 text-sm mb-4">أعلى 5 ولايات</h3>
                        ${topWilayas.map(([wilaya, count]) => `
                            <div class="flex justify-between text-sm py-1">
                                <span>${wilaya}</span>
                                <span>${count}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow">
                        <h3 class="text-gray-500 text-sm mb-4">نسبة الرفض حسب التوصيل</h3>
                        <div class="flex justify-between text-sm py-1">
                            <span>منزل</span>
                            <span class="text-red-600">${homeRefusalRate}%</span>
                        </div>
                        <div class="flex justify-between text-sm py-1">
                            <span>مكتب</span>
                            <span class="text-red-600">${officeRefusalRate}%</span>
                        </div>
                    </div>
                `;
            } catch (e) {
                document.getElementById('analyticsCards').innerHTML = '<p class="text-red-500">حدث خطأ في تحميل البيانات</p>';
            }
        }

        // ========================================
        // SETTINGS SECTION
        // ========================================
        async function renderSettings() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <h1 class="text-2xl font-bold mb-6">الإعدادات</h1>
                
                <div class="space-y-6">
                    <div class="bg-white rounded-xl p-6 shadow">
                        <h3 class="font-bold mb-4">روابط التواصل الاجتماعي</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">فيسبوك</label>
                                <input type="url" id="setting_facebook" value="${adminState.settings.facebook || ''}"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">انستغرام</label>
                                <input type="url" id="setting_instagram" value="${adminState.settings.instagram || ''}"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">تيك توك</label>
                                <input type="url" id="setting_tiktok" value="${adminState.settings.tiktok || ''}"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">تيليغرام</label>
                                <input type="url" id="setting_telegram" value="${adminState.settings.telegram || ''}"
                                       class="w-full px-3 py-2 border rounded-lg" placeholder="https://t.me/username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">سناب شات</label>
                                <input type="url" id="setting_snapchat" value="${adminState.settings.snapchat || ''}"
                                       class="w-full px-3 py-2 border rounded-lg" placeholder="https://snapchat.com/add/...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">يوتيوب</label>
                                <input type="url" id="setting_youtube" value="${adminState.settings.youtube || ''}"
                                       class="w-full px-3 py-2 border rounded-lg" placeholder="https://youtube.com/@...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">تويتر / X</label>
                                <input type="url" id="setting_twitter" value="${adminState.settings.twitter || ''}"
                                       class="w-full px-3 py-2 border rounded-lg" placeholder="https://x.com/...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">واتساب</label>
                                <input type="text" id="setting_whatsapp" value="${adminState.settings.whatsapp || ''}"
                                       class="w-full px-3 py-2 border rounded-lg" placeholder="0555123456 أو https://wa.me/213...">
                                <p class="text-xs text-gray-500 mt-1">يمكن إدخال رقم الهاتف أو رابط واتساب، وسيتم تحويله تلقائياً عند العرض.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow">
                        <h3 class="font-bold mb-4">إعدادات التتبع</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">حدث الشراء (COD)</label>
                                <select id="setting_purchase_event" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="confirmed" ${adminState.settings.purchase_event === 'confirmed' ? 'selected' : ''}>عند التأكيد</option>
                                    <option value="delivered" ${adminState.settings.purchase_event === 'delivered' ? 'selected' : ''}>عند التوصيل</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">متى يتم إرسال حدث Purchase للميتا</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="setting_consent_banner" 
                                       ${adminState.settings.consent_banner !== 'false' ? 'checked' : ''}>
                                <label for="setting_consent_banner">تفعيل بانر الموافقة على الكوكيز</label>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveSettings()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                        حفظ الإعدادات
                    </button>
                </div>
            `;
        }

        async function saveSettings() {
            const settings = {
                facebook: document.getElementById('setting_facebook').value,
                instagram: document.getElementById('setting_instagram').value,
                tiktok: document.getElementById('setting_tiktok').value,
                telegram: document.getElementById('setting_telegram')?.value || '',
                snapchat: document.getElementById('setting_snapchat')?.value || '',
                youtube: document.getElementById('setting_youtube')?.value || '',
                twitter: document.getElementById('setting_twitter')?.value || '',
                whatsapp: document.getElementById('setting_whatsapp')?.value || '',
                purchase_event: document.getElementById('setting_purchase_event').value,
                consent_banner: document.getElementById('setting_consent_banner').checked ? 'true' : 'false'
            };

            // Basic URL validation (WhatsApp can be phone)
            const urlKeys = ['facebook','instagram','tiktok','telegram','snapchat','youtube','twitter'];
            for (const k of urlKeys) {
                const v = String(settings[k] || '').trim();
                if (!v) continue;
                try { new URL(v); } catch { showToast(`رابط غير صالح: ${k}`, 'error'); return; }
            }
            
            try {
                for (const [key, value] of Object.entries(settings)) {
                    const existing = await adminQuery('settings', { filter: { key: `eq.${key}` } });
                    if (existing.data.length) {
                        await adminUpdate('settings', existing.data[0].id, { value });
                    } else {
                        await adminInsert('settings', { key, value });
                    }
                }
                await logAudit('update_settings', settings);
                showToast('تم حفظ الإعدادات');
                await loadInitialData();
            } catch (e) {
                showToast('حدث خطأ', 'error');
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function formatPrice(price) {
            return new Intl.NumberFormat('ar-DZ').format(price) + ' د.ج';
        }

        function formatDate(date) {
            return new Date(date).toLocaleString('ar-DZ', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getImageUrl(imageId, variant = 'public') {
            if (!imageId) {
                const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">
                    <rect width="120" height="120" fill="#f3f4f6"/>
                    <rect x="10" y="10" width="100" height="100" rx="14" fill="#ffffff"/>
                    <path d="M30 80l15-18 12 14 12-10 21 26H30z" fill="#d1d5db"/>
                    <circle cx="45" cy="45" r="7" fill="#cbd5e1"/>
                    <text x="60" y="105" text-anchor="middle" font-family="Cairo, Arial" font-size="10" fill="#6b7280">لا توجد صورة</text>
                </svg>`;
                return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
            }
            if (imageId.startsWith('http')) return imageId;
            return `https://imagedelivery.net/${CONFIG.CLOUDFLARE_IMAGES_ACCOUNT}/${imageId}/${variant}`;
        }

        function showModal(content) {
            document.getElementById('modalContainer').innerHTML = `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this)closeModal()">
                    <div class="bg-white rounded-xl p-6 max-h-[90vh] overflow-y-auto max-w-2xl w-full">
                        ${content}
                    </div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 left-4 px-4 py-3 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function renderPagination(containerId, totalPages, currentPage, onPageChange) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="(${onPageChange})(${i})" 
                                class="px-3 py-1 rounded ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}">
                    ${i}
                </button>`;
            }
            container.innerHTML = html;
        }

        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        async function logAudit(action, details) {
            try {
                await adminInsert('audit_logs', {
                    user_id: adminState.user?.id,
                    action,
                    details,
                    ip_address: null // Would be captured server-side
                });
            } catch (e) {}
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Show a clear message early if config is missing
            ensureConfigOrShowError();
            checkAuth();
        });
    </script>
</body>
</html>
