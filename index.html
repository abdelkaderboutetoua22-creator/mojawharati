<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="متجرنا - أفضل متجر إلكتروني في الجزائر">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <title>متجرنا - تسوق أونلاين</title>
    
    <!-- Favicon (prevents favicon.ico 404) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3E%3Cdefs%3E%3ClinearGradient%20id='g'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3E%3Cstop%20offset='0%25'%20stop-color='%23667eea'/%3E%3Cstop%20offset='100%25'%20stop-color='%23764ba2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect%20width='64'%20height='64'%20rx='14'%20fill='url(%23g)'/%3E%3Cpath%20d='M18%2024h28l-3%2024H21z'%20fill='white'%20opacity='.95'/%3E%3Cpath%20d='M24%2024a8%208%200%200%201%2016%200'%20fill='none'%20stroke='white'%20stroke-width='4'%20stroke-linecap='round'/%3E%3Ccircle%20cx='26'%20cy='52'%20r='3'%20fill='white'/%3E%3Ccircle%20cx='38'%20cy='52'%20r='3'%20fill='white'/%3E%3C/svg%3E" />
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR4nGP4z8DwHwAFAAH/iZk9WQAAAABJRU5ErkJggg==" />
    
    <!-- Google Analytics -->
    <script id="ga-script"></script>
    <script>
        function initGoogleAnalytics(measurementId) {
            if (!measurementId) return;
            const script = document.getElementById('ga-script');
            script.src = `https://www.googletagmanager.com/gtag/js?id=${measurementId}`;
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            window.gtag = gtag;
            gtag('js', new Date());
            gtag('config', measurementId);
        }
    </script>

    <!-- Facebook Pixel -->
    <script>
        function initFacebookPixel(pixelId) {
            if (!pixelId) return;
            !function(f,b,e,v,n,t,s)
            {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
            n.callMethod.apply(n,arguments):n.queue.push(arguments)};
            if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
            n.queue=[];t=b.createElement(e);t.async=!0;
            t.src=v;s=b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t,s)}(window, document,'script',
            'https://connect.facebook.net/en_US/fbevents.js');
            fbq('init', pixelId);
            fbq('track', 'PageView');
        }
        
        // Facebook Pixel Events
        function fbTrackViewContent(product) {
            if (typeof fbq === 'undefined') return;
            fbq('track', 'ViewContent', {
                content_name: product.name,
                content_ids: [product.id],
                content_type: 'product',
                value: product.price,
                currency: 'DZD'
            });
        }
        
        function fbTrackAddToCart(product, quantity) {
            if (typeof fbq === 'undefined') return;
            fbq('track', 'AddToCart', {
                content_name: product.name,
                content_ids: [product.id],
                content_type: 'product',
                value: product.price * quantity,
                currency: 'DZD'
            });
        }
        
        function fbTrackInitiateCheckout(cart, total) {
            if (typeof fbq === 'undefined') return;
            fbq('track', 'InitiateCheckout', {
                content_ids: cart.map(item => item.id),
                content_type: 'product',
                num_items: cart.reduce((sum, item) => sum + item.quantity, 0),
                value: total,
                currency: 'DZD'
            });
        }
        
        function fbTrackPurchase(order) {
            if (typeof fbq === 'undefined') return;
            fbq('track', 'Purchase', {
                content_ids: order.items.map(item => item.id),
                content_type: 'product',
                num_items: order.items.reduce((sum, item) => sum + item.quantity, 0),
                value: order.total,
                currency: 'DZD'
            });
        }
    </script>

    <!-- TikTok Pixel -->
    <script>
        function initTikTokPixel(pixelId) {
            if (!pixelId) return;
            !function (w, d, t) {
                w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=i,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};var o=document.createElement("script");o.type="text/javascript",o.async=!0,o.src=i+"?sdkid="+e+"&lib="+t;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};
                ttq.load(pixelId);
                ttq.page();
            }(window, document, 'ttq');
        }
        
        // TikTok Pixel Events
        function ttTrackViewContent(product) {
            if (typeof ttq === 'undefined') return;
            ttq.track('ViewContent', {
                content_id: String(product.id),
                content_name: product.name,
                content_type: 'product',
                price: product.price,
                value: product.price,
                currency: 'DZD'
            });
        }
        
        function ttTrackAddToCart(product, quantity) {
            if (typeof ttq === 'undefined') return;
            ttq.track('AddToCart', {
                content_id: String(product.id),
                content_name: product.name,
                content_type: 'product',
                quantity: quantity,
                price: product.price,
                value: product.price * quantity,
                currency: 'DZD'
            });
        }
        
        function ttTrackInitiateCheckout(cart, total) {
            if (typeof ttq === 'undefined') return;
            ttq.track('InitiateCheckout', {
                content_type: 'product',
                quantity: cart.reduce((sum, item) => sum + item.quantity, 0),
                value: total,
                currency: 'DZD'
            });
        }
        
        function ttTrackCompletePayment(order) {
            if (typeof ttq === 'undefined') return;
            ttq.track('CompletePayment', {
                content_type: 'product',
                quantity: order.items.reduce((sum, item) => sum + item.quantity, 0),
                value: order.total,
                currency: 'DZD'
            });
        }
    </script>

    <!-- Google Analytics Events -->
    <script>
        function gaTrackViewItem(product) {
            if (typeof gtag === 'undefined') return;
            gtag('event', 'view_item', {
                currency: 'DZD',
                value: product.price,
                items: [{
                    item_id: product.id,
                    item_name: product.name,
                    price: product.price
                }]
            });
        }
        
        function gaTrackAddToCart(product, quantity) {
            if (typeof gtag === 'undefined') return;
            gtag('event', 'add_to_cart', {
                currency: 'DZD',
                value: product.price * quantity,
                items: [{
                    item_id: product.id,
                    item_name: product.name,
                    price: product.price,
                    quantity: quantity
                }]
            });
        }
        
        function gaTrackBeginCheckout(cart, total) {
            if (typeof gtag === 'undefined') return;
            gtag('event', 'begin_checkout', {
                currency: 'DZD',
                value: total,
                items: cart.map(item => ({
                    item_id: item.id,
                    item_name: item.name,
                    price: item.price,
                    quantity: item.quantity
                }))
            });
        }
        
        function gaTrackPurchase(order) {
            if (typeof gtag === 'undefined') return;
            gtag('event', 'purchase', {
                transaction_id: order.id,
                currency: 'DZD',
                value: order.total,
                shipping: order.deliveryPrice,
                items: order.items.map(item => ({
                    item_id: item.id,
                    item_name: item.name,
                    price: item.price,
                    quantity: item.quantity
                }))
            });
        }
    </script>

    <!-- Conversion APIs (Server-Side) -->
    <script>
        // ===== Helpers (Tracking) =====
        function trackingDebugEnabled() {
            try { return (window.settings && window.settings.debugTracking === true); } catch (_) { return false; }
        }
        function isValidHttpUrl(u) {
            try {
                if (!u) return false;
                const url = new URL(String(u).trim());
                return url.protocol === 'https:' || url.protocol === 'http:';
            } catch (_) {
                return false;
            }
        }

        // Generate unique event ID
        function generateEventId() {
            return 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Get user data for tracking
        function getUserData() {
            const phone = document.getElementById('customerPhone')?.value || '';
            const email = document.getElementById('customerEmail')?.value || '';
            const name = document.getElementById('customerName')?.value || '';
            
            return {
                client_ip_address: '', // Will be filled by server
                client_user_agent: navigator.userAgent,
                em: email ? [email.toLowerCase().trim()] : [],
                ph: phone ? [phone.replace(/\D/g, '')] : [],
                fn: name ? [name.split(' ')[0]?.toLowerCase()] : [],
                ln: name ? [name.split(' ').slice(1).join(' ')?.toLowerCase()] : [],
                country: ['dz'],
                external_id: [localStorage.getItem('visitor_id') || generateVisitorId()]
            };
        }

        // Generate visitor ID
        function generateVisitorId() {
            const id = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('visitor_id', id);
            return id;
        }

        // Facebook Conversion API
        async function fbConversionAPI(eventName, eventData) {
            // نستخدم settings العام (قد يكون محمّلاً من Supabase)
            const s = (window.settings || JSON.parse(localStorage.getItem('storeSettings')) || {});
            if (!s.facebookPixel || !s.facebookAccessToken) return;
            
            const proxyUrl = (s.conversionProxyUrl || '').trim();
            if (!isValidHttpUrl(proxyUrl)) {
                // لا نطبع تحذير مزعج إذا لم يكن Proxy مُعداً.
                return;
            }

            const eventId = generateEventId();
            const payload = {
                platform: 'facebook',
                pixel_id: s.facebookPixel,
                access_token: s.facebookAccessToken,
                test_event_code: s.facebookTestCode || null,
                data: [{
                    event_name: eventName,
                    event_time: Math.floor(Date.now() / 1000),
                    event_id: eventId,
                    event_source_url: window.location.href,
                    action_source: 'website',
                    user_data: getUserData(),
                    custom_data: eventData
                }]
            };

            try {
                await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log('Facebook CAPI:', eventName, 'sent successfully');
            } catch (error) {
                console.error('Facebook CAPI Error:', error);
            }

            return eventId;
        }

        // TikTok Events API
        async function ttConversionAPI(eventName, eventData) {
            // نستخدم settings العام (قد يكون محمّلاً من Supabase)
            const s = (window.settings || JSON.parse(localStorage.getItem('storeSettings')) || {});
            if (!s.tiktokPixel || !s.tiktokAccessToken) return;
            
            const proxyUrl = (s.conversionProxyUrl || '').trim();
            if (!isValidHttpUrl(proxyUrl)) {
                // لا نطبع تحذير مزعج إذا لم يكن Proxy مُعداً.
                return;
            }

            const eventId = generateEventId();
            const userData = getUserData();
            
            const payload = {
                platform: 'tiktok',
                pixel_id: s.tiktokPixel,
                access_token: s.tiktokAccessToken,
                test_event_code: s.tiktokTestCode || null,
                data: [{
                    event: eventName,
                    event_id: eventId,
                    event_time: Math.floor(Date.now() / 1000),
                    user: {
                        external_id: userData.external_id[0],
                        phone: userData.ph[0] || '',
                        email: userData.em[0] || '',
                        ip: '', // Will be filled by server
                        user_agent: userData.client_user_agent
                    },
                    page: {
                        url: window.location.href,
                        referrer: document.referrer
                    },
                    properties: eventData
                }]
            };

            try {
                await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log('TikTok EAPI:', eventName, 'sent successfully');
            } catch (error) {
                console.error('TikTok EAPI Error:', error);
            }

            return eventId;
        }

        // Combined Conversion API calls
        async function sendConversionEvent(eventType, data) {
            const eventMapping = {
                'ViewContent': { fb: 'ViewContent', tt: 'ViewContent' },
                'AddToCart': { fb: 'AddToCart', tt: 'AddToCart' },
                'InitiateCheckout': { fb: 'InitiateCheckout', tt: 'InitiateCheckout' },
                'Purchase': { fb: 'Purchase', tt: 'CompletePayment' }
            };

            const events = eventMapping[eventType];
            if (!events) return;

            // لا نرسل Conversion API إذا لم يكن Proxy URL موجوداً لتجنب تحذيرات Console
            const s = (window.settings || JSON.parse(localStorage.getItem('storeSettings')) || {});
            if (!s.conversionProxyUrl) return;

            // Send to both platforms
            await Promise.all([
                fbConversionAPI(events.fb, data),
                ttConversionAPI(events.tt, data)
            ]);
        }

        // Test Conversion APIs
        async function testConversionAPIs() {
            const statusDiv = document.getElementById('conversionApiStatus');
            statusDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-yellow-100');
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري الاختبار...';
            statusDiv.classList.add('bg-gray-100');

            const proxyUrl = document.getElementById('settingConversionProxyUrl').value.trim();
            const fbPixel = document.getElementById('settingFacebookPixel').value.trim();
            const fbToken = document.getElementById('settingFacebookAccessToken').value.trim();
            const ttPixel = document.getElementById('settingTikTokPixel').value.trim();
            const ttToken = document.getElementById('settingTikTokAccessToken').value.trim();

            let results = [];

            // Check configuration
            if (!proxyUrl) {
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle ml-2"></i>أدخل رابط Proxy Server أولاً';
                statusDiv.classList.remove('bg-gray-100');
                statusDiv.classList.add('bg-yellow-100', 'text-yellow-800');
                return;
            }

            // Test Facebook
            if (fbPixel && fbToken) {
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            platform: 'facebook',
                            pixel_id: fbPixel,
                            access_token: fbToken,
                            test_event_code: document.getElementById('settingFacebookTestCode').value || null,
                            test: true,
                            data: [{
                                event_name: 'PageView',
                                event_time: Math.floor(Date.now() / 1000),
                                event_id: generateEventId(),
                                event_source_url: window.location.href,
                                action_source: 'website',
                                user_data: getUserData()
                            }]
                        })
                    });
                    
                    if (response.ok) {
                        results.push('✅ Facebook CAPI: متصل');
                    } else {
                        results.push('❌ Facebook CAPI: فشل الاتصال');
                    }
                } catch (e) {
                    results.push('❌ Facebook CAPI: ' + e.message);
                }
            } else {
                results.push('⚠️ Facebook CAPI: غير مُعد');
            }

            // Test TikTok
            if (ttPixel && ttToken) {
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            platform: 'tiktok',
                            pixel_id: ttPixel,
                            access_token: ttToken,
                            test_event_code: document.getElementById('settingTikTokTestCode').value || null,
                            test: true,
                            data: [{
                                event: 'PageView',
                                event_id: generateEventId(),
                                event_time: Math.floor(Date.now() / 1000),
                                user: {
                                    external_id: generateVisitorId(),
                                    user_agent: navigator.userAgent
                                },
                                page: {
                                    url: window.location.href
                                }
                            }]
                        })
                    });
                    
                    if (response.ok) {
                        results.push('✅ TikTok EAPI: متصل');
                    } else {
                        results.push('❌ TikTok EAPI: فشل الاتصال');
                    }
                } catch (e) {
                    results.push('❌ TikTok EAPI: ' + e.message);
                }
            } else {
                results.push('⚠️ TikTok EAPI: غير مُعد');
            }

            // Show results
            const hasSuccess = results.some(r => r.includes('✅'));
            const hasError = results.some(r => r.includes('❌'));
            
            statusDiv.classList.remove('bg-gray-100');
            if (hasError) {
                statusDiv.classList.add('bg-red-100', 'text-red-800');
            } else if (hasSuccess) {
                statusDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                statusDiv.classList.add('bg-yellow-100', 'text-yellow-800');
            }
            
            statusDiv.innerHTML = results.join('<br>');
        }
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Font Awesome (non-blocking) -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>

    <script defer src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Supabase (Primary CDN) -->
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase (Fallback CDN) -->
    <script>
        (function ensureSupabaseLoaded() {
            if (window.supabase && typeof window.supabase.createClient === 'function') return;
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
            s.onload = () => console.log('Supabase SDK loaded (fallback).');
            s.onerror = () => console.warn('Failed to load Supabase SDK from fallback CDN.');
            document.head.appendChild(s);
        })();
    </script>
    <!-- Performance: Preconnect -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://bgrnlautilpleguxighw.supabase.co" crossorigin>

    <!-- Google Fonts (non-blocking) -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap"></noscript>

    <style>
        * { font-family: 'Cairo', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 25px 50px rgba(0,0,0,0.15); }
        .product-card { transition: all 0.3s ease; }
        .modal { transition: all 0.3s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .slide-in { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .delivery-option.selected > div { border-color: #667eea; background: linear-gradient(135deg, #f0f4ff 0%, #e8e0ff 100%); }
        .category-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .cart-badge { animation: bounce 0.5s ease; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .thumbnail { transition: all 0.3s ease; }
        .thumbnail:hover, .thumbnail.active { border-color: #667eea; transform: scale(1.05); }
        .zoom-image { transition: transform 0.3s ease; }
        .zoom-image:hover { transform: scale(1.1); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; }
        .notification { animation: slideInRight 0.5s ease; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .feature-icon { transition: all 0.3s ease; }
        .feature-icon:hover { transform: scale(1.1); }
        .admin-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .image-preview { position: relative; }
        .image-preview .remove-btn { position: absolute; top: -8px; right: -8px; }
        .drag-over { border-color: #667eea !important; background-color: #f0f4ff !important; }
        .icon-option.selected { border-color: #667eea; background: linear-gradient(135deg, #f0f4ff 0%, #e8e0ff 100%); }
        .icon-option.selected i { color: #667eea; }

        /* Reviews */
        .star-btn { transition: transform .15s ease; }
        .star-btn:hover { transform: scale(1.08); }
        .star-btn.active i { color: #f59e0b; } /* amber-500 */
        .review-thumb { transition: transform .2s ease; }
        .review-thumb:hover { transform: scale(1.03); }

        /* Variants (chips / blocks) */
        .variant-chip {
            border: 2px solid #e5e7eb;
            background: #fff;
            color: #374151;
            padding: 12px 16px;
            border-radius: 14px;
            font-weight: 800;
            font-size: 1rem;
            line-height: 1;
            transition: all .15s ease;
            user-select: none;
            min-width: 88px;
            text-align: center;
        }
        .variant-chip:hover { border-color: #a78bfa; transform: translateY(-1px); }
        .variant-chip.selected {
            border-color: #667eea;
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 12px 24px rgba(102, 126, 234, .22);
        }
        .variant-chip:disabled { opacity: .5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 left-4 z-50 space-y-2"></div>

    <!-- Header -->
    <header class="gradient-bg sticky top-0 z-40 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3 cursor-pointer" onclick="showPage('home')">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-store text-2xl text-purple-600"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">متجرنا</h1>
                        <p class="text-purple-200 text-xs">تسوق بثقة</p>
                    </div>
                </div>

                <div class="hidden md:flex flex-1 max-w-md mx-8">
                    <div class="relative w-full">
                        <input type="text" id="searchInput" placeholder="ابحث عن منتج..." 
                            class="w-full px-4 py-2 pr-10 rounded-xl border-0 focus:ring-2 focus:ring-purple-300">
                        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <button onclick="showPage('track')" class="text-white text-xl hover:scale-110 transition-transform" title="تتبع الطلب">
                        <i class="fas fa-truck"></i>
                    </button>
                    <button onclick="openCart()" class="relative text-white text-xl hover:scale-110 transition-transform">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cartCount" class="cart-badge absolute -top-2 -left-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                    </button>
                    <button onclick="showAdminLogin()" class="text-white text-xl hover:scale-110 transition-transform" title="لوحة التحكم">
                        <i class="fas fa-user-shield"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="mainContent">
        <!-- Home Page -->
        <div id="homePage">
            <!-- Hero Section -->
            <section class="gradient-bg py-12 md:py-20">
                <div class="max-w-7xl mx-auto px-4 text-center">
                    <h2 class="text-3xl md:text-5xl font-bold text-white mb-4">مرحباً بكم في متجرنا</h2>
                    <p class="text-purple-200 text-lg md:text-xl mb-8">أفضل المنتجات بأفضل الأسعار - الدفع عند الاستلام</p>
                    <div class="flex flex-wrap justify-center gap-4">
                        <div class="bg-white/20 backdrop-blur rounded-xl px-6 py-3 text-white">
                            <i class="fas fa-truck ml-2"></i>توصيل لكل الولايات
                        </div>
                        <div class="bg-white/20 backdrop-blur rounded-xl px-6 py-3 text-white">
                            <i class="fas fa-money-bill-wave ml-2"></i>الدفع عند الاستلام
                        </div>
                        <div class="bg-white/20 backdrop-blur rounded-xl px-6 py-3 text-white">
                            <i class="fas fa-shield-alt ml-2"></i>ضمان الجودة
                        </div>
                    </div>
                </div>
            </section>

            <!-- Categories -->
            <section class="py-6 bg-white shadow-sm sticky top-[72px] z-30">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="flex gap-3 overflow-x-auto pb-2">
                        <button class="category-btn active flex-shrink-0 px-5 py-2 rounded-full border-2 border-purple-500 font-semibold transition-all" data-category="all">
                            <i class="fas fa-th-large ml-2"></i>الكل
                        </button>
                        <button class="category-btn flex-shrink-0 px-5 py-2 rounded-full border-2 border-gray-200 font-semibold transition-all hover:border-purple-500" data-category="electronics">
                            <i class="fas fa-mobile-alt ml-2"></i>إلكترونيات
                        </button>
                        <button class="category-btn flex-shrink-0 px-5 py-2 rounded-full border-2 border-gray-200 font-semibold transition-all hover:border-purple-500" data-category="fashion">
                            <i class="fas fa-tshirt ml-2"></i>ملابس
                        </button>
                        <button class="category-btn flex-shrink-0 px-5 py-2 rounded-full border-2 border-gray-200 font-semibold transition-all hover:border-purple-500" data-category="beauty">
                            <i class="fas fa-spa ml-2"></i>جمال
                        </button>
                        <button class="category-btn flex-shrink-0 px-5 py-2 rounded-full border-2 border-gray-200 font-semibold transition-all hover:border-purple-500" data-category="home">
                            <i class="fas fa-home ml-2"></i>المنزل
                        </button>
                    </div>
                </div>
            </section>

            <!-- Products Grid -->
            <section class="py-8">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-fire text-orange-500 ml-2"></i>منتجاتنا
                        </h3>
                        <span id="productCount" class="text-gray-500 text-sm"></span>
                    </div>
                    <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"></div>
                </div>
            </section>

            <!-- Features -->
            <section class="py-12 bg-white">
                <div class="max-w-7xl mx-auto px-4">
                    <h3 class="text-2xl font-bold text-center text-gray-800 mb-10">لماذا تختارنا؟</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="text-center feature-icon">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-shipping-fast text-2xl text-purple-600"></i>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-2">توصيل سريع</h4>
                            <p class="text-gray-500 text-sm">لجميع الولايات</p>
                        </div>
                        <div class="text-center feature-icon">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-hand-holding-usd text-2xl text-green-600"></i>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-2">الدفع عند الاستلام</h4>
                            <p class="text-gray-500 text-sm">بدون مخاطر</p>
                        </div>
                        <div class="text-center feature-icon">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-undo text-2xl text-blue-600"></i>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-2">استرجاع مجاني</h4>
                            <p class="text-gray-500 text-sm">خلال 7 أيام</p>
                        </div>
                        <div class="text-center feature-icon">
                            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-headset text-2xl text-orange-600"></i>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-2">دعم متواصل</h4>
                            <p class="text-gray-500 text-sm">24/7</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Product Detail Page -->
        <div id="productPage" class="hidden py-8">
            <div class="max-w-7xl mx-auto px-4">
                <nav class="mb-6">
                    <ol class="flex items-center gap-2 text-sm text-gray-500">
                        <li><a href="#" onclick="showPage('home')" class="hover:text-purple-600">الرئيسية</a></li>
                        <li><i class="fas fa-chevron-left text-xs"></i></li>
                        <li id="productCategory" class="hover:text-purple-600 cursor-pointer">التصنيف</li>
                        <li><i class="fas fa-chevron-left text-xs"></i></li>
                        <li id="productBreadcrumb" class="text-purple-600 font-semibold">اسم المنتج</li>
                    </ol>
                </nav>

                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="grid md:grid-cols-2 gap-8 p-6">
                        <div class="space-y-4">
                            <div class="relative overflow-hidden rounded-2xl bg-gray-100">
                                <img id="mainProductImage" src="" alt="صورة المنتج" 
                                    class="w-full h-80 md:h-96 object-cover zoom-image cursor-zoom-in">
                                <div id="productBadge" class="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold"></div>
                                <div id="discountBadge" class="absolute top-4 left-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold"></div>
                            </div>
                            <div id="thumbnailContainer" class="flex gap-3 overflow-x-auto pb-2"></div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <h1 id="productTitle" class="text-2xl md:text-3xl font-bold text-gray-800 mb-2"></h1>
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="flex text-yellow-400">
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star-half-alt"></i>
                                    </div>
                                    <span id="productRatingText" class="text-gray-500 text-sm">جاري تحميل التقييمات...</span>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4">
                                <div class="flex items-center gap-4">
                                    <span id="productPrice" class="text-3xl font-bold text-green-600"></span>
                                    <span id="productOldPrice" class="text-xl text-gray-400 line-through"></span>
                                    <span id="productDiscount" class="bg-red-500 text-white text-sm px-2 py-1 rounded-full"></span>
                                </div>
                                <p class="text-green-600 text-sm mt-2"><i class="fas fa-check-circle ml-1"></i>متوفر في المخزون</p>
                            </div>

                            <div id="productDescription" class="text-gray-600 leading-relaxed"></div>

                            <!-- Variants / Options (colors, sizes, etc.) -->
                            <div id="variantSelectors" class="hidden bg-white border-2 border-purple-100 rounded-2xl p-5 space-y-4 shadow-sm">
                                <div class="flex items-center gap-3 text-gray-800 font-extrabold">
                                    <div class="w-9 h-9 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-sliders-h text-purple-600"></i>
                                    </div>
                                    <div>
                                        <div class="text-base">اختر الخيارات</div>
                                        <div class="text-xs text-gray-500 font-semibold">اختر اللون/المقاس ثم أكمل الطلب</div>
                                    </div>
                                </div>
                                <div id="variantSelectorsFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                                <div id="variantSelectedBadge" class="hidden text-sm text-gray-600 bg-gray-50 border border-gray-200 rounded-xl p-3"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-3">
                                    <i class="fas fa-truck text-purple-600"></i>
                                    <span class="text-sm">توصيل سريع</span>
                                </div>
                                <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-3">
                                    <i class="fas fa-shield-alt text-green-600"></i>
                                    <span class="text-sm">ضمان الجودة</span>
                                </div>
                                <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-3">
                                    <i class="fas fa-undo text-blue-600"></i>
                                    <span class="text-sm">استرجاع مجاني</span>
                                </div>
                                <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-3">
                                    <i class="fas fa-money-bill-wave text-orange-600"></i>
                                    <span class="text-sm">الدفع عند الاستلام</span>
                                </div>
                            </div>

                            <div class="flex items-center gap-4">
                                <span class="font-semibold text-gray-700">الكمية:</span>
                                <div class="flex items-center border-2 border-gray-200 rounded-xl overflow-hidden">
                                    <button onclick="changeProductQty(-1)" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 transition-colors text-lg font-bold">-</button>
                                    <span id="productQty" class="px-6 py-2 font-bold text-lg">1</span>
                                    <button onclick="changeProductQty(1)" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 transition-colors text-lg font-bold">+</button>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button id="buyNowBtn" onclick="buyNowFromProduct()" 
                                    class="flex-1 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold text-lg rounded-xl hover:from-green-600 hover:to-green-700 transition-all shadow-lg flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed">
                                    <i class="fas fa-bolt"></i>
                                    اشتري الآن
                                </button>
                                <button id="addToCartBtn" onclick="addToCartFromProduct()" 
                                    class="flex-1 py-4 gradient-btn text-white font-bold text-lg rounded-xl transition-all shadow-lg flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed">
                                    <i class="fas fa-cart-plus"></i>
                                    أضف للسلة
                                </button>
                            </div>

                            <div class="flex items-center gap-4 pt-4 border-t">
                                <span class="text-gray-600">مشاركة:</span>
                                <button onclick="shareProduct('facebook')" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700">
                                    <i class="fab fa-facebook-f"></i>
                                </button>
                                <button onclick="shareProduct('whatsapp')" class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                                <button onclick="shareProduct('twitter')" class="w-10 h-10 bg-sky-500 text-white rounded-full flex items-center justify-center hover:bg-sky-600">
                                    <i class="fab fa-twitter"></i>
                                </button>
                                <button onclick="copyProductLink()" class="w-10 h-10 bg-gray-500 text-white rounded-full flex items-center justify-center hover:bg-gray-600">
                                    <i class="fas fa-link"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="border-t">
                        <div class="flex border-b">
                            <button onclick="showTab('description', event)" class="tab-btn active px-6 py-4 font-semibold text-purple-600 border-b-2 border-purple-600">الوصف</button>
                            <button onclick="showTab('specs', event)" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-purple-600">المواصفات</button>
                            <button onclick="showTab('reviews', event)" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-purple-600">التقييمات</button>
                        </div>
                        <div id="tabContent" class="p-6"></div>
                    </div>
                </div>

                <div class="mt-12">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-heart text-red-500 ml-2"></i>منتجات مشابهة
                    </h3>
                    <div id="relatedProducts" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Track Order Page -->
        <div id="trackPage" class="hidden py-12">
            <div class="max-w-xl mx-auto px-4">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-center mb-6">
                        <i class="fas fa-truck text-purple-600 ml-2"></i>تتبع طلبك
                    </h2>
                    <div class="space-y-4">
                        <input type="text" id="trackOrderId" placeholder="أدخل رقم الطلب" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                        <input type="tel" id="trackPhone" placeholder="أدخل رقم الهاتف" dir="ltr"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                        <button onclick="trackOrder()" class="w-full py-3 gradient-btn text-white font-bold rounded-xl">
                            <i class="fas fa-search ml-2"></i>تتبع الطلب
                        </button>
                    </div>
                    <div id="trackResult" class="mt-6 hidden"></div>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="hidden py-8">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-tachometer-alt text-purple-600 ml-2"></i>لوحة التحكم
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="openSettings()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                            <i class="fas fa-cog ml-2"></i>الإعدادات
                        </button>
                        <button onclick="logoutAdmin()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            <i class="fas fa-sign-out-alt ml-2"></i>خروج
                        </button>
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div class="flex gap-2 mb-6 overflow-x-auto">
                    <button onclick="showAdminTab('orders', event)" class="admin-tab active px-6 py-3 rounded-xl font-semibold transition-all">
                        <i class="fas fa-shopping-bag ml-2"></i>الطلبات
                    </button>
                    <button onclick="showAdminTab('abandoned', event)" class="admin-tab px-6 py-3 rounded-xl font-semibold bg-white shadow transition-all">
                        <i class="fas fa-cart-arrow-down ml-2"></i>السلات المتروكة
                    </button>
                    <button onclick="showAdminTab('products', event)" class="admin-tab px-6 py-3 rounded-xl font-semibold bg-white shadow transition-all">
                        <i class="fas fa-box ml-2"></i>المنتجات
                    </button>
                    <button onclick="showAdminTab('categories', event)" class="admin-tab px-6 py-3 rounded-xl font-semibold bg-white shadow transition-all">
                        <i class="fas fa-tags ml-2"></i>التصنيفات
                    </button>
                </div>

                <!-- Orders Tab -->
                <div id="ordersTab">
                    <!-- Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">إجمالي الطلبات</p>
                                    <p id="statTotal" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-shopping-bag text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">قيد الانتظار</p>
                                    <p id="statPending" class="text-2xl font-bold text-yellow-600">0</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-clock text-yellow-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">تم التوصيل</p>
                                    <p id="statDelivered" class="text-2xl font-bold text-green-600">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">إجمالي المبيعات</p>
                                    <p id="statRevenue" class="text-2xl font-bold text-blue-600">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-coins text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Filter -->
                    <div class="bg-white rounded-xl p-4 shadow-md mb-6">
                        <div class="flex flex-wrap gap-4 items-center">
                            <select id="filterStatus" class="px-4 py-2 border rounded-lg" onchange="filterOrders()">
                                <option value="all">جميع الحالات</option>
                                <option value="pending">قيد الانتظار</option>
                                <option value="confirmed">مؤكد</option>
                                <option value="shipped">تم الشحن</option>
                                <option value="delivered">تم التوصيل</option>
                                <option value="cancelled">ملغي</option>
                            </select>
                            <input type="date" id="filterDate" class="px-4 py-2 border rounded-lg" onchange="filterOrders()">
                            <button onclick="exportOrders()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                <i class="fas fa-file-excel ml-2"></i>تصدير Excel
                            </button>
                        </div>
                    </div>

                    <!-- Orders Table -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">رقم الطلب</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">العميل</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">المنتج</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">المجموع</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">الحالة</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">التاريخ</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Abandoned Carts Tab -->
                <div id="abandonedTab" class="hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-cart-arrow-down text-purple-600 ml-2"></i>السلات المتروكة
                        </h3>
                        <button onclick="refreshAbandonedCarts()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                            <i class="fas fa-rotate ml-2"></i>تحديث
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">العميل</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">الهاتف</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">الولاية</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">السلة</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">آخر تحديث</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="abandonedTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">* تظهر السلات المتروكة عندما يكتب الزبون معلوماته في نموذج الطلب دون الضغط على "تأكيد الطلب".</p>
                </div>

                <!-- Categories Tab -->
                <div id="categoriesTab" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-tags text-purple-600 ml-2"></i>إدارة التصنيفات
                        </h3>
                        <button onclick="openCategoryModal()" class="px-6 py-3 gradient-btn text-white rounded-xl font-semibold">
                            <i class="fas fa-plus ml-2"></i>إضافة تصنيف جديد
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categoriesGrid">
                            <!-- Categories will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Products Tab -->
                <div id="productsTab" class="hidden">
                    <!-- Add Product Button -->
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-box text-purple-600 ml-2"></i>إدارة المنتجات
                        </h3>
                        <button onclick="openProductModal()" class="px-6 py-3 gradient-btn text-white rounded-xl font-semibold">
                            <i class="fas fa-plus ml-2"></i>إضافة منتج جديد
                        </button>
                    </div>

                    <!-- Products Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <p class="text-gray-500 text-sm">إجمالي المنتجات</p>
                            <p id="statProducts" class="text-2xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <p class="text-gray-500 text-sm">إلكترونيات</p>
                            <p id="statElectronics" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <p class="text-gray-500 text-sm">ملابس</p>
                            <p id="statFashion" class="text-2xl font-bold text-pink-600">0</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <p class="text-gray-500 text-sm">أخرى</p>
                            <p id="statOther" class="text-2xl font-bold text-gray-600">0</p>
                        </div>
                    </div>

                    <!-- Products Grid -->
                    <div id="adminProductsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="gradient-bg py-10 mt-12">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8 text-white mb-8">
                <div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                            <i class="fas fa-store text-xl text-purple-600"></i>
                        </div>
                        <span class="text-xl font-bold">متجرنا</span>
                    </div>
                    <p class="text-purple-200">أفضل متجر إلكتروني في الجزائر</p>
                </div>
                <div>
                    <h4 class="font-bold text-lg mb-4">تواصل معنا</h4>
                    <div class="space-y-2 text-purple-200">
                        <p><i class="fas fa-phone ml-2"></i><span id="footerPhone">0555 12 34 56</span></p>
                        <p><i class="fas fa-envelope ml-2"></i><span id="footerEmail">contact@store.dz</span></p>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-lg mb-4">تابعنا</h4>
                    <div id="footerSocialLinks" class="flex flex-wrap gap-3">
                        <!-- Social links will be rendered dynamically -->
                    </div>
                </div>
            </div>
            <div class="border-t border-white/20 pt-6 text-center text-purple-200">
                <p>© 2024 متجرنا - جميع الحقوق محفوظة</p>
            </div>
        </div>
    </footer>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-hidden slide-in">
            <div class="gradient-bg p-4 flex items-center justify-between">
                <h3 class="text-white font-bold text-lg"><i class="fas fa-shopping-cart ml-2"></i>سلة التسوق</h3>
                <button onclick="closeCart()" class="text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="cartItems" class="p-4 max-h-[50vh] overflow-y-auto"></div>
            <div id="cartFooter" class="p-4 border-t bg-gray-50"></div>
        </div>
    </div>

    <!-- COD Order Modal -->
    <div id="orderModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
        <div class="bg-gray-100 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto slide-in">
            <div class="gradient-bg p-4 rounded-t-2xl flex items-center justify-between sticky top-0 z-10">
                <h3 class="text-white font-bold text-lg"><i class="fas fa-shopping-bag ml-2"></i>إتمام الطلب</h3>
                <button onclick="closeOrderModal()" class="text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-4">
                <div class="bg-white rounded-xl overflow-hidden shadow-md">
                    <div id="orderProductSection" class="p-4 border-b"></div>

                    <form id="orderForm" class="p-4 space-y-4">
                        <div class="space-y-3">
                            <div class="flex items-center gap-2 text-gray-700 font-semibold">
                                <div class="w-7 h-7 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-purple-600 text-xs"></i>
                                </div>
                                <span>معلومات العميل</span>
                            </div>
                            <input type="text" id="customerName" placeholder="الاسم الكامل *" required
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <input type="tel" id="customerPhone" placeholder="رقم الهاتف *" required dir="ltr"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left"
                                pattern="[0-9]{10}" maxlength="10">
                            <input type="email" id="customerEmail" placeholder="البريد الإلكتروني (اختياري)" dir="ltr"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                        </div>

                        <div class="space-y-3">
                            <div class="flex items-center gap-2 text-gray-700 font-semibold">
                                <div class="w-7 h-7 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-map-marker-alt text-green-600 text-xs"></i>
                                </div>
                                <span>عنوان التوصيل</span>
                            </div>
                            <select id="province" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none bg-white">
                                <option value="">-- اختر الولاية --</option>
                            </select>
                            <input type="text" id="municipality" placeholder="أدخل اسم البلدية *" required
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <input type="text" id="address" placeholder="العنوان بالتفصيل (اختياري)"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">

                            <div class="grid grid-cols-2 gap-3">
                                <label class="delivery-option cursor-pointer">
                                    <input type="radio" name="deliveryType" value="office" class="hidden" required>
                                    <div class="border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition-all">
                                        <i class="fas fa-building text-orange-500 text-xl mb-1"></i>
                                        <div class="font-semibold text-gray-700 text-sm">مكتب</div>
                                        <div class="text-purple-600 font-bold" id="officePrice">-- دج</div>
                                    </div>
                                </label>
                                <label class="delivery-option cursor-pointer">
                                    <input type="radio" name="deliveryType" value="home" class="hidden">
                                    <div class="border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition-all">
                                        <i class="fas fa-home text-green-500 text-xl mb-1"></i>
                                        <div class="font-semibold text-gray-700 text-sm">المنزل</div>
                                        <div class="text-purple-600 font-bold" id="homePrice">-- دج</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-100">
                            <div id="orderSummaryItems" class="space-y-2 text-sm"></div>
                            <div class="border-t border-purple-200 pt-2 mt-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-gray-800">المجموع:</span>
                                    <span class="text-xl font-bold text-purple-600" id="orderTotal">0 دج</span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="submitOrderBtn"
                            class="w-full py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold text-lg rounded-xl hover:from-green-600 hover:to-green-700 transition-all shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            تأكيد الطلب
                        </button>

                        <div class="flex items-center justify-center gap-4 pt-2 text-xs text-gray-500">
                            <span><i class="fas fa-lock text-green-500 ml-1"></i>آمن</span>
                            <span><i class="fas fa-undo text-blue-500 ml-1"></i>استرجاع</span>
                            <span><i class="fas fa-headset text-purple-500 ml-1"></i>دعم</span>
                        </div>
                    </form>

                    <div id="orderSuccess" class="hidden p-8 text-center">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-green-500 text-4xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">تم تأكيد طلبك بنجاح! 🎉</h3>
                        <p class="text-gray-600 mb-2">رقم الطلب: <span id="orderNumber" class="font-bold text-purple-600"></span></p>
                        <p class="text-gray-500 text-sm mb-4">سيتم التواصل معك قريباً</p>
                        <div id="orderConfirmationDetails" class="bg-gray-50 rounded-xl p-4 text-right text-sm mb-4"></div>
                        <button onclick="closeOrderModal()" class="px-6 py-2 gradient-btn text-white rounded-xl">
                            متابعة التسوق
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 slide-in">
            <h3 class="text-xl font-bold text-center mb-6"><i class="fas fa-user-shield text-purple-600 ml-2"></i>دخول لوحة التحكم</h3>
            <form id="adminLoginForm" class="space-y-4">
                <input type="email" id="adminEmail" placeholder="البريد الإلكتروني" required dir="ltr"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                <input type="password" id="adminPassword" placeholder="كلمة المرور" required dir="ltr"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                <button type="submit" class="w-full py-3 gradient-btn text-white font-bold rounded-xl">
                    دخول
                </button>
            </form>
            <p class="text-xs text-gray-500 mt-3 leading-relaxed">
                هذا الدخول يستخدم <span class="font-semibold">Supabase Auth</span>. تأكد أنك أنشأت حساب Admin في Supabase.
            </p>
            <button onclick="closeAdminLogin()" class="w-full mt-4 py-2 text-gray-500 hover:text-gray-700">إلغاء</button>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto slide-in">
            <div class="gradient-bg p-4 flex items-center justify-between sticky top-0">
                <h3 class="text-white font-bold text-lg"><i class="fas fa-info-circle ml-2"></i>تفاصيل الطلب</h3>
                <button onclick="closeOrderDetails()" class="text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="orderDetailsContent" class="p-4"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto slide-in">
            <div class="gradient-bg p-4 flex items-center justify-between sticky top-0">
                <h3 class="text-white font-bold text-lg"><i class="fas fa-cog ml-2"></i>إعدادات المتجر</h3>
                <button onclick="closeSettings()" class="text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 space-y-6">
                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fas fa-store ml-2 text-purple-600"></i>معلومات المتجر</h4>
                    <input type="text" id="settingStoreName" placeholder="اسم المتجر" 
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                    <input type="tel" id="settingPhone" placeholder="رقم الهاتف" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <input type="email" id="settingEmail" placeholder="البريد الإلكتروني" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <input type="text" id="settingWhatsapp" placeholder="رقم واتساب (مع رمز الدولة)" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fas fa-envelope ml-2 text-purple-600"></i>إشعارات البريد (EmailJS)</h4>
                    <input type="text" id="settingEmailJsKey" placeholder="EmailJS Public Key" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <input type="text" id="settingEmailJsService" placeholder="EmailJS Service ID" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <input type="text" id="settingEmailJsTemplate" placeholder="EmailJS Template ID" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fas fa-table ml-2 text-green-600"></i>Google Sheets</h4>
                    <input type="text" id="settingSheetUrl" placeholder="رابط Google Apps Script Web App" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fas fa-database ml-2 text-orange-500"></i>Supabase Database</h4>
                    <p class="text-xs text-gray-500 mb-2">يتم حفظ البيانات (المنتجات، التصنيفات، الطلبات) في Supabase تلقائياً لجميع الزوار.</p>
                    <p class="text-xs text-purple-700 bg-purple-50 border border-purple-100 rounded-lg p-3">
                        ✅ تم تفعيل <b>مزامنة إعدادات المتجر</b> أيضاً عبر Supabase، لذلك أي تغيير (الهاتف، روابط السوشيال، البيكسلات...) سيظهر تلقائياً على أي جهاز بعد الحفظ.
                    </p>

                    <button type="button" onclick="manualSyncStoreSettings()" class="w-full py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600">
                        <i class="fas fa-rotate ml-2"></i>مزامنة الإعدادات من Supabase الآن
                    </button>

                    <details class="bg-gray-50 border border-gray-200 rounded-xl p-3">
                        <summary class="cursor-pointer font-semibold text-gray-700">إعداد جداول مزامنة الإعدادات (مرة واحدة)</summary>
                        <p class="text-xs text-gray-500 mt-2 leading-relaxed">
                            إذا ظهرت رسالة <b>تعذر مزامنة الإعدادات</b> فهذا يعني غالباً أن جداول الإعدادات غير موجودة أو أن RLS يمنع الوصول.
                            انسخ SQL التالي ثم اذهب إلى <b>Supabase → SQL Editor</b> واضغط <b>Run</b>.
                        </p>
                        <textarea id="storeSettingsSql" class="w-full mt-2 p-2 text-xs font-mono border rounded-lg h-44" dir="ltr" readonly></textarea>
                        <button type="button" onclick="copyStoreSettingsSql()" class="mt-2 w-full py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900">
                            <i class="fas fa-copy ml-2"></i>نسخ SQL
                        </button>
                    </details>

                    <details class="bg-gray-50 border border-gray-200 rounded-xl p-3">
                        <summary class="cursor-pointer font-semibold text-gray-700">إعداد جدول التقييمات Reviews (مرة واحدة)</summary>
                        <p class="text-xs text-gray-500 mt-2 leading-relaxed">
                            هذه الميزة تضيف تقييمات حقيقية للمنتجات (اسم + نجوم + تعليق + صورة اختيارية). انسخ SQL التالي ثم اذهب إلى <b>Supabase → SQL Editor</b> واضغط <b>Run</b>.
                        </p>
                        <textarea id="reviewsSql" class="w-full mt-2 p-2 text-xs font-mono border rounded-lg h-44" dir="ltr" readonly></textarea>
                        <button type="button" onclick="copyReviewsSql()" class="mt-2 w-full py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900">
                            <i class="fas fa-copy ml-2"></i>نسخ SQL
                        </button>
                    </details>

                    <details class="bg-gray-50 border border-gray-200 rounded-xl p-3">
                        <summary class="cursor-pointer font-semibold text-gray-700">إعداد جدول السلات المتروكة Abandoned Carts (مرة واحدة)</summary>
                        <p class="text-xs text-gray-500 mt-2 leading-relaxed">
                            هذه الميزة تحفظ سلة الزبون أثناء تعبئة نموذج الطلب قبل الضغط على "تأكيد الطلب". انسخ SQL التالي ثم اذهب إلى <b>Supabase → SQL Editor</b> واضغط <b>Run</b>.
                        </p>
                        <textarea id="abandonedSql" class="w-full mt-2 p-2 text-xs font-mono border rounded-lg h-44" dir="ltr" readonly></textarea>
                        <button type="button" onclick="copyAbandonedSql()" class="mt-2 w-full py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900">
                            <i class="fas fa-copy ml-2"></i>نسخ SQL
                        </button>
                    </details>

                    <!-- حقول Firebase القديمة (لم تعد مستخدمة) - نخفيها لتجنب اللبس -->
                    <div class="hidden">
                        <input type="text" id="settingFirebaseApiKey" placeholder="Firebase API Key" dir="ltr"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                        <input type="text" id="settingFirebaseProjectId" placeholder="Firebase Project ID" dir="ltr"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                        <input type="text" id="settingFirebaseAuthDomain" placeholder="Firebase Auth Domain (اختياري)" dir="ltr"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                        <input type="text" id="settingFirebaseStorageBucket" placeholder="Firebase Storage Bucket (اختياري)" dir="ltr"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    </div>

                    <div class="flex gap-2">
                        <button type="button" onclick="testFirebaseConnection()" class="flex-1 py-2 bg-orange-500 text-white rounded-xl hover:bg-orange-600">
                            <i class="fas fa-plug ml-2"></i>اختبار الاتصال بـ Supabase
                        </button>
                        <button type="button" onclick="uploadLocalDataToFirebase()" class="flex-1 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600">
                            <i class="fas fa-cloud-upload-alt ml-2"></i>رفع البيانات الافتراضية
                        </button>
                    </div>
                    <div id="firebaseStatus" class="hidden p-3 rounded-xl text-sm"></div>
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fab fa-facebook ml-2 text-blue-600"></i>Facebook Pixel & Conversion API</h4>
                    <input type="text" id="settingFacebookPixel" placeholder="Facebook Pixel ID (مثال: 123456789012345)" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <input type="text" id="settingFacebookAccessToken" placeholder="Facebook Conversion API Access Token" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <input type="text" id="settingFacebookTestCode" placeholder="Test Event Code (اختياري - للاختبار)" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <div class="bg-blue-50 rounded-lg p-3 text-sm">
                        <p class="font-semibold text-blue-800 mb-2"><i class="fas fa-info-circle ml-1"></i>كيفية الحصول على Access Token:</p>
                        <ol class="text-blue-700 space-y-1 list-decimal mr-4">
                            <li>اذهب إلى Facebook Events Manager</li>
                            <li>اختر الـ Pixel الخاص بك</li>
                            <li>Settings → Conversions API</li>
                            <li>Generate Access Token</li>
                        </ol>
                    </div>
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fab fa-tiktok ml-2 text-gray-800"></i>TikTok Pixel & Events API</h4>
                    <input type="text" id="settingTikTokPixel" placeholder="TikTok Pixel ID (مثال: XXXXXXXXXX)" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <input type="text" id="settingTikTokAccessToken" placeholder="TikTok Events API Access Token" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <input type="text" id="settingTikTokTestCode" placeholder="Test Event Code (اختياري - للاختبار)" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <div class="bg-gray-100 rounded-lg p-3 text-sm">
                        <p class="font-semibold text-gray-800 mb-2"><i class="fas fa-info-circle ml-1"></i>كيفية الحصول على Access Token:</p>
                        <ol class="text-gray-700 space-y-1 list-decimal mr-4">
                            <li>اذهب إلى TikTok Ads Manager</li>
                            <li>Assets → Events → Web Events</li>
                            <li>اختر الـ Pixel → Settings</li>
                            <li>Generate Access Token</li>
                        </ol>
                    </div>
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fas fa-server ml-2 text-purple-600"></i>Conversion API Proxy (مطلوب)</h4>
                    <input type="text" id="settingConversionProxyUrl" placeholder="رابط Proxy Server (Netlify/Vercel Function)" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <div class="bg-yellow-50 rounded-lg p-3 text-sm">
                        <p class="font-semibold text-yellow-800 mb-2"><i class="fas fa-exclamation-triangle ml-1"></i>مهم جداً:</p>
                        <p class="text-yellow-700">Conversion APIs تحتاج خادم وسيط لحماية Access Token. يمكنك استخدام Netlify Functions أو Vercel Functions.</p>
                    </div>
                    <button type="button" onclick="testConversionAPIs()" class="w-full py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600">
                        <i class="fas fa-vial ml-2"></i>اختبار Conversion APIs
                    </button>
                    <div id="conversionApiStatus" class="hidden p-3 rounded-xl text-sm"></div>
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fab fa-google ml-2 text-red-500"></i>Google Analytics</h4>
                    <input type="text" id="settingGoogleAnalytics" placeholder="Google Analytics ID (مثال: G-XXXXXXXXXX)" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <p class="text-xs text-gray-500">يمكنك الحصول عليه من Google Analytics</p>
                </div>

                <!-- Tracking toggles (Client-side scripts) -->
                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fas fa-chart-line ml-2 text-purple-600"></i>إعدادات التتبع (متصفح)</h4>
                    <label class="flex items-start gap-3 bg-gray-50 border border-gray-200 rounded-xl p-3 cursor-pointer">
                        <input type="checkbox" id="settingEnableFacebookPixel" class="mt-1">
                        <div class="text-sm">
                            <div class="font-semibold text-gray-800">تفعيل Facebook Pixel (Browser)</div>
                            <div class="text-xs text-gray-500">إذا كان لديك AdBlock قد يتم حظر السكربت. Conversion API سيستمر بالعمل عبر Proxy.</div>
                        </div>
                    </label>
                    <label class="flex items-start gap-3 bg-gray-50 border border-gray-200 rounded-xl p-3 cursor-pointer">
                        <input type="checkbox" id="settingEnableTikTokPixel" class="mt-1">
                        <div class="text-sm">
                            <div class="font-semibold text-gray-800">تفعيل TikTok Pixel (Browser)</div>
                            <div class="text-xs text-gray-500">إذا ظهر في Console خطأ ERR_BLOCKED_BY_CLIENT فهذا بسبب مانع إعلانات. يمكنك تعطيله من هنا لتجنب الرسالة.</div>
                        </div>
                    </label>
                    <label class="flex items-start gap-3 bg-gray-50 border border-gray-200 rounded-xl p-3 cursor-pointer">
                        <input type="checkbox" id="settingEnableGoogleAnalytics" class="mt-1">
                        <div class="text-sm">
                            <div class="font-semibold text-gray-800">تفعيل Google Analytics (Browser)</div>
                            <div class="text-xs text-gray-500">سيتم تحميل GA بشكل مؤجل لتحسين السرعة.</div>
                        </div>
                    </label>
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fas fa-share-alt ml-2 text-purple-600"></i>روابط التواصل الاجتماعي</h4>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fab fa-facebook-f text-white"></i>
                            </div>
                            <input type="url" id="settingFacebook" placeholder="رابط صفحة Facebook" dir="ltr"
                                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 rounded-lg flex items-center justify-center">
                                <i class="fab fa-instagram text-white"></i>
                            </div>
                            <input type="url" id="settingInstagram" placeholder="رابط حساب Instagram" dir="ltr"
                                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center">
                                <i class="fab fa-tiktok text-white"></i>
                            </div>
                            <input type="url" id="settingTiktokUrl" placeholder="رابط حساب TikTok" dir="ltr"
                                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-sky-500 rounded-lg flex items-center justify-center">
                                <i class="fab fa-twitter text-white"></i>
                            </div>
                            <input type="url" id="settingTwitter" placeholder="رابط حساب Twitter/X" dir="ltr"
                                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                                <i class="fab fa-youtube text-white"></i>
                            </div>
                            <input type="url" id="settingYoutube" placeholder="رابط قناة YouTube" dir="ltr"
                                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-yellow-400 rounded-lg flex items-center justify-center">
                                <i class="fab fa-snapchat-ghost text-white"></i>
                            </div>
                            <input type="url" id="settingSnapchat" placeholder="رابط حساب Snapchat" dir="ltr"
                                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                                <i class="fab fa-telegram-plane text-white"></i>
                            </div>
                            <input type="url" id="settingTelegram" placeholder="رابط قناة/حساب Telegram" dir="ltr"
                                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left text-sm">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">أضف روابط حساباتك وستظهر تلقائياً في الموقع</p>
                </div>

                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800"><i class="fas fa-user-shield ml-2 text-red-600"></i>أمان لوحة التحكم (Supabase)</h4>
                    <p class="text-xs text-gray-500">اكتب إيميلات المدراء المسموح لهم بالدخول (مفصولة بفواصل). إذا تركتها فارغة سيتم السماح لأي حساب Supabase Auth بالدخول (غير مُستحسن).</p>
                    <input type="text" id="settingAdminEmails" placeholder="admin@example.com, second@domain.com" dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">

                    <div class="border-t pt-3">
                        <h4 class="font-bold text-gray-800"><i class="fas fa-lock ml-2 text-red-600"></i>كلمة المرور القديمة (Local) - اختياري</h4>
                        <p class="text-xs text-gray-500">هذا القسم لم يعد أساسياً بعد تفعيل Supabase Auth، لكنه متروك إن احتجته لاحقاً.</p>
                        <input type="password" id="settingNewPassword" placeholder="كلمة مرور جديدة"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                        <input type="password" id="settingConfirmPassword" placeholder="تأكيد كلمة المرور"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                    </div>
                </div>

                <button onclick="saveSettings()" class="w-full py-3 gradient-btn text-white font-bold rounded-xl">
                    <i class="fas fa-save ml-2"></i>حفظ الإعدادات
                </button>
            </div>
        </div>
    </div>

    <!-- Product Modal (Add/Edit) -->
    <div id="productModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto slide-in">
            <div class="gradient-bg p-4 flex items-center justify-between sticky top-0 z-10">
                <h3 id="productModalTitle" class="text-white font-bold text-lg"><i class="fas fa-plus ml-2"></i>إضافة منتج جديد</h3>
                <button onclick="closeProductModal()" class="text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="productForm" class="p-6 space-y-6">
                <input type="hidden" id="editProductId">
                
                <!-- Basic Info -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-info-circle text-purple-600"></i>معلومات أساسية
                    </h4>
                    <input type="text" id="productName" placeholder="اسم المنتج *" required
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="productPriceInput" placeholder="السعر الحالي *" required
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                        <input type="number" id="productOldPriceInput" placeholder="السعر القديم *" required
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="productCategoryInput" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none bg-white">
                            <option value="">-- اختر التصنيف --</option>
                            <option value="electronics">إلكترونيات</option>
                            <option value="fashion">ملابس</option>
                            <option value="beauty">جمال</option>
                            <option value="home">المنزل</option>
                        </select>
                        <select id="productBadgeInput" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none bg-white">
                            <option value="">-- بدون شارة --</option>
                            <option value="الأكثر مبيعاً">الأكثر مبيعاً</option>
                            <option value="جديد">جديد</option>
                            <option value="عرض خاص">عرض خاص</option>
                            <option value="تخفيض">تخفيض</option>
                        </select>
                    </div>
                    <textarea id="productDescInput" placeholder="وصف المنتج *" required rows="3"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none resize-none"></textarea>
                </div>

                <!-- Images -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-images text-purple-600"></i>صور المنتج
                    </h4>
                    <div id="imageDropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-purple-500 transition-colors">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600">اسحب الصور هنا أو انقر للتحميل</p>
                        <p class="text-gray-400 text-sm mt-1">PNG, JPG, WEBP (حد أقصى 5 صور)</p>
                        <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm text-gray-600">أو أدخل روابط الصور:</p>
                        <div id="imageUrlInputs" class="space-y-2">
                            <div class="flex gap-2">
                                <input type="url" placeholder="رابط الصورة 1" dir="ltr"
                                    class="image-url-input flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                                <button type="button" onclick="addImageUrlInput()" class="px-4 py-2 bg-purple-100 text-purple-600 rounded-xl hover:bg-purple-200">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="imagePreviewContainer" class="flex flex-wrap gap-3"></div>
                </div>

                <!-- Specifications -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-list text-purple-600"></i>المواصفات
                    </h4>
                    <div id="specsContainer" class="space-y-2">
                        <div class="flex gap-2 spec-row">
                            <input type="text" placeholder="المواصفة (مثل: اللون)" 
                                class="spec-key flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <input type="text" placeholder="القيمة (مثل: أسود)" 
                                class="spec-value flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <button type="button" onclick="addSpecRow()" class="px-4 py-2 bg-purple-100 text-purple-600 rounded-xl hover:bg-purple-200">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Variants (Options like Color/Size) -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-sliders-h text-purple-600"></i>خيارات المنتج (Variants)
                    </h4>

                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 space-y-3">
                        <p class="text-xs text-gray-600 leading-relaxed">
                            استخدم هذه الميزة إذا كان المنتج لديه <b>ألوان/مقاسات/خيارات متعددة</b> في نفس رابط المنتج.
                            اكتب الخيارات بهذه الصيغة: <span class="font-mono">أحمر, أزرق, أسود</span>
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">اسم الخيار 1 (مثل: اللون)</label>
                                <input type="text" id="variantOpt1Name" placeholder="مثال: اللون" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">قيم الخيار 1 (مفصولة بفواصل)</label>
                                <input type="text" id="variantOpt1Values" placeholder="مثال: أحمر, أزرق, أسود" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">اسم الخيار 2 (مثل: المقاس)</label>
                                <input type="text" id="variantOpt2Name" placeholder="مثال: المقاس" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">قيم الخيار 2 (مفصولة بفواصل)</label>
                                <input type="text" id="variantOpt2Values" placeholder="مثال: S, M, L, XL" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none" dir="ltr">
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <button type="button" onclick="generateVariantsPreview()" class="px-4 py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600">
                                <i class="fas fa-wand-magic-sparkles ml-2"></i>توليد التركيبات
                            </button>
                            <button type="button" onclick="clearVariants()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300">
                                <i class="fas fa-eraser ml-2"></i>مسح الخيارات
                            </button>
                        </div>

                        <div id="variantsPreview" class="hidden">
                            <div class="flex items-center justify-between mt-2">
                                <div class="text-sm font-bold text-gray-800">قائمة التركيبات</div>
                                <div class="text-xs text-gray-500">يمكنك تعديل السعر/الصورة/المخزون لكل تركيبة</div>
                            </div>
                            <div class="mt-3 overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-gray-600">
                                            <th class="py-2 px-2 text-right">التركيبة</th>
                                            <th class="py-2 px-2 text-right">السعر</th>
                                            <th class="py-2 px-2 text-right">المخزون</th>
                                            <th class="py-2 px-2 text-right">رابط صورة (اختياري)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="variantsTbody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>

                        <details class="bg-white border border-gray-200 rounded-xl p-3">
                            <summary class="cursor-pointer font-semibold text-gray-700">متقدم: لصق/تعديل JSON للخيارات</summary>
                            <p class="text-xs text-gray-500 mt-2">يمكنك لصق JSON بصيغة <span class="font-mono">{options:[...], items:[...]}</span> ثم اضغط تطبيق.</p>
                            <textarea id="variantsJsonInput" class="w-full mt-2 p-2 text-xs font-mono border rounded-lg h-44" dir="ltr" placeholder='{"options":[{"name":"اللون","values":["أحمر","أزرق"]}],"items":[{"key":"أحمر","price":2500,"stock":10,"image":""}]}'></textarea>
                            <div class="flex gap-2 mt-2">
                                <button type="button" onclick="applyVariantsJson()" class="flex-1 py-2 bg-gray-900 text-white rounded-xl hover:bg-gray-950">
                                    <i class="fas fa-code ml-2"></i>تطبيق JSON
                                </button>
                                <button type="button" onclick="syncVariantsJsonFromDraft()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300">
                                    <i class="fas fa-rotate ml-2"></i>تحديث JSON من الجدول
                                </button>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 py-4 gradient-btn text-white font-bold text-lg rounded-xl">
                        <i class="fas fa-save ml-2"></i>حفظ المنتج
                    </button>
                    <button type="button" onclick="closeProductModal()" class="px-8 py-4 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300">
                        إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
        <div class="bg-white rounded-2xl max-w-md w-full slide-in">
            <div class="gradient-bg p-4 flex items-center justify-between rounded-t-2xl">
                <h3 id="categoryModalTitle" class="text-white font-bold text-lg"><i class="fas fa-plus ml-2"></i>إضافة تصنيف جديد</h3>
                <button onclick="closeCategoryModal()" class="text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="categoryForm" class="p-6 space-y-4">
                <input type="hidden" id="editCategoryId">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">اسم التصنيف بالعربية *</label>
                    <input type="text" id="categoryNameAr" placeholder="مثال: إلكترونيات" required
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">معرف التصنيف (بالإنجليزية) *</label>
                    <input type="text" id="categoryId" placeholder="مثال: electronics" required dir="ltr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <p class="text-xs text-gray-500 mt-1">استخدم حروف إنجليزية صغيرة بدون مسافات</p>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">أيقونة التصنيف *</label>
                    <div class="grid grid-cols-6 gap-2" id="iconSelector">
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-mobile-alt">
                            <i class="fas fa-mobile-alt text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-tshirt">
                            <i class="fas fa-tshirt text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-spa">
                            <i class="fas fa-spa text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-home">
                            <i class="fas fa-home text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-futbol">
                            <i class="fas fa-futbol text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-baby">
                            <i class="fas fa-baby text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-car">
                            <i class="fas fa-car text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-book">
                            <i class="fas fa-book text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-gamepad">
                            <i class="fas fa-gamepad text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-gift">
                            <i class="fas fa-gift text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-utensils">
                            <i class="fas fa-utensils text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-tools">
                            <i class="fas fa-tools text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-headphones">
                            <i class="fas fa-headphones text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-camera">
                            <i class="fas fa-camera text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-laptop">
                            <i class="fas fa-laptop text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-shoe-prints">
                            <i class="fas fa-shoe-prints text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-gem">
                            <i class="fas fa-gem text-xl text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option p-3 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition-all" data-icon="fa-couch">
                            <i class="fas fa-couch text-xl text-gray-600"></i>
                        </button>
                    </div>
                    <input type="hidden" id="selectedIcon" value="">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="flex-1 py-3 gradient-btn text-white font-bold rounded-xl">
                        <i class="fas fa-save ml-2"></i>حفظ التصنيف
                    </button>
                    <button type="button" onclick="closeCategoryModal()" class="px-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300">
                        إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- WhatsApp Float Button -->
    <a id="whatsappBtn" href="#" target="_blank" 
        class="fixed bottom-6 left-6 z-40 w-14 h-14 bg-green-500 rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 transition-all hover:scale-110">
        <i class="fab fa-whatsapp text-white text-2xl"></i>
    </a>

    <script>
        // ==================== الإعدادات ====================
        // ✅ إعدادات Supabase - تعمل لجميع الزوار
        const SUPABASE_CONFIG = {
            url: "https://bgrnlautilpleguxighw.supabase.co",
            anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJncm5sYXV0aWxwbGVndXhpZ2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNDcyMDMsImV4cCI6MjA4MjkyMzIwM30.NW_nP0VCNilGG1OXaqObAIv69QTyMrIVC6y26EWyQs8"
        };

        const CONFIG = {
            defaultPassword: 'admin123',
            storeName: 'متجرنا',
            phone: '0555123456',
            email: 'contact@store.dz',
            whatsapp: '213555123456',
            // Tracking toggles (client-side)
            // ملاحظة: TikTok Pixel غالباً يُحظر بواسطة AdBlock ويظهر ERR_BLOCKED_BY_CLIENT.
            // لذلك نجعله مُعطّل افتراضياً، ويمكن تفعيله من الإعدادات عند الحاجة.
            enableFacebookPixel: true,
            enableTikTokPixel: false,
            enableGoogleAnalytics: true
        };

        // ==================== المنتجات الافتراضية ====================
        const defaultProducts = [
            { 
                id: 1, 
                name: "سماعات بلوتوث لاسلكية", 
                price: 3500, 
                oldPrice: 4500, 
                images: [
                    "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=600&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1484704849700-f032a568e944?w=600&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1524678606370-a47ad25cb82a?w=600&h=600&fit=crop"
                ],
                category: "electronics", 
                badge: "الأكثر مبيعاً",
                description: "سماعات بلوتوث لاسلكية عالية الجودة مع صوت نقي وباس قوي. تتميز بعمر بطارية طويل يصل إلى 24 ساعة وتصميم مريح للاستخدام اليومي.",
                specs: { "نوع الاتصال": "بلوتوث 5.0", "عمر البطارية": "24 ساعة", "الوزن": "250 غرام", "الضمان": "سنة واحدة" }
            },
            { 
                id: 2, 
                name: "ساعة ذكية متعددة الوظائف", 
                price: 8500, 
                oldPrice: 12000, 
                images: [
                    "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=600&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1579586337278-3befd40fd17a?w=600&h=600&fit=crop"
                ],
                category: "electronics", 
                badge: "تخفيض",
                description: "ساعة ذكية أنيقة مع شاشة AMOLED ومقاومة للماء.",
                specs: { "الشاشة": "AMOLED 1.4 بوصة", "مقاومة الماء": "IP68", "البطارية": "7 أيام" }
            },
            { 
                id: 3, 
                name: "حقيبة ظهر عصرية", 
                price: 2800, 
                oldPrice: 3500, 
                images: [
                    "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=600&h=600&fit=crop"
                ],
                category: "fashion", 
                badge: "",
                description: "حقيبة ظهر عصرية ومريحة مناسبة للعمل والسفر.",
                specs: { "المادة": "قماش مقاوم للماء", "السعة": "25 لتر" }
            },
            { 
                id: 4, 
                name: "نظارات شمسية أنيقة", 
                price: 1500, 
                oldPrice: 2000, 
                images: [
                    "https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=600&h=600&fit=crop"
                ],
                category: "fashion", 
                badge: "جديد",
                description: "نظارات شمسية أنيقة بتصميم عصري.",
                specs: { "الحماية": "UV400", "المادة": "بلاستيك عالي الجودة" }
            },
            { 
                id: 5, 
                name: "عطر فاخر للرجال", 
                price: 4500, 
                oldPrice: 6000, 
                images: [
                    "https://images.unsplash.com/photo-1541643600914-78b084683601?w=600&h=600&fit=crop"
                ],
                category: "beauty", 
                badge: "",
                description: "عطر رجالي فاخر برائحة خشبية مميزة.",
                specs: { "الحجم": "100 مل", "النوع": "Eau de Parfum" }
            },
            { 
                id: 6, 
                name: "مصباح LED ذكي", 
                price: 2200, 
                oldPrice: 3000, 
                images: [
                    "https://images.unsplash.com/photo-1507473885765-e6ed057f782c?w=600&h=600&fit=crop"
                ],
                category: "home", 
                badge: "",
                description: "مصباح LED ذكي يتحكم فيه عن طريق التطبيق.",
                specs: { "القدرة": "9 واط", "الألوان": "16 مليون لون" }
            }
        ];

        // ==================== بيانات الولايات ====================
        const algeriaData = {
            1: { name: "أدرار", office: 900, home: 1200 },
            2: { name: "الشلف", office: 250, home: 650 },
            3: { name: "الأغواط", office: 500, home: 800 },
            4: { name: "أم البواقي", office: 300, home: 650 },
            5: { name: "باتنة", office: 300, home: 650 },
            6: { name: "بجاية", office: 300, home: 650 },
            7: { name: "بسكرة", office: 400, home: 750 },
            8: { name: "بشار", office: 900, home: 1200 },
            9: { name: "البليدة", office: 250, home: 650 },
            10: { name: "البويرة", office: 250, home: 650 },
            11: { name: "تمنراست", office: 1200, home: 1600 },
            12: { name: "تبسة", office: 400, home: 750 },
            13: { name: "تلمسان", office: 250, home: 650 },
            14: { name: "تيارت", office: 300, home: 650 },
            15: { name: "تيزي وزو", office: 250, home: 600 },
            16: { name: "الجزائر", office: 250, home: 500 },
            17: { name: "الجلفة", office: 500, home: 700 },
            18: { name: "جيجل", office: 300, home: 650 },
            19: { name: "سطيف", office: 250, home: 650 },
            20: { name: "سعيدة", office: 400, home: 700 },
            21: { name: "سكيكدة", office: 300, home: 650 },
            22: { name: "سيدي بلعباس", office: 200, home: 300 },
            23: { name: "عنابة", office: 300, home: 650 },
            24: { name: "قالمة", office: 400, home: 700 },
            25: { name: "قسنطينة", office: 250, home: 650 },
            26: { name: "المدية", office: 250, home: 650 },
            27: { name: "مستغانم", office: 250, home: 650 },
            28: { name: "المسيلة", office: 300, home: 650 },
            29: { name: "معسكر", office: 400, home: 700 },
            30: { name: "ورقلة", office: 600, home: 900 },
            31: { name: "وهران", office: 250, home: 650 },
            32: { name: "البيض", office: 600, home: 900 },
            33: { name: "إليزي", office: 1500, home: 1800 },
            34: { name: "برج بوعريريج", office: 250, home: 650 },
            35: { name: "بومرداس", office: 250, home: 650 },
            36: { name: "الطارف", office: 400, home: 750 },
            37: { name: "تندوف", office: 1200, home: 1600 },
            38: { name: "تيسمسيلت", office: 300, home: 650 },
            39: { name: "الوادي", office: 600, home: 900 },
            40: { name: "خنشلة", office: 400, home: 700 },
            41: { name: "سوق أهراس", office: 400, home: 700 },
            42: { name: "تيبازة", office: 250, home: 650 },
            43: { name: "ميلة", office: 300, home: 650 },
            44: { name: "عين الدفلى", office: 250, home: 650 },
            45: { name: "النعامة", office: 600, home: 900 },
            46: { name: "عين تموشنت", office: 400, home: 700 },
            47: { name: "غرداية", office: 600, home: 900 },
            48: { name: "غليزان", office: 250, home: 650 },
            49: { name: "تيميمون", office: 900, home: 1200 },
            50: { name: "برج باجي مختار", office: 900, home: 1200 },
            51: { name: "أولاد جلال", office: 500, home: 800 },
            52: { name: "بني عباس", office: 900, home: 1200 },
            53: { name: "عين صالح", office: 900, home: 1200 },
            54: { name: "عين قزام", office: 1500, home: 1800 },
            55: { name: "تقرت", office: 600, home: 900 },
            56: { name: "جانت", office: 1500, home: 1800 },
            57: { name: "المغير", office: 600, home: 900 },
            58: { name: "المنيعة", office: 800, home: 1100 }
        };

        // ==================== التصنيفات الافتراضية ====================
        const defaultCategories = [
            { id: 'electronics', name: 'إلكترونيات', icon: 'fa-mobile-alt' },
            { id: 'fashion', name: 'ملابس', icon: 'fa-tshirt' },
            { id: 'beauty', name: 'جمال', icon: 'fa-spa' },
            { id: 'home', name: 'المنزل', icon: 'fa-home' }
        ];

        // ==================== المتغيرات العامة ====================
        // المصدر الأساسي للبيانات سيكون Supabase، مع كاش محلي لعرض سريع (stale-while-revalidate)
        let products = [];
        let categories = [];
        let orders = [];

        // ===== Local Storage helpers (prevent quota issues) =====
        const NO_IMAGE_PLACEHOLDER = "data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D'http%3A//www.w3.org/2000/svg'%20width%3D'120'%20height%3D'120'%20viewBox%3D'0%200%20120%20120'%3E%3Crect%20width%3D'120'%20height%3D'120'%20fill%3D'%23e5e7eb'/%3E%3Cpath%20d%3D'M30%2090l22-28%2018%2020%2012-16%2018%2024H30z'%20fill%3D'%239ca3af'/%3E%3Ccircle%20cx%3D'45'%20cy%3D'45'%20r%3D'8'%20fill%3D'%239ca3af'/%3E%3C/svg%3E";

        function isQuotaExceededError(e) {
            return !!e && (
                e.name === 'QuotaExceededError' ||
                e.code === 22 ||
                e.code === 1014 ||
                (typeof e.message === 'string' && e.message.toLowerCase().includes('quota'))
            );
        }

        function safeStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                if (isQuotaExceededError(e)) {
                    // Try to free space from non-critical caches
                    try { localStorage.removeItem('storeProducts'); } catch (_) {}
                    try { localStorage.removeItem('storeCategories'); } catch (_) {}
                    try { localStorage.removeItem('storeCacheAt'); } catch (_) {}
                    try { localStorage.removeItem('storeCacheSource'); } catch (_) {}
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch (_) {
                        return false;
                    }
                }
                return false;
            }
        }

        function safeJsonParse(str, fallback) {
            try { return JSON.parse(str); } catch (_) { return fallback; }
        }

        function isDataUri(u) {
            return typeof u === 'string' && u.startsWith('data:image');
        }

        // Normalize cart items to a lightweight format (avoid storing big base64 images)
        function normalizeCartItem(raw) {
            if (!raw || typeof raw !== 'object') return null;
            const id = Number(raw.id);
            if (!Number.isFinite(id)) return null;
            const quantity = Math.max(1, Math.min(99, Number(raw.quantity) || 1));
            const price = Number(raw.price) || 0;
            const name = String(raw.name || '');
            const variantKey = String(raw.variantKey || '');
            const variantLabel = String(raw.variantLabel || '');
            const selectedOptions = (raw.selectedOptions && typeof raw.selectedOptions === 'object') ? raw.selectedOptions : {};

            // Store only small/URL images in cart; never store big base64
            const imgCandidate = String(raw.image || (Array.isArray(raw.images) ? (raw.images[0] || '') : ''));
            const image = (!imgCandidate || isDataUri(imgCandidate)) ? '' : imgCandidate;

            return { id, name, price, quantity, variantKey, variantLabel, selectedOptions, image };
        }

        function loadCartFromStorage() {
            const raw = safeJsonParse(localStorage.getItem('cart') || '[]', []);
            if (!Array.isArray(raw)) return [];
            const normalized = raw.map(normalizeCartItem).filter(Boolean);
            // Overwrite with lightweight format to avoid quota issues in future
            safeStorageSet('cart', JSON.stringify(normalized));
            return normalized;
        }

        function getCartItemImage(item) {
            // Prefer lightweight stored image (URL). If missing, use product image from memory.
            if (item?.image) return item.image;
            const p = products.find(x => x.id === item?.id);
            const img = p?.images?.[0] || '';
            return img || NO_IMAGE_PLACEHOLDER;
        }

        // Use for admin order views: if order item has no image stored, fallback to product/variant image
        function getOrderItemImage(orderItem) {
            try {
                const direct = String(orderItem?.image || '').trim();
                if (direct) return direct;

                const pid = Number(orderItem?.id);
                const p = products.find(x => x.id === pid);
                if (!p) return NO_IMAGE_PLACEHOLDER;

                // If item has a variantKey, try to use variant image
                const vKey = String(orderItem?.variantKey || '').trim();
                if (vKey && p?.variants?.items?.length) {
                    const v = p.variants.items.find(it => it?.key === vKey);
                    if (v?.image) return v.image;
                }

                return p?.images?.[0] || NO_IMAGE_PLACEHOLDER;
            } catch (_) {
                return NO_IMAGE_PLACEHOLDER;
            }
        }

        function safeImageForOrder(img) {
            // Avoid storing huge base64 inside orders/items
            if (!img) return '';
            if (isDataUri(img) && img.length > 6000) return '';
            return img;
        }

        let cart = loadCartFromStorage();
        let settings = JSON.parse(localStorage.getItem('storeSettings')) || CONFIG;
        window.settings = settings;

        // كاش سريع للعرض الفوري (stale-while-revalidate)
        // مهم: لا نستخدم الكاش إذا كان من مصدر غير Supabase حتى لا تظهر منتجات افتراضية قديمة للحظات.
        function canUseCachedDataQuickly() {
            const src = localStorage.getItem('storeCacheSource');
            const ts = Number(localStorage.getItem('storeCacheAt') || '0');
            if (src !== 'supabase') return false;
            if (!ts) return false;
            const age = Date.now() - ts;
            // مدة صلاحية الكاش (2 دقائق) لتقليل احتمال إظهار بيانات قديمة/خاطئة
            // (مهم لتجنب ظهور منتجات قديمة ثم تحديثها بعد ثواني)
            return age >= 0 && age < 1000 * 60 * 2;
        }

        function markCacheAsSupabaseFresh() {
            try {
                localStorage.setItem('storeCacheSource', 'supabase');
                localStorage.setItem('storeCacheAt', String(Date.now()));
            } catch (_) {}
        }

        function looksLikeDefaultProducts(list) {
            try {
                if (!Array.isArray(list) || !list.length) return false;
                const defaultNames = new Set(defaultProducts.map(p => p.name));
                // إذا كانت أغلب الأسماء من المنتجات الافتراضية فهذا يعني كاش قديم/غير مرغوب
                const hits = list.reduce((acc, p) => acc + (defaultNames.has(p?.name) ? 1 : 0), 0);
                return hits >= Math.min(3, defaultNames.size);
            } catch (_) {
                return false;
            }
        }

        // تنظيف أي كاش قديم يحتوي على منتجات افتراضية لتجنب ظهورها ثم اختفائها
        function purgeDefaultProductsCache() {
            try {
                const cachedProducts = JSON.parse(localStorage.getItem('storeProducts') || '[]');
                if (looksLikeDefaultProducts(cachedProducts)) {
                    localStorage.removeItem('storeProducts');
                    localStorage.removeItem('storeCategories');
                    localStorage.removeItem('storeCacheSource');
                    localStorage.removeItem('storeCacheAt');
                }
            } catch (_) {}
        }

        function loadCachedDataQuickly() {
            if (!canUseCachedDataQuickly()) return;
            try {
                const cachedProducts = JSON.parse(localStorage.getItem('storeProducts') || '[]');
                const cachedCategories = JSON.parse(localStorage.getItem('storeCategories') || '[]');

                // لا تعرض كاش قديم عبارة عن منتجات افتراضية
                if (Array.isArray(cachedProducts) && cachedProducts.length && !looksLikeDefaultProducts(cachedProducts)) {
                    products = cachedProducts;
                }
                if (Array.isArray(cachedCategories) && cachedCategories.length) {
                    categories = cachedCategories;
                }
            } catch (_) {}
        }

        // تحميل منتج واحد بسرعة (مفيد لروابط TikTok/FB preview)
        async function loadSingleProductFromSupabase(productId) {
            if (!supabaseReady || !supabaseClient) return null;
            try {
                const pid = Number(productId);
                if (!Number.isFinite(pid)) return null;
                const { data, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('id', pid)
                    .limit(1);
                if (error) throw error;
                const row = data?.[0];
                const p = mapProductFromDb(row);
                if (!p) return null;
                // حدّث المنتجات محلياً (بدون انتظار تحميل الكل)
                const exists = products.some(x => x.id === p.id);
                if (!exists) products = [p, ...products];
                return p;
            } catch (e) {
                return null;
            }
        }

        // لا نعرض بيانات الكاش إذا كانت المنتجات الافتراضية (لكي لا يظهر "فلاش" منتجات غير صحيحة)
        // أو إذا كان المستخدم داخل TikTok/FB preview (عادةً يحتاج عرض مباشر للمنتج بسرعة).
        function shouldUseCacheForUI() {
            try {
                if (!products.length) return false;
                if (looksLikeDefaultProducts(products)) return false;
                return true;
            } catch (_) {
                return false;
            }
        }
        let isAdmin = false;
        let currentProduct = null;
        let productQuantity = 1;

        // Variants (colors/sizes/options)
        let currentVariant = null;
        let currentSelectedOptions = {};
        let variantsDraft = [];
        let variantOptionsDraft = null;

        // Variants selection state
        // (Confirmation step removed per request)
        let variantConfirmationRequired = false;
        let variantSelectionConfirmed = true;

        let uploadedImages = [];
        let selectedCategoryIcon = '';
        let appInitialized = false;

        // لمنع فلاش الصفحة الرئيسية في روابط المنتجات القادمة من الإعلانات
        // قبل اكتمال جلب البيانات من Supabase.
        let dataFetchedOnce = false;

        // ==================== Supabase ====================
        let supabaseClient = null;
        let supabaseReady = false;

        // ==================== دوال الأمان ====================
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.replace(/[<>"'&]/g, (char) => {
                const entities = { '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '&': '&amp;' };
                return entities[char];
            });
        }

        function validatePhone(phone) {
            return /^0[567][0-9]{8}$/.test(phone);
        }

        function validateEmail(email) {
            if (!email) return true;
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function generateOrderId() {
            const date = new Date();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `ORD-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}-${random}`;
        }

        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // ==================== دوال الإشعارات ====================
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            notification.className = `notification ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>${message}`;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        // ==================== دوال المنتجات ====================
        // ===== Variants helpers =====
        function parseCommaList(s) {
            return String(s || '')
                .split(',')
                .map(x => x.trim())
                .filter(Boolean);
        }

        function computeOptionKeyFromSelection(selection, optionNames) {
            const parts = optionNames.map(n => selection[n] || '');
            return parts.join(' / ');
        }

        function getVariantOptionNamesFromProduct(product) {
            const opts = product?.variants?.options;
            if (!opts || !Array.isArray(opts)) return [];
            return opts.map(o => o?.name).filter(Boolean);
        }

        function normalizeVariantsProductFields(product) {
            // Ensure product.variants has a consistent structure
            if (!product) return product;
            if (!product.variants || typeof product.variants !== 'object') {
                product.variants = null;
                return product;
            }
            const options = Array.isArray(product.variants.options) ? product.variants.options : [];
            const items = Array.isArray(product.variants.items) ? product.variants.items : [];
            product.variants = { options, items };
            return product;
        }

        function generateVariantCombos(options) {
            // options: [{name, values:[]}, ...]
            const active = (options || []).filter(o => o?.name && Array.isArray(o.values) && o.values.length);
            if (!active.length) return [];

            const rec = (idx, acc) => {
                if (idx >= active.length) return [acc];
                const o = active[idx];
                const out = [];
                for (const val of o.values) {
                    out.push(...rec(idx + 1, { ...acc, [o.name]: val }));
                }
                return out;
            };

            return rec(0, {});
        }

        function generateVariantsPreview() {
            const opt1Name = document.getElementById('variantOpt1Name')?.value?.trim();
            const opt1Values = parseCommaList(document.getElementById('variantOpt1Values')?.value);
            const opt2Name = document.getElementById('variantOpt2Name')?.value?.trim();
            const opt2Values = parseCommaList(document.getElementById('variantOpt2Values')?.value);

            const options = [];
            if (opt1Name && opt1Values.length) options.push({ name: opt1Name, values: opt1Values });
            if (opt2Name && opt2Values.length) options.push({ name: opt2Name, values: opt2Values });

            if (!options.length) {
                showNotification('أدخل اسم خيار واحد على الأقل مع قيمه', 'error');
                return;
            }

            variantOptionsDraft = options;

            const combos = generateVariantCombos(options);
            const optionNames = options.map(o => o.name);

            // If editing, try to keep existing prices/stock/images by matching selection
            const editId = document.getElementById('editProductId')?.value;
            let existingItems = [];
            if (editId) {
                const p = products.find(x => x.id === Number(editId));
                existingItems = Array.isArray(p?.variants?.items) ? p.variants.items : [];
            }

            variantsDraft = combos.map((sel) => {
                const key = computeOptionKeyFromSelection(sel, optionNames);
                const found = existingItems.find(it => it?.key === key);
                return {
                    key,
                    options: sel,
                    price: Number(found?.price) || null,
                    stock: Number.isFinite(Number(found?.stock)) ? Number(found.stock) : null,
                    image: String(found?.image || '')
                };
            });

            renderVariantsTable();
        }

        function clearVariants() {
            variantOptionsDraft = null;
            variantsDraft = [];
            const box = document.getElementById('variantsPreview');
            if (box) box.classList.add('hidden');
            const t = document.getElementById('variantsTbody');
            if (t) t.innerHTML = '';
            const o1n = document.getElementById('variantOpt1Name');
            const o1v = document.getElementById('variantOpt1Values');
            const o2n = document.getElementById('variantOpt2Name');
            const o2v = document.getElementById('variantOpt2Values');
            if (o1n) o1n.value = '';
            if (o1v) o1v.value = '';
            if (o2n) o2n.value = '';
            if (o2v) o2v.value = '';
        }

        function renderVariantsTable() {
            const box = document.getElementById('variantsPreview');
            const tbody = document.getElementById('variantsTbody');
            if (!box || !tbody) return;

            box.classList.remove('hidden');

            tbody.innerHTML = variantsDraft.map((v, idx) => {
                const label = v.key;
                return `
                    <tr>
                        <td class="py-2 px-2 font-semibold text-gray-800">${sanitizeInput(label)}</td>
                        <td class="py-2 px-2">
                            <input type="number" class="variant-price w-28 px-2 py-1 border rounded-lg" data-idx="${idx}" placeholder="(افتراضي)" value="${v.price ?? ''}">
                        </td>
                        <td class="py-2 px-2">
                            <input type="number" class="variant-stock w-24 px-2 py-1 border rounded-lg" data-idx="${idx}" placeholder="-" value="${v.stock ?? ''}">
                        </td>
                        <td class="py-2 px-2">
                            <input type="url" dir="ltr" class="variant-image w-full min-w-[220px] px-2 py-1 border rounded-lg text-left" data-idx="${idx}" placeholder="https://..." value="${sanitizeInput(v.image || '')}">
                        </td>
                    </tr>
                `;
            }).join('');

            // attach listeners
            tbody.querySelectorAll('.variant-price').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const i = Number(e.target.dataset.idx);
                    const val = e.target.value;
                    variantsDraft[i].price = val === '' ? null : Number(val);
                });
            });
            tbody.querySelectorAll('.variant-stock').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const i = Number(e.target.dataset.idx);
                    const val = e.target.value;
                    variantsDraft[i].stock = val === '' ? null : Number(val);
                });
            });
            tbody.querySelectorAll('.variant-image').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const i = Number(e.target.dataset.idx);
                    variantsDraft[i].image = e.target.value || '';
                });
            });

            // Keep JSON textarea updated (if visible)
            try { syncVariantsJsonFromDraft({ silent: true }); } catch (_) {}
        }

        function applyVariantsJson() {
            const textarea = document.getElementById('variantsJsonInput');
            if (!textarea) return;
            const raw = textarea.value.trim();
            if (!raw) {
                showNotification('ألصق JSON أولاً', 'error');
                return;
            }
            try {
                const parsed = JSON.parse(raw);
                const options = Array.isArray(parsed.options) ? parsed.options : [];
                const items = Array.isArray(parsed.items) ? parsed.items : [];

                if (!options.length) {
                    showNotification('JSON غير صحيح: options مطلوبة', 'error');
                    return;
                }

                // Fill option inputs (supports up to 2 options in UI)
                const o1 = options[0] || {};
                const o2 = options[1] || {};
                document.getElementById('variantOpt1Name').value = o1.name || '';
                document.getElementById('variantOpt1Values').value = Array.isArray(o1.values) ? o1.values.join(', ') : '';
                document.getElementById('variantOpt2Name').value = o2.name || '';
                document.getElementById('variantOpt2Values').value = Array.isArray(o2.values) ? o2.values.join(', ') : '';

                variantOptionsDraft = options.map(o => ({ name: String(o.name || '').trim(), values: Array.isArray(o.values) ? o.values.map(v => String(v).trim()).filter(Boolean) : [] }))
                    .filter(o => o.name && o.values.length);

                // Build variantsDraft from items
                variantsDraft = items.map(it => ({
                    key: String(it.key || ''),
                    options: it.options && typeof it.options === 'object' ? it.options : {},
                    price: (it.price === null || typeof it.price === 'undefined' || it.price === '') ? null : Number(it.price),
                    stock: (it.stock === null || typeof it.stock === 'undefined' || it.stock === '') ? null : Number(it.stock),
                    image: String(it.image || '')
                })).filter(v => v.key);

                // If JSON has options but no items, generate combos
                if (!variantsDraft.length) {
                    generateVariantsPreview();
                } else {
                    renderVariantsTable();
                    const box = document.getElementById('variantsPreview');
                    if (box) box.classList.remove('hidden');
                }

                showNotification('تم تطبيق JSON بنجاح', 'success');
            } catch (e) {
                showNotification('JSON غير صالح: تحقق من الصيغة', 'error');
            }
        }

        function syncVariantsJsonFromDraft({ silent = false } = {}) {
            const textarea = document.getElementById('variantsJsonInput');
            if (!textarea) return;
            const options = variantOptionsDraft || [];
            const items = (variantsDraft || []).map(v => ({
                key: v.key,
                options: v.options || {},
                price: v.price,
                stock: v.stock,
                image: v.image || ''
            }));
            const json = { options, items };
            textarea.value = JSON.stringify(json, null, 2);
            if (!silent) showNotification('تم تحديث JSON', 'info');
        }

        function saveProducts() {
            // نبقي نسخة محلية للسرعة، لكن المصدر الحقيقي Supabase
            localStorage.setItem('storeProducts', JSON.stringify(products));
        }

        async function syncProduct(product) {
            // حفظ/تحديث المنتج في Supabase
            try {
                await saveProductToSupabase(product);
            } catch (e) {
                console.error(e);
            }
        }

        function getNextProductId() {
            return products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
        }

        function renderProductsSkeleton(count = 8) {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;
            document.getElementById('productCount').textContent = 'جاري التحميل...';
            grid.innerHTML = Array.from({ length: count }).map(() => `
                <div class="bg-white rounded-2xl overflow-hidden shadow-md">
                    <div class="h-40 md:h-48 bg-gray-200 animate-pulse"></div>
                    <div class="p-3 md:p-4 space-y-3">
                        <div class="h-4 bg-gray-200 rounded animate-pulse"></div>
                        <div class="h-4 bg-gray-200 rounded w-3/4 animate-pulse"></div>
                        <div class="h-9 bg-gray-200 rounded-xl animate-pulse"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderProducts(category = 'all') {
            const grid = document.getElementById('productsGrid');
            const filtered = category === 'all' ? products : products.filter(p => p.category === category);
            document.getElementById('productCount').textContent = `${filtered.length} منتج`;
            
            grid.innerHTML = filtered.map(product => {
                const discount = Math.round((1 - product.price / product.oldPrice) * 100);
                return `
                    <div class="product-card bg-white rounded-2xl overflow-hidden shadow-md cursor-pointer" onclick="viewProduct(${product.id})">
                        <div class="relative">
                            <img src="${product.images[0]}" alt="${product.name}" loading="lazy" decoding="async" class="w-full h-40 md:h-48 object-cover" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27400%27%20height%3D%27400%27%3E%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27%23e5e7eb%27/%3E%3Ctext%20x%3D%2750%25%27%20y%3D%2750%25%27%20dominant-baseline%3D%27middle%27%20text-anchor%3D%27middle%27%20fill%3D%27%236b7280%27%20font-family%3D%27Arial%27%20font-size%3D%2724%27%3ENo%20Image%3C/text%3E%3C/svg%3E'">
                            ${product.badge ? `<span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">${product.badge}</span>` : ''}
                            <span class="absolute top-2 left-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">-${discount}%</span>
                        </div>
                        <div class="p-3 md:p-4">
                            <h4 class="font-semibold text-gray-800 text-sm md:text-base mb-2 line-clamp-2">${product.name}</h4>
                            <div class="flex items-center gap-2 flex-wrap mb-3">
                                <span class="text-lg md:text-xl font-bold text-green-600">${product.price.toLocaleString('ar-DZ')} دج</span>
                                <span class="text-xs md:text-sm text-gray-400 line-through">${product.oldPrice.toLocaleString('ar-DZ')} دج</span>
                            </div>
                            <button onclick="event.stopPropagation(); viewProduct(${product.id})" class="w-full py-2 gradient-btn text-white font-semibold rounded-xl text-sm">
                                <i class="fas fa-eye ml-1"></i>عرض المنتج
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== صفحة المنتج ====================
        function renderProductPageSkeleton(productId) {
            showPage('product', { push: false });
            const bc = document.getElementById('productBreadcrumb');
            if (bc) bc.textContent = 'جاري التحميل...';
            const titleEl = document.getElementById('productTitle');
            if (titleEl) titleEl.textContent = 'جاري تحميل المنتج...';
            const descEl = document.getElementById('productDescription');
            if (descEl) descEl.textContent = '';
            const mainImg = document.getElementById('mainProductImage');
            if (mainImg) mainImg.src = '';
            const badge = document.getElementById('productBadge');
            if (badge) badge.style.display = 'none';
            const discount = document.getElementById('discountBadge');
            if (discount) discount.textContent = '';
            const thumbs = document.getElementById('thumbnailContainer');
            if (thumbs) thumbs.innerHTML = '';
            const tabContent = document.getElementById('tabContent');
            if (tabContent) tabContent.innerHTML = '<div class="text-center text-gray-500 py-8">جاري التحميل...</div>';
        }

        function viewProduct(productId, opts = {}) {
            const push = opts.push !== false;
            // Update URL for shareable product link
            if (push && typeof setUrlParams === 'function' && !window.__routeApplying) {
                setUrlParams({ page: 'product', id: String(productId) });
                // Also set hash for extra robustness (some ad platforms rewrite query params)
                try { window.location.hash = `#/product/${productId}`; } catch (_) {}
            }

            currentProduct = products.find(p => p.id === productId);
            if (!currentProduct) {
                // إذا لم تُحمّل المنتجات بعد (زي تيك توك preview) نظهر Skeleton بدل الرجوع للرئيسية
                renderProductPageSkeleton(productId);
                return;
            }

            productQuantity = 1;
            const discount = Math.round((1 - currentProduct.price / currentProduct.oldPrice) * 100);
            const category = categories.find(c => c.id === currentProduct.category);
            const categoryName = category ? category.name : currentProduct.category;

            document.getElementById('productBreadcrumb').textContent = currentProduct.name;
            document.getElementById('productCategory').textContent = categoryName;
            document.getElementById('mainProductImage').src = currentProduct.images[0];
            document.getElementById('productBadge').textContent = currentProduct.badge || '';
            document.getElementById('productBadge').style.display = currentProduct.badge ? 'block' : 'none';
            document.getElementById('discountBadge').textContent = `-${discount}%`;

            document.getElementById('thumbnailContainer').innerHTML = currentProduct.images.map((img, index) => `
                <img src="${img}" loading="lazy" decoding="async" onclick="changeMainImage('${img}', this)" 
                    class="thumbnail w-16 h-16 md:w-20 md:h-20 object-cover rounded-lg border-2 ${index === 0 ? 'active border-purple-500' : 'border-gray-200'} cursor-pointer"
                    onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27400%27%20height%3D%27400%27%3E%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27%23e5e7eb%27/%3E%3Ctext%20x%3D%2750%25%27%20y%3D%2750%25%27%20dominant-baseline%3D%27middle%27%20text-anchor%3D%27middle%27%20fill%3D%27%236b7280%27%20font-family%3D%27Arial%27%20font-size%3D%2724%27%3ENo%20Image%3C/text%3E%3C/svg%3E'">
            `).join('');

            document.getElementById('productTitle').textContent = currentProduct.name;
            document.getElementById('productPrice').textContent = currentProduct.price.toLocaleString('ar-DZ') + ' دج';
            document.getElementById('productOldPrice').textContent = currentProduct.oldPrice.toLocaleString('ar-DZ') + ' دج';
            document.getElementById('productDiscount').textContent = `-${discount}%`;
            document.getElementById('productDescription').textContent = currentProduct.description;
            document.getElementById('productQty').textContent = '1';

            // Variants UI
            currentVariant = null;
            currentSelectedOptions = {};
            // Confirmation step removed
            setVariantConfirmationUI();
            renderVariantSelectors(currentProduct);

            // Reset rating UI to loading; will be updated after fetching reviews
            const ratingTextEl = document.getElementById('productRatingText');
            if (ratingTextEl) ratingTextEl.textContent = 'جاري تحميل التقييمات...';

            showTab('description');
            loadRelatedProducts();
            showPage('product');
            window.scrollTo(0, 0);

            // Load reviews in background to update rating line (no blocking)
            (async () => {
                try {
                    await loadReviewsForProduct(currentProduct.id);
                    const list = currentProductReviews || [];
                    const avg = list.length ? (list.reduce((s, r) => s + (Number(r.rating)||0), 0) / list.length) : 0;
                    if (ratingTextEl) {
                        ratingTextEl.textContent = list.length ? `(${avg.toFixed(1)}) - ${list.length} تقييم` : 'لا توجد تقييمات بعد';
                    }
                } catch (_) {}
            })();
            
            // تتبع مشاهدة المنتج
            trackViewContent(currentProduct);
        }

        function changeMainImage(src, element) {
            document.getElementById('mainProductImage').src = src;
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active', 'border-purple-500'));
            element.classList.add('active', 'border-purple-500');
        }

        function changeProductQty(change) {
            productQuantity = Math.max(1, Math.min(10, productQuantity + change));
            document.getElementById('productQty').textContent = productQuantity;
        }

        // ===== Variants UI (Product Page) =====
        function findMatchingVariant(product, selection) {
            const p = normalizeVariantsProductFields({ ...(product || {}) });
            if (!p.variants || !Array.isArray(p.variants.items) || !Array.isArray(p.variants.options)) return null;
            const optionNames = p.variants.options.map(o => o.name);
            const key = computeOptionKeyFromSelection(selection, optionNames);
            return p.variants.items.find(v => v && v.key === key) || null;
        }

        function applyVariantSelection(product, selection) {
            const variant = findMatchingVariant(product, selection);
            currentVariant = variant;
            currentSelectedOptions = { ...(selection || {}) };

            // Any change in selection cancels previous confirmation
            if (variantConfirmationRequired) {
                variantSelectionConfirmed = false;
            }

            // Update badge text
            const badge = document.getElementById('variantSelectedBadge');
            if (badge) {
                const txt = Object.entries(currentSelectedOptions).map(([k, v]) => `${k}: ${v}`).join(' • ');
                if (txt) {
                    // إذا لم نجد تركيبة مطابقة في items، نعرض تنبيه بسيط (مفيد للمدير)
                    const extra = (!variant && product?.variants?.items?.length)
                        ? ' — (ملاحظة: لم يتم ضبط بيانات هذه التركيبة في لوحة التحكم)'
                        : '';
                    badge.textContent = `الخيارات المحددة: ${txt}${extra}`;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            // Update price/image if variant has overrides
            const priceEl = document.getElementById('productPrice');
            const oldEl = document.getElementById('productOldPrice');
            const discountEl = document.getElementById('productDiscount');

            let effectivePrice = product.price;
            if (variant && Number.isFinite(Number(variant.price)) && Number(variant.price) > 0) {
                effectivePrice = Number(variant.price);
            }

            if (priceEl) priceEl.textContent = effectivePrice.toLocaleString('ar-DZ') + ' دج';
            if (oldEl) oldEl.textContent = product.oldPrice.toLocaleString('ar-DZ') + ' دج';
            if (discountEl) {
                const discount = Math.round((1 - effectivePrice / product.oldPrice) * 100);
                discountEl.textContent = `-${discount}%`;
            }

            // Update main image if variant has image
            if (variant && variant.image) {
                const mainImg = document.getElementById('mainProductImage');
                if (mainImg) mainImg.src = variant.image;
            }
        }

        function renderVariantSelectors(product) {
            const box = document.getElementById('variantSelectors');
            const fields = document.getElementById('variantSelectorsFields');
            const badge = document.getElementById('variantSelectedBadge');
            if (!box || !fields) return;

            const p = normalizeVariantsProductFields({ ...(product || {}) });
            if (!p.variants || !Array.isArray(p.variants.options) || !p.variants.options.length) {
                box.classList.add('hidden');
                if (badge) badge.classList.add('hidden');
                return;
            }

            box.classList.remove('hidden');
            if (badge) badge.classList.add('hidden');

            const options = p.variants.options;

            // Default selection: first value of each option
            currentSelectedOptions = {};
            options.forEach(o => {
                const v = Array.isArray(o.values) && o.values.length ? o.values[0] : '';
                if (o.name && v) currentSelectedOptions[o.name] = v;
            });

            // Render as chips/blocks instead of selects
            fields.innerHTML = options.map((o, idx) => {
                const values = Array.isArray(o.values) ? o.values : [];
                const optName = o.name || `Option ${idx + 1}`;
                const optNameEnc = encodeURIComponent(optName);
                return `
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-700">${sanitizeInput(optName)}</label>
                        <div class="flex flex-wrap gap-2" data-variant-group="${idx}" data-variant-name="${optNameEnc}">
                            ${values.map(v => {
                                const vEnc = encodeURIComponent(v);
                                const selected = (currentSelectedOptions[optName] === v) ? 'selected' : '';
                                return `<button type="button" class="variant-chip ${selected}" data-value="${vEnc}">${sanitizeInput(v)}</button>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Attach listeners for chips
            fields.querySelectorAll('[data-variant-group]').forEach(group => {
                const optName = decodeURIComponent(group.getAttribute('data-variant-name') || '');
                group.querySelectorAll('.variant-chip').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const val = decodeURIComponent(btn.getAttribute('data-value') || '');
                        // Update selection
                        currentSelectedOptions[optName] = val;

                        // Update UI
                        group.querySelectorAll('.variant-chip').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');

                        // Apply
                        applyVariantSelection(p, currentSelectedOptions);
                        // Confirmation step removed
                        setVariantConfirmationUI();
                    });
                });
            });

            // Apply selection once
            applyVariantSelection(p, currentSelectedOptions);
            // Confirmation step removed
            setVariantConfirmationUI();
        }

        function showTab(tabName, evt) {
            const buttons = Array.from(document.querySelectorAll('.tab-btn'));
            buttons.forEach(btn => {
                btn.classList.remove('active', 'text-purple-600', 'border-b-2', 'border-purple-600');
                btn.classList.add('text-gray-500');
            });

            let activeBtn = evt?.currentTarget || evt?.target || null;
            if (!activeBtn) {
                const idx = tabName === 'description' ? 0 : tabName === 'specs' ? 1 : 2;
                activeBtn = buttons[idx] || buttons[0] || null;
            }
            if (activeBtn) {
                activeBtn.classList.add('active', 'text-purple-600', 'border-b-2', 'border-purple-600');
                activeBtn.classList.remove('text-gray-500');
            }

            let content = '';
            if (tabName === 'description') {
                content = `<p class="text-gray-600 leading-relaxed">${currentProduct.description}</p>`;
            } else if (tabName === 'specs') {
                const specs = currentProduct.specs || {};
                content = `<div class="space-y-3">
                    ${Object.entries(specs).map(([key, value]) => `
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-semibold text-gray-700">${key}</span>
                            <span class="text-gray-600">${value}</span>
                        </div>
                    `).join('')}
                </div>`;
            } else if (tabName === 'reviews') {
                // Render loading state then load real reviews from Supabase
                document.getElementById('tabContent').innerHTML = `<div class="text-center text-gray-500 py-8"><div class="loading-spinner mx-auto mb-3"></div><p>جاري تحميل التقييمات...</p></div>`;
                (async () => {
                    try {
                        if (!currentProduct) return;
                        await loadReviewsForProduct(currentProduct.id);
                        renderReviewsTab(currentProduct);
                    } catch (e) {
                        console.error(e);
                        const msg = String(e?.message || '').toLowerCase();
                        const hint = (msg.includes('relation') && msg.includes('reviews'))
                            ? 'جدول reviews غير موجود. أنشئه من (الإعدادات → Supabase Database → إعداد جدول التقييمات Reviews)'
                            : 'تعذر تحميل التقييمات';
                        document.getElementById('tabContent').innerHTML = `<div class="text-center text-red-600 py-8"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p>${hint}</p></div>`;
                    }
                })();
                return;
            }
            document.getElementById('tabContent').innerHTML = content;
        }

        function loadRelatedProducts() {
            const related = products.filter(p => p.category === currentProduct.category && p.id !== currentProduct.id).slice(0, 4);
            document.getElementById('relatedProducts').innerHTML = related.map(product => {
                const discount = Math.round((1 - product.price / product.oldPrice) * 100);
                return `
                    <div class="product-card bg-white rounded-2xl overflow-hidden shadow-md cursor-pointer" onclick="viewProduct(${product.id})">
                        <div class="relative">
                            <img src="${product.images[0]}" alt="${product.name}" loading="lazy" decoding="async" class="w-full h-32 md:h-40 object-cover">
                            <span class="absolute top-2 left-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">-${discount}%</span>
                        </div>
                        <div class="p-3">
                            <h4 class="font-semibold text-gray-800 text-sm mb-2 line-clamp-1">${product.name}</h4>
                            <span class="text-lg font-bold text-green-600">${product.price.toLocaleString('ar-DZ')} دج</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function shareProduct(platform) {
            const url = window.location.href;
            const text = `${currentProduct.name} - ${currentProduct.price} دج`;
            let shareUrl = '';
            if (platform === 'facebook') shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            else if (platform === 'whatsapp') shareUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
            else if (platform === 'twitter') shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            window.open(shareUrl, '_blank');
        }

        function copyProductLink() {
            navigator.clipboard.writeText(window.location.href);
            showNotification('تم نسخ الرابط', 'success');
        }

        function getEffectiveProductPrice(product) {
            // If a variant is selected and has a price override, use it
            try {
                if (currentVariant && Number.isFinite(Number(currentVariant.price)) && Number(currentVariant.price) > 0) {
                    return Number(currentVariant.price);
                }
            } catch (_) {}
            return product.price;
        }

        function getVariantLabelFromSelection(selection) {
            try {
                if (!selection || typeof selection !== 'object') return '';
                const parts = Object.entries(selection)
                    .filter(([k, v]) => k && v)
                    .map(([k, v]) => `${k}: ${v}`);
                return parts.join(' | ');
            } catch (_) {
                return '';
            }
        }

        // ===== Variants confirmation (must confirm before buy/add) =====
        function requireVariantConfirmationForCurrentProduct() {
            try {
                const p = normalizeVariantsProductFields({ ...(currentProduct || {}) });
                return !!(p.variants && Array.isArray(p.variants.options) && p.variants.options.length);
            } catch (_) {
                return false;
            }
        }

        function setVariantConfirmationUI() {
            // Confirmation step removed: always allow buying/adding.
            variantConfirmationRequired = false;
            variantSelectionConfirmed = true;
            const buyBtn = document.getElementById('buyNowBtn');
            const cartBtn = document.getElementById('addToCartBtn');
            const hint = document.getElementById('variantConfirmHint');
            const confirmBtn = document.getElementById('confirmVariantsBtn');
            if (buyBtn) buyBtn.disabled = false;
            if (cartBtn) cartBtn.disabled = false;
            if (hint) hint.textContent = '';
            if (confirmBtn) confirmBtn.remove();
        }

        function guardVariantConfirmed() {
            return true;
        }

        function buyNowFromProduct() {
            if (!currentProduct) return;
            if (!guardVariantConfirmed()) return;
            const effectivePrice = getEffectiveProductPrice(currentProduct);
            const variantLabel = getVariantLabelFromSelection(currentSelectedOptions);

            // Store a lightweight cart item to avoid localStorage quota issues
            const img = currentVariant?.image || currentProduct?.images?.[0] || '';
            cart = [normalizeCartItem({
                id: currentProduct.id,
                name: currentProduct.name,
                price: effectivePrice,
                quantity: productQuantity,
                selectedOptions: { ...(currentSelectedOptions || {}) },
                variantKey: currentVariant?.key || '',
                variantLabel: variantLabel,
                image: img
            })].filter(Boolean);

            // Even if localStorage is full, proceed with checkout (cart remains in memory)
            try { saveCart(); } catch (_) {}
            updateCartCount();
            openOrderModal();
        }

        function addToCartFromProduct() {
            if (!currentProduct) return;
            if (!guardVariantConfirmed()) return;
            const effectivePrice = getEffectiveProductPrice(currentProduct);
            const variantKey = currentVariant?.key || '';
            const variantLabel = getVariantLabelFromSelection(currentSelectedOptions);
            const img = currentVariant?.image || currentProduct?.images?.[0] || '';

            // treat same product + same variantKey as same cart line
            const existing = cart.find(item => item.id === currentProduct.id && (item.variantKey || '') === variantKey);
            if (existing) {
                existing.quantity += productQuantity;
            } else {
                cart.push(normalizeCartItem({
                    id: currentProduct.id,
                    name: currentProduct.name,
                    price: effectivePrice,
                    quantity: productQuantity,
                    selectedOptions: { ...(currentSelectedOptions || {}) },
                    variantKey,
                    variantLabel,
                    image: img
                }));
            }

            // Even if localStorage is full, keep cart in memory
            try { saveCart(); } catch (_) {}
            updateCartCount();
            showNotification('تمت إضافة المنتج للسلة', 'success');
            
            // تتبع الإضافة للسلة
            trackAddToCart({ ...currentProduct, price: effectivePrice }, productQuantity);
        }

        // ==================== السلة ====================
        function saveCart() {
            // Always store a lightweight cart to avoid localStorage quota exceeded
            const normalized = (Array.isArray(cart) ? cart : []).map(normalizeCartItem).filter(Boolean);
            cart = normalized;
            const ok = safeStorageSet('cart', JSON.stringify(normalized));
            if (!ok) {
                // If still failing, keep cart in memory only
                console.warn('Could not persist cart to localStorage (quota). Cart will work for this session only.');
            }
        }
        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cartCount');
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
        }
        function openCart() { document.getElementById('cartModal').classList.remove('hidden'); renderCart(); }
        function closeCart() { document.getElementById('cartModal').classList.add('hidden'); }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const footer = document.getElementById('cartFooter');
            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-shopping-cart text-4xl mb-4"></i><p>السلة فارغة</p></div>';
                footer.innerHTML = '';
                return;
            }
            container.innerHTML = cart.map(item => `
                <div class="flex gap-3 p-3 bg-gray-50 rounded-xl mb-3">
                    <img src="${getCartItemImage(item)}" loading="lazy" decoding="async" class="w-16 h-16 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-semibold text-sm">${item.name}</h4>
                        ${item.variantLabel ? `<div class="text-xs text-gray-500 mt-0.5">${sanitizeInput(item.variantLabel)}</div>` : ''}
                        <p class="text-green-600 font-bold">${item.price.toLocaleString('ar-DZ')} دج</p>
                        <div class="flex items-center gap-2 mt-1">
                            <button onclick="updateCartQty(${item.id}, '${(item.variantKey || '').replace(/'/g,"\\'")}', -1)" class="w-6 h-6 rounded-full bg-gray-200">-</button>
                            <span class="font-semibold">${item.quantity}</span>
                            <button onclick="updateCartQty(${item.id}, '${(item.variantKey || '').replace(/'/g,"\\'")}', 1)" class="w-6 h-6 rounded-full bg-gray-200">+</button>
                            <button onclick="removeFromCart(${item.id}, '${(item.variantKey || '').replace(/'/g,"\\'")}')" class="mr-auto text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            footer.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <span class="font-bold">المجموع:</span>
                    <span class="text-xl font-bold text-purple-600">${total.toLocaleString('ar-DZ')} دج</span>
                </div>
                <button onclick="checkoutCart()" class="w-full py-3 gradient-btn text-white font-bold rounded-xl">إتمام الطلب</button>
            `;
        }

        function updateCartQty(id, variantKey = '', change) {
            const item = cart.find(i => i.id === id && (i.variantKey || '') === (variantKey || ''));
            if (item) {
                item.quantity = Math.max(1, item.quantity + change);
                try { saveCart(); } catch (_) {}
                // إذا كان نموذج الطلب مفتوحاً، حدّث Draft
                try { scheduleAbandonedDraftSave(); } catch (_) {}
                renderCart();
            }
        }
        function removeFromCart(id, variantKey = '') {
            cart = cart.filter(i => !(i.id === id && (i.variantKey || '') === (variantKey || '')));
            try { saveCart(); } catch (_) {}
            updateCartCount();
            // إذا كان نموذج الطلب مفتوحاً، حدّث Draft
            try { scheduleAbandonedDraftSave(); } catch (_) {}
            renderCart();
        }
        function checkoutCart() { if (cart.length === 0) { showNotification('السلة فارغة', 'error'); return; } closeCart(); openOrderModal(); }

        // ==================== نموذج الطلب ====================
        function openOrderModal() {
            document.getElementById('orderModal').classList.remove('hidden');
            document.getElementById('orderForm').reset();
            document.getElementById('orderForm').style.display = 'block';
            document.getElementById('orderSuccess').classList.add('hidden');
            document.getElementById('orderProductSection').style.display = 'block';

            // Reset submit button state (important after a previous order)
            const btn = document.getElementById('submitOrderBtn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i>\n                            تأكيد الطلب';
            }

            renderOrderProducts();
            initProvinces();

            // Abandoned cart: start tracking form typing (draft)
            attachAbandonedCartDraftListeners();
            // Save an initial draft if customer already has name/phone (rare)
            scheduleAbandonedDraftSave();
            
            // تتبع بدء الشراء
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            trackInitiateCheckout(cart, total);
        }
        function closeOrderModal() {
            // إذا أغلق الزبون نافذة الطلب قبل التأكيد، نحاول حفظ Draft كسلة متروكة
            try { upsertAbandonedCartDraft(); } catch (_) {}
            document.getElementById('orderModal').classList.add('hidden');
        }

        function renderOrderProducts() {
            document.getElementById('orderProductSection').innerHTML = cart.map(item => `
                <div class="flex gap-3 p-3 bg-gray-50 rounded-xl mb-2">
                    <img src="${getCartItemImage(item)}" loading="lazy" decoding="async" class="w-16 h-16 object-cover rounded-lg">
                    <div>
                        <h4 class="font-semibold text-sm">${item.name}</h4>
                        ${item.variantLabel ? `<div class="text-xs text-gray-500 mt-0.5">${sanitizeInput(item.variantLabel)}</div>` : ''}
                        <p class="text-green-600 font-bold">${item.price.toLocaleString('ar-DZ')} دج × ${item.quantity}</p>
                    </div>
                </div>
            `).join('');
            updateOrderSummary();
            // تحديث Draft بعد تحديث عرض المنتجات
            try { scheduleAbandonedDraftSave(); } catch (_) {}
        }

        function initProvinces() {
            const select = document.getElementById('province');
            select.innerHTML = '<option value="">-- اختر الولاية --</option>';
            for (let i = 1; i <= 58; i++) {
                if (algeriaData[i]) select.innerHTML += `<option value="${i}">${i} - ${algeriaData[i].name}</option>`;
            }
        }

        document.getElementById('province').addEventListener('change', function() {
            const code = this.value;
            if (code && algeriaData[code]) {
                document.getElementById('officePrice').textContent = algeriaData[code].office.toLocaleString('ar-DZ') + ' دج';
                document.getElementById('homePrice').textContent = algeriaData[code].home.toLocaleString('ar-DZ') + ' دج';
            } else {
                document.getElementById('officePrice').textContent = '-- دج';
                document.getElementById('homePrice').textContent = '-- دج';
            }
            updateOrderSummary();
        });

        document.querySelectorAll('.delivery-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input').checked = true;
                updateOrderSummary();
            });
        });

        function updateOrderSummary() {
            const provinceCode = document.getElementById('province').value;
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked');
            let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let deliveryPrice = 0;
            if (provinceCode && algeriaData[provinceCode] && deliveryType) {
                deliveryPrice = deliveryType.value === 'office' ? algeriaData[provinceCode].office : algeriaData[provinceCode].home;
            }
            document.getElementById('orderSummaryItems').innerHTML = `
                <div class="flex justify-between"><span>المنتجات:</span><span class="font-semibold">${subtotal.toLocaleString('ar-DZ')} دج</span></div>
                <div class="flex justify-between"><span>التوصيل:</span><span class="font-semibold">${deliveryPrice.toLocaleString('ar-DZ')} دج</span></div>
            `;
            document.getElementById('orderTotal').textContent = (subtotal + deliveryPrice).toLocaleString('ar-DZ') + ' دج';
        }

        function setSubmitOrderBtnLoading(isLoading) {
            const btn = document.getElementById('submitOrderBtn');
            if (!btn) return;
            if (isLoading) {
                btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
                btn.disabled = true;
            } else {
                btn.innerHTML = '<i class="fas fa-check-circle"></i>\n                            تأكيد الطلب';
                btn.disabled = false;
            }
        }

        function withTimeout(promise, ms, message = 'timeout') {
            let timer;
            const timeout = new Promise((_, reject) => {
                timer = setTimeout(() => reject(new Error(message)), ms);
            });
            return Promise.race([
                promise.finally(() => clearTimeout(timer)),
                timeout
            ]);
        }

        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            setSubmitOrderBtnLoading(true);

            try {
                const name = sanitizeInput(document.getElementById('customerName').value.trim());
                const phone = document.getElementById('customerPhone').value.trim();
                const email = document.getElementById('customerEmail').value.trim();
                const provinceCode = document.getElementById('province').value;
                const municipality = sanitizeInput(document.getElementById('municipality').value.trim());
                const address = sanitizeInput(document.getElementById('address').value.trim());
                const deliveryType = document.querySelector('input[name="deliveryType"]:checked');

                if (!validatePhone(phone)) {
                    showNotification('رقم الهاتف غير صحيح', 'error');
                    setSubmitOrderBtnLoading(false);
                    return;
                }
                if (!validateEmail(email)) {
                    showNotification('البريد غير صحيح', 'error');
                    setSubmitOrderBtnLoading(false);
                    return;
                }
                if (!provinceCode || !algeriaData[provinceCode]) {
                    showNotification('اختر الولاية', 'error');
                    setSubmitOrderBtnLoading(false);
                    return;
                }
                if (!deliveryType) {
                    showNotification('اختر نوع التوصيل', 'error');
                    setSubmitOrderBtnLoading(false);
                    return;
                }

                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const deliveryPrice = deliveryType.value === 'office' ? algeriaData[provinceCode].office : algeriaData[provinceCode].home;

                const order = {
                    id: generateOrderId(),
                    date: new Date().toISOString(),
                    customer: { name, phone, email },
                    address: { province: algeriaData[provinceCode].name, provinceCode, municipality, details: address, deliveryType: deliveryType.value === 'office' ? 'مكتب' : 'منزل' },
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        variantKey: item.variantKey || '',
                        variantLabel: item.variantLabel || '',
                        selectedOptions: item.selectedOptions || {},
                        image: safeImageForOrder(getCartItemImage(item))
                    })),
                    subtotal,
                    deliveryPrice,
                    total: subtotal + deliveryPrice,
                    status: 'pending'
                };

                // حفظ محلياً (Fallback) + حفظ أساسي في Supabase
                orders.unshift(order);
                localStorage.setItem('orders', JSON.stringify(orders));

                // نحاول حفظ الطلب في Supabase بسرعة (بدون انتظار طويل)
                try {
                    await withTimeout(saveOrderToSupabase(order), 3500, 'slow_network');
                } catch (err) {
                    // إذا كانت شبكة بطيئة: نكمل فوراً ونحاول إعادة الإرسال في الخلفية
                    if ((err?.message || '') === 'slow_network') {
                        console.warn('Order save is slow, continue UX and retry in background');
                        saveOrderToSupabase(order).catch(e => console.error('Background saveOrderToSupabase failed:', e));
                    } else {
                        console.error('saveOrderToSupabase failed:', err);
                        showNotification('تعذر إرسال الطلب حالياً. حاول مرة أخرى.', 'error');
                        setSubmitOrderBtnLoading(false);
                        return;
                    }
                }

                // ✅ نجاح فوري للمستخدم (بدون انتظار Google Sheets / EmailJS)
                document.getElementById('orderForm').style.display = 'none';
                document.getElementById('orderProductSection').style.display = 'none';
                document.getElementById('orderSuccess').classList.remove('hidden');
                document.getElementById('orderNumber').textContent = order.id;
                document.getElementById('orderConfirmationDetails').innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span>الاسم:</span><span class="font-semibold">${order.customer.name}</span></div>
                        <div class="flex justify-between"><span>الهاتف:</span><span class="font-semibold" dir="ltr">${order.customer.phone}</span></div>
                        <div class="flex justify-between"><span>الولاية:</span><span class="font-semibold">${order.address.province}</span></div>
                        <div class="flex justify-between text-lg font-bold text-purple-600"><span>المجموع:</span><span>${order.total.toLocaleString('ar-DZ')} دج</span></div>
                    </div>
                `;

                // تعليم السلة المتروكة (Draft) كمكتملة حتى لا تظهر في قائمة السلات المتروكة
                try { await markAbandonedCartCompleted(); } catch (_) {}

                // تنظيف السلة فوراً
                cart = [];
                try {
                    localStorage.removeItem('cart');
                } catch (_) {}
                try { saveCart(); } catch (_) {}
                updateCartCount();

                showNotification('تم تأكيد طلبك بنجاح!', 'success');

                // مهام خلفية (لا ننتظرها حتى لا يتأخر التأكيد)
                setTimeout(() => {
                    try { sendToGoogleSheets(order); } catch (e) { console.error(e); }
                    try { sendEmailNotification(order); } catch (e) { console.error(e); }
                    try { trackPurchase(order); } catch (e) { console.error(e); }
                    // ملاحظة: لا نفتح واتساب تلقائياً هنا حتى لا يحدث تأخير/حظر Popup.
                    // يمكن للمدير استعمال واتساب من لوحة التحكم، وللزبون سنعرض زر داخل شاشة النجاح.
                }, 0);

                // زر واتساب للزبون (اختياري) داخل شاشة النجاح
                const detailsBox = document.getElementById('orderConfirmationDetails');
                if (detailsBox) {
                    const waUrl = `https://wa.me/${settings.whatsapp}?text=${encodeURIComponent(`مرحبا، هذا طلبي رقم: ${order.id}\nالاسم: ${order.customer.name}\nالهاتف: ${order.customer.phone}\nالمجموع: ${order.total.toLocaleString('ar-DZ')} دج`)}`;
                    detailsBox.insertAdjacentHTML('beforeend', `
                        <div class="mt-4">
                            <a href="${waUrl}" target="_blank" rel="noopener" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600">
                                <i class="fab fa-whatsapp"></i>
                                إرسال تفاصيل الطلب عبر واتساب
                            </a>
                        </div>
                    `);
                }

            } catch (err) {
                console.error('Order submit error:', err);
                showNotification('حدث خطأ أثناء تأكيد الطلب', 'error');
                setSubmitOrderBtnLoading(false);
            }
        });

        async function sendToGoogleSheets(order) {
            if (!settings.sheetUrl) return;
            try {
                await fetch(settings.sheetUrl, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: order.id, date: new Date(order.date).toLocaleString('ar-DZ'),
                        customerName: order.customer.name, phone: order.customer.phone,
                        province: order.address.province, municipality: order.address.municipality,
                        deliveryType: order.address.deliveryType,
                        products: order.items.map(i => `${i.name} (×${i.quantity})`).join(' | '),
                        total: order.total, status: 'قيد الانتظار'
                    })
                });
            } catch (e) { console.error(e); }
        }

        async function sendEmailNotification(order) {
            if (!settings.emailJsKey || !settings.emailJsService || !settings.emailJsTemplate) return;
            try {
                emailjs.init(settings.emailJsKey);
                await emailjs.send(settings.emailJsService, settings.emailJsTemplate, {
                    order_id: order.id, customer_name: order.customer.name, customer_phone: order.customer.phone,
                    province: order.address.province, total: order.total.toLocaleString('ar-DZ') + ' دج'
                });
            } catch (e) { console.error(e); }
        }

        function sendWhatsAppNotification(order) {
            const message = `🛒 طلب جديد\n\n📋 رقم: ${order.id}\n👤 ${order.customer.name}\n📞 ${order.customer.phone}\n📍 ${order.address.province} - ${order.address.municipality}\n💰 ${order.total.toLocaleString('ar-DZ')} دج`;
            window.open(`https://wa.me/${settings.whatsapp}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // ==================== تتبع الطلب ====================
        async function trackOrder() {
            const orderId = document.getElementById('trackOrderId').value.trim();
            const phone = document.getElementById('trackPhone').value.trim();
            const resultDiv = document.getElementById('trackResult');
            const statusLabels = { pending: 'قيد الانتظار', confirmed: 'مؤكد', shipped: 'تم الشحن', delivered: 'تم التوصيل', cancelled: 'ملغي' };

            let order = orders.find(o => o.id === orderId && (o.customer?.phone || '') === phone);

            // إذا لم يكن موجوداً محلياً، اجلبه من Supabase بطريقة آمنة
            if (!order && supabaseReady && supabaseClient && orderId) {
                // 1) المحاولة الأفضل: RPC آمنة track_order (مستحسن مع RLS)
                try {
                    const { data, error } = await supabaseClient.rpc('track_order', {
                        order_id: orderId,
                        phone: phone
                    });
                    if (!error && data) {
                        order = {
                            id: data.id,
                            date: data.date || data.created_at || new Date().toISOString(),
                            customer: data.customer || {},
                            address: data.address || {},
                            items: data.items || [],
                            subtotal: data.subtotal ?? 0,
                            deliveryPrice: data.delivery_price ?? data.deliveryPrice ?? 0,
                            total: data.total ?? 0,
                            status: data.status || 'pending'
                        };
                    }
                } catch (e) {
                    // ignore, fallback to direct select
                }

                // 2) fallback: direct select (قد يفشل إذا كانت سياسات RLS تمنع القراءة العامة)
                if (!order) {
                    try {
                        const { data, error } = await supabaseClient
                            .from('orders')
                            .select('*')
                            .eq('id', orderId)
                            .limit(1);
                        if (!error && data && data.length) {
                            const row = data[0];
                            const mapped = {
                                id: row.id,
                                date: row.created_at || new Date().toISOString(),
                                customer: row.customer || {},
                                address: row.address || {},
                                items: row.items || [],
                                subtotal: row.subtotal ?? 0,
                                deliveryPrice: row.delivery_price ?? 0,
                                total: row.total ?? 0,
                                status: row.status || 'pending'
                            };
                            if ((mapped.customer?.phone || '') === phone) {
                                order = mapped;
                            }
                        }
                    } catch (e) {
                        console.error(e);
                    }
                }
            }

            if (order) {
                resultDiv.innerHTML = `<div class="bg-gray-50 rounded-xl p-4"><p class="font-bold">${order.id}</p><p>الحالة: ${statusLabels[order.status] || order.status}</p><p>المجموع: ${order.total.toLocaleString('ar-DZ')} دج</p></div>`;
            } else {
                resultDiv.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-xl text-center">لم يتم العثور على الطلب</div>`;
            }
            resultDiv.classList.remove('hidden');
        }

        // ==================== لوحة التحكم (Supabase Auth) ====================
        function getAdminEmailsAllowlist() {
            // ضع الإيميلات المسموحة هنا (أو اتركها فارغة وسيتم السماح لكل من يسجل دخول عبر Supabase)
            // مثال: return ['admin@yourdomain.com'];
            return (settings.adminEmails || []).map(e => (e || '').toLowerCase().trim()).filter(Boolean);
        }

        function isAllowedAdminEmail(email) {
            const allowlist = getAdminEmailsAllowlist();
            if (!allowlist.length) return true; // إذا لم تحدد قائمة، نسمح لأي حساب تم تسجيل دخوله (للتجربة)
            return allowlist.includes((email || '').toLowerCase().trim());
        }

        let privateSettingsLoaded = false;

        async function refreshAdminSession() {
            if (!supabaseReady || !supabaseClient) return false;
            try {
                const { data, error } = await supabaseClient.auth.getSession();
                if (error) throw error;
                const email = data?.session?.user?.email || '';
                isAdmin = !!data?.session && isAllowedAdminEmail(email);

                // ✅ إذا أصبح Admin: حمّل private settings مرة واحدة
                if (isAdmin && !privateSettingsLoaded) {
                    privateSettingsLoaded = true;
                    try {
                        await loadStoreSettingsFromSupabase({ includePrivate: true });
                        // إعادة التهيئة
                        updateWhatsAppButton();
                        updateFooterSocialLinks();
                        updateFooterInfo();
                        initializePixels({ immediate: true });
                    } catch (e) {
                        console.warn('Could not load private settings during refreshAdminSession');
                    }
                }

                return isAdmin;
            } catch (e) {
                console.error('refreshAdminSession error:', e);
                isAdmin = false;
                privateSettingsLoaded = false;
                return false;
            }
        }

        async function showAdminLogin() {
            try {
                await refreshAdminSession();
            } catch (e) {
                console.error('showAdminLogin refresh error:', e);
            }
            if (isAdmin) { showPage('admin'); return; }
            const modal = document.getElementById('adminLoginModal');
            if (modal) modal.classList.remove('hidden');
            else showNotification('تعذر فتح نافذة تسجيل الدخول (adminLoginModal غير موجود)', 'error');
        }

        function closeAdminLogin() { document.getElementById('adminLoginModal').classList.add('hidden'); }

        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!supabaseReady || !supabaseClient) {
                showNotification('Supabase غير جاهز، تحقق من الإعدادات', 'error');
                return;
            }

            const email = (document.getElementById('adminEmail').value || '').trim();
            const password = document.getElementById('adminPassword').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                const loggedEmail = data?.user?.email || email;
                if (!isAllowedAdminEmail(loggedEmail)) {
                    // سجّل خروج فوري إذا ليس ضمن القائمة
                    await supabaseClient.auth.signOut();
                    isAdmin = false;
                    showNotification('هذا الحساب غير مخوّل للدخول', 'error');
                    return;
                }

                isAdmin = true;

                // ✅ بعد تسجيل دخول الأدمن: حمّل إعدادات private (Tokens) إن كانت محفوظة في Supabase
                try {
                    await loadStoreSettingsFromSupabase({ includePrivate: true });
                    // إعادة التهيئة بعد تحميل الإعدادات
                    updateWhatsAppButton();
                    updateFooterSocialLinks();
                    updateFooterInfo();
                    initializePixels({ immediate: true });
                } catch (e) {
                    console.warn('Could not load private store settings after admin login');
                }

                closeAdminLogin();
                showPage('admin');
                loadAdminData();
                showNotification('مرحباً بك', 'success');
            } catch (err) {
                console.error(err);
                showNotification('فشل تسجيل الدخول: تحقق من البريد وكلمة المرور', 'error');
            }
        });

        async function logoutAdmin() {
            try {
                if (supabaseReady && supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
            } catch (e) {
                console.error('logout error:', e);
            }
            isAdmin = false;
            showPage('home');
            showNotification('تم تسجيل الخروج', 'info');
        }

        function showAdminTab(tab, evt) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            const target = evt?.currentTarget || evt?.target || null;
            if (target) target.classList.add('active');

            document.getElementById('ordersTab').classList.toggle('hidden', tab !== 'orders');
            document.getElementById('abandonedTab').classList.toggle('hidden', tab !== 'abandoned');
            document.getElementById('productsTab').classList.toggle('hidden', tab !== 'products');
            document.getElementById('categoriesTab').classList.toggle('hidden', tab !== 'categories');

            if (tab === 'products') renderAdminProducts();
            if (tab === 'categories') renderCategories();
            if (tab === 'abandoned') {
                // تحميل السلات المتروكة عند فتح التبويب
                refreshAbandonedCarts();
            }
        }

        // ==================== إدارة التصنيفات ====================
        function saveCategories() {
            localStorage.setItem('storeCategories', JSON.stringify(categories));
        }

        async function syncCategory(category) {
            try {
                await saveCategoryToSupabase(category);
            } catch (e) {
                console.error(e);
            }
        }

        function renderCategories() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = categories.map(cat => `
                <div class="bg-gray-50 rounded-xl p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas ${cat.icon} text-xl text-purple-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800">${cat.name}</h4>
                            <p class="text-sm text-gray-500">${cat.id}</p>
                            <p class="text-xs text-gray-400">${products.filter(p => p.category === cat.id).length} منتج</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCategory('${cat.id}')" class="p-2 text-blue-500 hover:bg-blue-100 rounded-lg">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory('${cat.id}')" class="p-2 text-red-500 hover:bg-red-100 rounded-lg">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openCategoryModal() {
            document.getElementById('categoryModal').classList.remove('hidden');
            document.getElementById('categoryForm').reset();
            document.getElementById('editCategoryId').value = '';
            document.getElementById('categoryModalTitle').innerHTML = '<i class="fas fa-plus ml-2"></i>إضافة تصنيف جديد';
            selectedCategoryIcon = '';
            document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
        }

        function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            openCategoryModal();
            document.getElementById('categoryModalTitle').innerHTML = '<i class="fas fa-edit ml-2"></i>تعديل التصنيف';
            document.getElementById('editCategoryId').value = category.id;
            document.getElementById('categoryNameAr').value = category.name;
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryId').disabled = true; // لا يمكن تغيير المعرف
            
            // Select the icon
            selectedCategoryIcon = category.icon;
            document.querySelectorAll('.icon-option').forEach(opt => {
                if (opt.dataset.icon === category.icon) {
                    opt.classList.add('selected');
                }
            });
        }

        function deleteCategory(categoryId) {
            const productsInCategory = products.filter(p => p.category === categoryId).length;
            if (productsInCategory > 0) {
                showNotification(`لا يمكن حذف التصنيف لأنه يحتوي على ${productsInCategory} منتج`, 'error');
                return;
            }
            if (confirm('هل أنت متأكد من حذف هذا التصنيف؟')) {
                categories = categories.filter(c => c.id !== categoryId);
                saveCategories();
                renderCategories();
                renderCategoryButtons();
                updateProductCategoryOptions();
                showNotification('تم حذف التصنيف', 'success');
            }
        }

        // Icon selector event listeners
        document.querySelectorAll('.icon-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedCategoryIcon = this.dataset.icon;
            });
        });

        // Category form submit
        document.getElementById('categoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const editId = document.getElementById('editCategoryId').value;
            const nameAr = document.getElementById('categoryNameAr').value.trim();
            const id = document.getElementById('categoryId').value.trim().toLowerCase().replace(/\s+/g, '-');
            
            if (!selectedCategoryIcon) {
                showNotification('اختر أيقونة للتصنيف', 'error');
                return;
            }

            let savedCategory = null;

            if (editId) {
                // Update existing category
                const index = categories.findIndex(c => c.id === editId);
                if (index !== -1) {
                    categories[index] = { ...categories[index], name: nameAr, icon: selectedCategoryIcon };
                    savedCategory = categories[index];
                    showNotification('تم تحديث التصنيف', 'success');
                }
            } else {
                // Check if ID already exists
                if (categories.find(c => c.id === id)) {
                    showNotification('معرف التصنيف موجود مسبقاً', 'error');
                    return;
                }
                // Add new category
                savedCategory = { id, name: nameAr, icon: selectedCategoryIcon };
                categories.push(savedCategory);
                showNotification('تم إضافة التصنيف', 'success');
            }

            saveCategories();
            await syncCategory(savedCategory);

            closeCategoryModal();
            renderCategories();
            renderCategoryButtons();
            updateProductCategoryOptions();
            document.getElementById('categoryId').disabled = false;
        });

        function renderCategoryButtons() {
            const container = document.querySelector('#homePage section.py-6 .flex.gap-3') || document.querySelector('.category-btn')?.parentElement;
            if (!container) return;
            container.innerHTML = `
                <button class="category-btn active flex-shrink-0 px-5 py-2 rounded-full border-2 border-purple-500 font-semibold transition-all" data-category="all">
                    <i class="fas fa-th-large ml-2"></i>الكل
                </button>
                ${(categories || []).map(cat => `
                    <button class="category-btn flex-shrink-0 px-5 py-2 rounded-full border-2 border-gray-200 font-semibold transition-all hover:border-purple-500" data-category="${cat.id}">
                        <i class="fas ${cat.icon} ml-2"></i>${cat.name}
                    </button>
                `).join('')}
            `;
            
            // Re-attach event listeners
            container.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    container.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    renderProducts(this.dataset.category);
                });
            });
        }

        function updateProductCategoryOptions() {
            const select = document.getElementById('productCategoryInput');
            select.innerHTML = `
                <option value="">-- اختر التصنيف --</option>
                ${categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
            `;
        }

        function loadAdminData() {
            document.getElementById('statTotal').textContent = orders.length;
            document.getElementById('statPending').textContent = orders.filter(o => o.status === 'pending').length;
            document.getElementById('statDelivered').textContent = orders.filter(o => o.status === 'delivered').length;
            document.getElementById('statRevenue').textContent = orders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.total, 0).toLocaleString('ar-DZ');
            renderOrdersTable();
        }

        function renderOrdersTable(filtered = null) {
            const data = filtered || orders;
            const statusLabels = { pending: { text: 'قيد الانتظار', class: 'bg-yellow-100 text-yellow-800' }, confirmed: { text: 'مؤكد', class: 'bg-green-100 text-green-800' }, shipped: { text: 'تم الشحن', class: 'bg-blue-100 text-blue-800' }, delivered: { text: 'تم التوصيل', class: 'bg-green-100 text-green-800' }, cancelled: { text: 'ملغي', class: 'bg-red-100 text-red-800' } };
            document.getElementById('ordersTableBody').innerHTML = data.sort((a, b) => new Date(b.date) - new Date(a.date)).map(order => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-mono text-sm">${order.id}</td>
                    <td class="px-4 py-3"><div class="font-semibold">${order.customer.name}</div><div class="text-xs text-gray-500" dir="ltr">${order.customer.phone}</div></td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <div class="flex -space-x-2 space-x-reverse">
                                ${order.items.slice(0, 3).map(i => `
                                    <img src="${getOrderItemImage(i)}" 
                                         alt="${i.name}" 
                                         class="w-10 h-10 rounded-lg border-2 border-white object-cover shadow-sm"
                                         loading="lazy" decoding="async"
                                         onerror="this.src='${NO_IMAGE_PLACEHOLDER}'"
                                         title="${i.name} (×${i.quantity})">
                                `).join('')}
                                ${order.items.length > 3 ? `<div class="w-10 h-10 rounded-lg border-2 border-white bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">+${order.items.length - 3}</div>` : ''}
                            </div>
                            <div class="text-sm text-gray-600">${order.items.length} منتج</div>
                        </div>
                    </td>
                    <td class="px-4 py-3 font-bold text-green-600">${order.total.toLocaleString('ar-DZ')} دج</td>
                    <td class="px-4 py-3">
                        <select onchange="updateOrderStatus('${order.id}', this.value)" class="text-xs px-2 py-1 rounded-full ${statusLabels[order.status].class}">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>مؤكد</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>تم الشحن</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>تم التوصيل</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ملغي</option>
                        </select>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">${new Date(order.date).toLocaleDateString('ar-DZ')}</td>
                    <td class="px-4 py-3">
                        <button onclick="viewOrderDetails('${order.id}')" class="text-blue-500 hover:text-blue-700 ml-2"><i class="fas fa-eye"></i></button>
                        <button onclick="deleteOrder('${order.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateOrderStatus(orderId, status) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            order.status = status;
            localStorage.setItem('orders', JSON.stringify(orders));
            await updateOrderStatusSupabase(orderId, status);
            loadAdminData();
            showNotification('تم التحديث', 'success');
        }

        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            const statusLabels = { pending: 'قيد الانتظار', confirmed: 'مؤكد', shipped: 'تم الشحن', delivered: 'تم التوصيل', cancelled: 'ملغي' };
            document.getElementById('orderDetailsContent').innerHTML = `
                <div class="space-y-4">
                    <!-- معلومات الطلب -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">رقم الطلب</p>
                                <p class="font-bold text-purple-600">${order.id}</p>
                            </div>
                            <div class="text-left">
                                <p class="text-sm text-gray-500">التاريخ</p>
                                <p class="font-semibold">${new Date(order.date).toLocaleString('ar-DZ')}</p>
                            </div>
                        </div>
                    </div>

                    <!-- المنتجات مع الصور -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-box text-purple-600"></i>
                            المنتجات (${order.items.length})
                        </h4>
                        <div class="space-y-3">
                            ${order.items.map(item => `
                                <div class="flex items-center gap-3 bg-white rounded-lg p-3 shadow-sm">
                                    <img src="${getOrderItemImage(item)}" 
                                         alt="${item.name}" 
                                         class="w-16 h-16 rounded-lg object-cover border"
                                         loading="lazy" decoding="async"
                                         onerror="this.src='${NO_IMAGE_PLACEHOLDER}'">
                                    <div class="flex-1">
                                        <h5 class="font-semibold text-gray-800">${item.name}</h5>
                                        ${item.variantLabel ? `<div class="text-xs text-gray-500 mt-0.5">${sanitizeInput(item.variantLabel)}</div>` : ''}
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="text-green-600 font-bold">${item.price.toLocaleString('ar-DZ')} دج</span>
                                            <span class="text-gray-400">×</span>
                                            <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full text-xs font-bold">${item.quantity}</span>
                                        </div>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-sm text-gray-500">المجموع</p>
                                        <p class="font-bold text-green-600">${(item.price * item.quantity).toLocaleString('ar-DZ')} دج</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- معلومات العميل -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-user text-blue-600"></i>
                            معلومات العميل
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <p class="text-sm text-gray-500">الاسم</p>
                                <p class="font-semibold">${order.customer.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">الهاتف</p>
                                <p class="font-semibold" dir="ltr">${order.customer.phone}</p>
                            </div>
                            ${order.customer.email ? `
                            <div class="col-span-2">
                                <p class="text-sm text-gray-500">البريد الإلكتروني</p>
                                <p class="font-semibold" dir="ltr">${order.customer.email}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- عنوان التوصيل -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-green-600"></i>
                            عنوان التوصيل
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <p class="text-sm text-gray-500">الولاية</p>
                                <p class="font-semibold">${order.address.province}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">البلدية</p>
                                <p class="font-semibold">${order.address.municipality}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">نوع التوصيل</p>
                                <p class="font-semibold">
                                    <i class="fas fa-${order.address.deliveryType === 'منزل' ? 'home text-green-500' : 'building text-orange-500'} ml-1"></i>
                                    ${order.address.deliveryType}
                                </p>
                            </div>
                            ${order.address.details ? `
                            <div>
                                <p class="text-sm text-gray-500">التفاصيل</p>
                                <p class="font-semibold">${order.address.details}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- ملخص الأسعار -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                        <h4 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-receipt text-green-600"></i>
                            ملخص الطلب
                        </h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">المنتجات:</span>
                                <span class="font-semibold">${(order.subtotal ?? order.subtotal_amount ?? null) !== null ? Number(order.subtotal ?? order.subtotal_amount).toLocaleString('ar-DZ') : order.total.toLocaleString('ar-DZ')} دج</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">التوصيل:</span>
                                <span class="font-semibold">${Number(order.deliveryPrice ?? order.delivery_price ?? 0).toLocaleString('ar-DZ')} دج</span>
                            </div>
                            <div class="border-t border-green-200 pt-2 flex justify-between">
                                <span class="font-bold text-lg">المجموع الكلي:</span>
                                <span class="font-bold text-xl text-green-600">${order.total.toLocaleString('ar-DZ')} دج</span>
                            </div>
                        </div>
                    </div>

                    <!-- أزرار الإجراءات -->
                    <div class="flex gap-2">
                        <a href="https://wa.me/${settings.whatsapp || '213555123456'}?text=${encodeURIComponent(`مرحباً، أريد الاستفسار عن الطلب رقم: ${order.id}`)}" 
                           target="_blank"
                           class="flex-1 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 text-center">
                            <i class="fab fa-whatsapp ml-2"></i>تواصل واتساب
                        </a>
                        <button onclick="window.print()" class="flex-1 py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600">
                            <i class="fas fa-print ml-2"></i>طباعة
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('orderDetailsModal').classList.remove('hidden');
        }
        function closeOrderDetails() { document.getElementById('orderDetailsModal').classList.add('hidden'); }
        async function deleteOrder(orderId) {
            if (!confirm('حذف هذا الطلب؟')) return;
            try {
                orders = orders.filter(o => o.id !== orderId);
                localStorage.setItem('orders', JSON.stringify(orders));
                if (supabaseReady && supabaseClient) {
                    const { error } = await supabaseClient.from('orders').delete().eq('id', orderId);
                    if (error) console.error('Delete order error:', error);
                }
                loadAdminData();
                showNotification('تم الحذف', 'success');
            } catch (e) {
                console.error(e);
                showNotification('فشل حذف الطلب', 'error');
            }
        }
        function filterOrders() {
            let filtered = orders;
            const status = document.getElementById('filterStatus').value;
            const date = document.getElementById('filterDate').value;
            if (status !== 'all') filtered = filtered.filter(o => o.status === status);
            if (date) filtered = filtered.filter(o => o.date.startsWith(date));
            renderOrdersTable(filtered);
        }
        function exportOrders() {
            let csv = 'رقم الطلب,العميل,الهاتف,الولاية,المجموع,الحالة\n';
            orders.forEach(o => { csv += `${o.id},${o.customer.name},${o.customer.phone},${o.address.province},${o.total},${o.status}\n`; });
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('تم التصدير', 'success');
        }

        // ==================== إدارة المنتجات ====================
        function renderAdminProducts() {
            document.getElementById('statProducts').textContent = products.length;
            document.getElementById('statElectronics').textContent = products.filter(p => p.category === 'electronics').length;
            document.getElementById('statFashion').textContent = products.filter(p => p.category === 'fashion').length;
            document.getElementById('statOther').textContent = products.filter(p => !['electronics', 'fashion'].includes(p.category)).length;

            document.getElementById('adminProductsGrid').innerHTML = products.map(product => `
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="relative">
                        <img src="${product.images[0]}" alt="${product.name}" loading="lazy" decoding="async" class="w-full h-48 object-cover" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27400%27%20height%3D%27400%27%3E%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27%23e5e7eb%27/%3E%3Ctext%20x%3D%2750%25%27%20y%3D%2750%25%27%20dominant-baseline%3D%27middle%27%20text-anchor%3D%27middle%27%20fill%3D%27%236b7280%27%20font-family%3D%27Arial%27%20font-size%3D%2724%27%3ENo%20Image%3C/text%3E%3C/svg%3E'">
                        ${product.badge ? `<span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">${product.badge}</span>` : ''}
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-gray-800 mb-2">${product.name}</h4>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg font-bold text-green-600">${product.price.toLocaleString('ar-DZ')} دج</span>
                            <span class="text-sm text-gray-400 line-through">${product.oldPrice.toLocaleString('ar-DZ')} دج</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editProduct(${product.id})" class="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fas fa-edit ml-1"></i>تعديل
                            </button>
                            <button onclick="deleteProduct(${product.id})" class="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash ml-1"></i>حذف
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openProductModal(productId = null) {
            document.getElementById('productModal').classList.remove('hidden');
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = '';
            document.getElementById('imagePreviewContainer').innerHTML = '';
            document.getElementById('imageUrlInputs').innerHTML = `
                <div class="flex gap-2">
                    <input type="url" placeholder="رابط الصورة 1" dir="ltr" class="image-url-input flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-left">
                    <button type="button" onclick="addImageUrlInput()" class="px-4 py-2 bg-purple-100 text-purple-600 rounded-xl hover:bg-purple-200"><i class="fas fa-plus"></i></button>
                </div>
            `;
            document.getElementById('specsContainer').innerHTML = `
                <div class="flex gap-2 spec-row">
                    <input type="text" placeholder="المواصفة" class="spec-key flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl">
                    <input type="text" placeholder="القيمة" class="spec-value flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl">
                    <button type="button" onclick="addSpecRow()" class="px-4 py-2 bg-purple-100 text-purple-600 rounded-xl"><i class="fas fa-plus"></i></button>
                </div>
            `;
            uploadedImages = [];
            document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-plus ml-2"></i>إضافة منتج جديد';
        }

        function closeProductModal() { document.getElementById('productModal').classList.add('hidden'); }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            openProductModal();
            document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-edit ml-2"></i>تعديل المنتج';
            document.getElementById('editProductId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPriceInput').value = product.price;
            document.getElementById('productOldPriceInput').value = product.oldPrice;
            document.getElementById('productCategoryInput').value = product.category;
            document.getElementById('productBadgeInput').value = product.badge || '';
            document.getElementById('productDescInput').value = product.description;

            // Load variants into UI (if any)
            try {
                const p = normalizeVariantsProductFields({ ...(product || {}) });
                if (p.variants?.options?.length) {
                    const o1 = p.variants.options[0] || {};
                    const o2 = p.variants.options[1] || {};
                    const o1n = document.getElementById('variantOpt1Name');
                    const o1v = document.getElementById('variantOpt1Values');
                    const o2n = document.getElementById('variantOpt2Name');
                    const o2v = document.getElementById('variantOpt2Values');
                    if (o1n) o1n.value = o1.name || '';
                    if (o1v) o1v.value = Array.isArray(o1.values) ? o1.values.join(', ') : '';
                    if (o2n) o2n.value = o2.name || '';
                    if (o2v) o2v.value = Array.isArray(o2.values) ? o2.values.join(', ') : '';

                    variantOptionsDraft = p.variants.options;
                    variantsDraft = Array.isArray(p.variants.items) ? p.variants.items.map(it => ({
                        key: String(it.key || ''),
                        options: it.options || {},
                        price: (it.price === null || typeof it.price === 'undefined') ? null : Number(it.price),
                        stock: (it.stock === null || typeof it.stock === 'undefined') ? null : Number(it.stock),
                        image: String(it.image || '')
                    })) : [];

                    renderVariantsTable();
                    const box = document.getElementById('variantsPreview');
                    if (box) box.classList.remove('hidden');

                    // Fill JSON textarea
                    const j = document.getElementById('variantsJsonInput');
                    if (j) j.value = JSON.stringify({ options: variantOptionsDraft, items: variantsDraft }, null, 2);
                } else {
                    // reset drafts
                    variantOptionsDraft = null;
                    variantsDraft = [];
                    const box = document.getElementById('variantsPreview');
                    if (box) box.classList.add('hidden');
                    const j = document.getElementById('variantsJsonInput');
                    if (j) j.value = '';
                }
            } catch (_) {}

            // Load images
            document.getElementById('imageUrlInputs').innerHTML = '';
            product.images.forEach((img, index) => {
                document.getElementById('imageUrlInputs').innerHTML += `
                    <div class="flex gap-2">
                        <input type="url" value="${img}" placeholder="رابط الصورة ${index + 1}" dir="ltr" class="image-url-input flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl text-left">
                        <button type="button" onclick="${index === 0 ? 'addImageUrlInput()' : 'this.parentElement.remove()'}" class="px-4 py-2 bg-purple-100 text-purple-600 rounded-xl">
                            <i class="fas fa-${index === 0 ? 'plus' : 'times'}"></i>
                        </button>
                    </div>
                `;
            });

            // Load specs
            const specs = product.specs || {};
            const specsEntries = Object.entries(specs);
            document.getElementById('specsContainer').innerHTML = '';
            specsEntries.forEach(([key, value], index) => {
                document.getElementById('specsContainer').innerHTML += `
                    <div class="flex gap-2 spec-row">
                        <input type="text" value="${key}" placeholder="المواصفة" class="spec-key flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl">
                        <input type="text" value="${value}" placeholder="القيمة" class="spec-value flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl">
                        <button type="button" onclick="${index === 0 ? 'addSpecRow()' : 'this.parentElement.remove()'}" class="px-4 py-2 bg-purple-100 text-purple-600 rounded-xl">
                            <i class="fas fa-${index === 0 ? 'plus' : 'times'}"></i>
                        </button>
                    </div>
                `;
            });
            if (specsEntries.length === 0) addSpecRow();
        }

        function addImageUrlInput() {
            const container = document.getElementById('imageUrlInputs');
            const count = container.querySelectorAll('.image-url-input').length + 1;
            container.innerHTML += `
                <div class="flex gap-2">
                    <input type="url" placeholder="رابط الصورة ${count}" dir="ltr" class="image-url-input flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl text-left">
                    <button type="button" onclick="this.parentElement.remove()" class="px-4 py-2 bg-red-100 text-red-600 rounded-xl"><i class="fas fa-times"></i></button>
                </div>
            `;
        }

        function addSpecRow() {
            document.getElementById('specsContainer').innerHTML += `
                <div class="flex gap-2 spec-row">
                    <input type="text" placeholder="المواصفة" class="spec-key flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl">
                    <input type="text" placeholder="القيمة" class="spec-value flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl">
                    <button type="button" onclick="this.parentElement.remove()" class="px-4 py-2 bg-red-100 text-red-600 rounded-xl"><i class="fas fa-times"></i></button>
                </div>
            `;
        }

        // Image upload handling
        const dropZone = document.getElementById('imageDropZone');
        const imageInput = document.getElementById('imageInput');

        dropZone.addEventListener('click', () => imageInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
        imageInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            Array.from(files).slice(0, 5 - uploadedImages.length).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImages.push(e.target.result);
                    renderImagePreviews();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderImagePreviews() {
            document.getElementById('imagePreviewContainer').innerHTML = uploadedImages.map((img, index) => `
                <div class="image-preview w-20 h-20 rounded-lg overflow-hidden">
                    <img src="${img}" class="w-full h-full object-cover">
                    <button type="button" onclick="removeUploadedImage(${index})" class="remove-btn w-6 h-6 bg-red-500 text-white rounded-full text-xs">×</button>
                </div>
            `).join('');
        }

        function removeUploadedImage(index) {
            uploadedImages.splice(index, 1);
            renderImagePreviews();
        }

        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const editId = document.getElementById('editProductId').value;
            const name = sanitizeInput(document.getElementById('productName').value.trim());
            const price = parseInt(document.getElementById('productPriceInput').value);
            const oldPrice = parseInt(document.getElementById('productOldPriceInput').value);
            const category = document.getElementById('productCategoryInput').value;
            const badge = document.getElementById('productBadgeInput').value;
            const description = sanitizeInput(document.getElementById('productDescInput').value.trim());

            // Get images from URL inputs
            const imageUrls = Array.from(document.querySelectorAll('.image-url-input'))
                .map(input => input.value.trim())
                .filter(url => url);

            // Combine with uploaded images
            const images = [...uploadedImages, ...imageUrls];
            if (images.length === 0) {
                showNotification('أضف صورة واحدة على الأقل', 'error');
                return;
            }

            // Get specs
            const specs = {};
            document.querySelectorAll('.spec-row').forEach(row => {
                const key = row.querySelector('.spec-key').value.trim();
                const value = row.querySelector('.spec-value').value.trim();
                if (key && value) specs[key] = value;
            });

            // Get variants (from JSON textarea if provided, else from drafts)
            let variants = null;
            try {
                const jsonEl = document.getElementById('variantsJsonInput');
                const raw = (jsonEl?.value || '').trim();
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (parsed && typeof parsed === 'object' && Array.isArray(parsed.options) && parsed.options.length) {
                        variants = {
                            options: parsed.options,
                            items: Array.isArray(parsed.items) ? parsed.items : []
                        };
                    }
                } else if (variantOptionsDraft && Array.isArray(variantOptionsDraft) && variantOptionsDraft.length) {
                    variants = {
                        options: variantOptionsDraft,
                        items: Array.isArray(variantsDraft) ? variantsDraft : []
                    };
                }
            } catch (e) {
                showNotification('خيارات المنتج (Variants) تحتوي JSON غير صالح', 'error');
                return;
            }

            let savedProduct = null;

            if (editId) {
                // Update existing product
                const index = products.findIndex(p => p.id === parseInt(editId));
                if (index !== -1) {
                    products[index] = normalizeVariantsProductFields({ ...products[index], name, price, oldPrice, category, badge, description, images, specs, variants });
                    savedProduct = products[index];
                    showNotification('تم تحديث المنتج', 'success');
                }
            } else {
                // Add new product
                savedProduct = normalizeVariantsProductFields({
                    id: getNextProductId(),
                    name, price, oldPrice, category, badge, description, images, specs, variants
                });
                products.push(savedProduct);
                showNotification('تم إضافة المنتج', 'success');
            }

            saveProducts();
            // sync to Supabase
            await syncProduct(savedProduct);

            closeProductModal();
            renderAdminProducts();
            renderProducts();
        });

        async function deleteProduct(productId) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                products = products.filter(p => p.id !== productId);
                saveProducts();
                await deleteProductFromSupabase(productId);
                renderAdminProducts();
                renderProducts();
                showNotification('تم حذف المنتج', 'success');
            }
        }

        // ==================== Supabase ====================
        function initSupabase() {
            try {
                if (!SUPABASE_CONFIG?.url || !SUPABASE_CONFIG?.anonKey) {
                    console.warn('Supabase: missing config');
                    supabaseReady = false;
                    return false;
                }
                supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                supabaseReady = true;
                console.log('Supabase initialized successfully');
                return true;
            } catch (e) {
                console.error('Supabase init error:', e);
                supabaseReady = false;
                return false;
            }
        }

        // تحويل شكل المنتج من قاعدة البيانات إلى شكل الواجهة
        function mapProductFromDb(row) {
            if (!row) return null;
            const p = {
                id: row.id,
                name: row.name,
                price: row.price,
                oldPrice: row.old_price ?? row.oldPrice ?? row.oldprice ?? row.price,
                images: row.images || [],
                category: row.category || 'other',
                badge: row.badge || '',
                description: row.description || '',
                specs: row.specs || {},
                variants: row.variants || null
            };
            return normalizeVariantsProductFields(p);
        }

        function mapProductToDb(product) {
            const p = normalizeVariantsProductFields({ ...(product || {}) });
            return {
                id: p.id,
                name: p.name,
                price: p.price,
                old_price: p.oldPrice,
                images: p.images || [],
                category: p.category || 'other',
                badge: p.badge || '',
                description: p.description || '',
                specs: p.specs || {},
                variants: p.variants || null
            };
        }

        function mapCategoryFromDb(row) {
            if (!row) return null;
            return { id: row.id, name: row.name, icon: row.icon || 'fa-tag' };
        }

        function mapCategoryToDb(cat) {
            return { id: cat.id, name: cat.name, icon: cat.icon || 'fa-tag' };
        }

        async function loadOrdersFromSupabase() {
            if (!supabaseReady || !supabaseClient) return false;
            try {
                const { data, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) throw error;

                orders = (data || []).map(row => {
                    return {
                        id: row.id,
                        date: row.created_at || row.date || new Date().toISOString(),
                        customer: row.customer || {},
                        address: row.address || {},
                        items: Array.isArray(row.items) ? row.items : (row.items || []),
                        subtotal: row.subtotal ?? 0,
                        deliveryPrice: row.delivery_price ?? row.deliveryPrice ?? 0,
                        total: row.total ?? 0,
                        status: row.status || 'pending'
                    };
                });

                return true;
            } catch (e) {
                console.warn('Load orders from Supabase failed (likely RLS):', e?.message || e);
                orders = [];
                return false;
            }
        }

        async function loadDataFromSupabase() {
            if (!supabaseReady || !supabaseClient) return false;
            try {
                // حد أعلى لتفادي تحميل ثقيل (سرعة أفضل). زدها إذا كان عندك منتجات كثيرة.
                const [pRes, cRes] = await Promise.all([
                    supabaseClient.from('products').select('*').order('id', { ascending: true }).limit(200),
                    supabaseClient.from('categories').select('*').order('name', { ascending: true }).limit(200)
                ]);

                if (pRes.error) throw pRes.error;
                if (cRes.error) throw cRes.error;

                products = (pRes.data || []).map(mapProductFromDb).filter(Boolean);
                categories = (cRes.data || []).map(mapCategoryFromDb).filter(Boolean);

                // لا نحمل الطلبات للزوار حفاظاً على الخصوصية.
                orders = [];

                console.log('Data loaded from Supabase (products/categories)');
                return true;
            } catch (e) {
                console.error('Load from Supabase error:', e);
                return false;
            }
        }

        async function saveProductToSupabase(product) {
            if (!supabaseReady || !supabaseClient) return;
            const payload = mapProductToDb(product);
            const { error } = await supabaseClient.from('products').upsert(payload, { onConflict: 'id' });
            if (error) console.error('Save product error:', error);
        }

        async function deleteProductFromSupabase(productId) {
            if (!supabaseReady || !supabaseClient) return;
            const { error } = await supabaseClient.from('products').delete().eq('id', productId);
            if (error) console.error('Delete product error:', error);
        }

        async function saveCategoryToSupabase(category) {
            if (!supabaseReady || !supabaseClient) return;
            const payload = mapCategoryToDb(category);
            const { error } = await supabaseClient.from('categories').upsert(payload, { onConflict: 'id' });
            if (error) console.error('Save category error:', error);
        }

        async function deleteCategoryFromSupabase(categoryId) {
            if (!supabaseReady || !supabaseClient) return;
            const { error } = await supabaseClient.from('categories').delete().eq('id', categoryId);
            if (error) console.error('Delete category error:', error);
        }

        async function saveOrderToSupabase(order) {
            if (!supabaseReady || !supabaseClient) return;
            const payload = {
                id: order.id,
                customer: order.customer,
                address: order.address,
                items: order.items,
                subtotal: order.subtotal,
                delivery_price: order.deliveryPrice,
                total: order.total,
                status: order.status,
                created_at: order.date
            };
            const { error } = await supabaseClient.from('orders').upsert(payload, { onConflict: 'id' });
            if (error) console.error('Save order error:', error);
        }

        async function updateOrderStatusSupabase(orderId, status) {
            if (!supabaseReady || !supabaseClient) return;
            const { error } = await supabaseClient.from('orders').update({ status }).eq('id', orderId);
            if (error) console.error('Update order status error:', error);
        }

        // ==================== Abandoned Carts (Supabase) ====================
        let abandonedCarts = [];
        let abandonedDraftTimer = null;

        function getAbandonedIdForSession() {
            // One abandoned cart per visitor session.
            const vid = localStorage.getItem('visitor_id') || generateVisitorId();
            return 'ac_' + vid;
        }

        function computeCartTotalsForDraft() {
            const subtotal = cart.reduce((sum, item) => sum + (Number(item.price || 0) * Number(item.quantity || 1)), 0);
            return { subtotal, total: subtotal };
        }

        async function upsertAbandonedCartDraft() {
            if (!supabaseReady || !supabaseClient) return;
            if (!Array.isArray(cart) || cart.length === 0) return;

            // Don't create abandoned cart if order success already shown
            const successVisible = !document.getElementById('orderSuccess')?.classList.contains('hidden');
            if (successVisible) return;

            const id = getAbandonedIdForSession();
            const vid = localStorage.getItem('visitor_id') || generateVisitorId();

            const name = (document.getElementById('customerName')?.value || '').trim();
            const phone = (document.getElementById('customerPhone')?.value || '').trim();
            const email = (document.getElementById('customerEmail')?.value || '').trim();
            const provinceCode = (document.getElementById('province')?.value || '').trim();
            const municipality = (document.getElementById('municipality')?.value || '').trim();
            const details = (document.getElementById('address')?.value || '').trim();

            // Save draft only if customer started filling at least phone or name
            if (!name && !phone) return;

            const { subtotal, total } = computeCartTotalsForDraft();

            const payload = {
                id,
                visitor_id: vid,
                customer: { name, phone, email },
                address: { provinceCode, municipality, details },
                cart: cart.map(normalizeCartItem).filter(Boolean),
                subtotal,
                total,
                status: 'open',
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabaseClient
                    .from('abandoned_carts')
                    .upsert(payload, { onConflict: 'id' });
                if (error) throw error;
            } catch (e) {
                // Avoid noisy console; draft is optional
                console.warn('Abandoned cart upsert failed:', e?.message || e);
            }
        }

        function scheduleAbandonedDraftSave() {
            // debounce
            if (abandonedDraftTimer) clearTimeout(abandonedDraftTimer);
            abandonedDraftTimer = setTimeout(() => {
                upsertAbandonedCartDraft();
            }, 600);
        }

        let abandonedListenersAttached = false;
        function attachAbandonedCartDraftListeners() {
            if (abandonedListenersAttached) return;
            const form = document.getElementById('orderForm');
            if (!form) return;

            const ids = ['customerName','customerPhone','customerEmail','province','municipality','address'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', scheduleAbandonedDraftSave);
                el.addEventListener('change', scheduleAbandonedDraftSave);
            });

            // delivery type change
            document.querySelectorAll('input[name="deliveryType"]').forEach(r => {
                r.addEventListener('change', scheduleAbandonedDraftSave);
            });

            abandonedListenersAttached = true;
        }

        async function markAbandonedCartCompleted() {
            if (!supabaseReady || !supabaseClient) return;
            const id = getAbandonedIdForSession();
            try {
                const { error } = await supabaseClient
                    .from('abandoned_carts')
                    .update({ status: 'completed', updated_at: new Date().toISOString() })
                    .eq('id', id);
                // ignore if row doesn't exist
                if (error) {
                    // Some schemas may block update; ignore
                }
            } catch (_) {}
        }

        async function loadAbandonedCartsFromSupabase() {
            if (!supabaseReady || !supabaseClient) return false;
            try {
                const { data, error } = await supabaseClient
                    .from('abandoned_carts')
                    .select('*')
                    .eq('status', 'open')
                    .order('updated_at', { ascending: false })
                    .limit(200);
                if (error) throw error;
                abandonedCarts = (data || []).map(r => ({
                    id: r.id,
                    visitor_id: r.visitor_id,
                    customer: r.customer || {},
                    address: r.address || {},
                    cart: Array.isArray(r.cart) ? r.cart : (r.cart || []),
                    subtotal: r.subtotal ?? 0,
                    total: r.total ?? 0,
                    status: r.status || 'open',
                    created_at: r.created_at,
                    updated_at: r.updated_at
                }));
                return true;
            } catch (e) {
                console.warn('Load abandoned carts failed:', e?.message || e);
                abandonedCarts = [];
                return false;
            }
        }

        function renderAbandonedCartsTable() {
            const body = document.getElementById('abandonedTableBody');
            if (!body) return;

            if (!abandonedCarts.length) {
                body.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">لا توجد سلات متروكة حالياً</td></tr>`;
                return;
            }

            body.innerHTML = abandonedCarts.map(ac => {
                const name = ac.customer?.name || '—';
                const phone = ac.customer?.phone || '—';
                const provinceName = ac.address?.provinceCode && algeriaData[ac.address.provinceCode]
                    ? algeriaData[ac.address.provinceCode].name
                    : (ac.address?.province || '—');
                const itemsCount = Array.isArray(ac.cart) ? ac.cart.reduce((s, it) => s + (Number(it.quantity)||0), 0) : 0;
                const updated = ac.updated_at ? new Date(ac.updated_at).toLocaleString('ar-DZ') : '—';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-semibold">${sanitizeInput(name)}</td>
                        <td class="px-4 py-3 text-sm" dir="ltr">${sanitizeInput(phone)}</td>
                        <td class="px-4 py-3 text-sm">${sanitizeInput(provinceName)}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-bold">${itemsCount} قطعة</span>
                                <span class="font-bold text-green-600">${Number(ac.total||0).toLocaleString('ar-DZ')} دج</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-500">${updated}</td>
                        <td class="px-4 py-3">
                            <button onclick="viewAbandonedCartDetails('${ac.id}')" class="text-blue-500 hover:text-blue-700 ml-2" title="عرض"><i class="fas fa-eye"></i></button>
                            <a href="https://wa.me/${settings.whatsapp || '213555123456'}?text=${encodeURIComponent(`مرحباً، لاحظنا أنك لم تكمل طلبك.\nالاسم: ${name}\nالهاتف: ${phone}\nالولاية: ${provinceName}`)}" target="_blank" class="text-green-600 hover:text-green-800 ml-2" title="واتساب"><i class="fab fa-whatsapp"></i></a>
                            <button onclick="deleteAbandonedCart('${ac.id}')" class="text-red-500 hover:text-red-700" title="حذف"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewAbandonedCartDetails(abandonedId) {
            const ac = abandonedCarts.find(x => x.id === abandonedId);
            if (!ac) return;

            const provinceName = ac.address?.provinceCode && algeriaData[ac.address.provinceCode]
                ? algeriaData[ac.address.provinceCode].name
                : (ac.address?.province || '—');

            // reuse order details modal to display
            document.getElementById('orderDetailsContent').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">سلة متروكة</p>
                                <p class="font-bold text-purple-600">${sanitizeInput(ac.id)}</p>
                            </div>
                            <div class="text-left">
                                <p class="text-sm text-gray-500">آخر تحديث</p>
                                <p class="font-semibold">${ac.updated_at ? new Date(ac.updated_at).toLocaleString('ar-DZ') : '—'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-user text-blue-600"></i>
                            معلومات العميل
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <p class="text-sm text-gray-500">الاسم</p>
                                <p class="font-semibold">${sanitizeInput(ac.customer?.name || '—')}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">الهاتف</p>
                                <p class="font-semibold" dir="ltr">${sanitizeInput(ac.customer?.phone || '—')}</p>
                            </div>
                            ${ac.customer?.email ? `
                            <div class="col-span-2">
                                <p class="text-sm text-gray-500">البريد الإلكتروني</p>
                                <p class="font-semibold" dir="ltr">${sanitizeInput(ac.customer?.email || '')}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-green-600"></i>
                            معلومات العنوان
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <p class="text-sm text-gray-500">الولاية</p>
                                <p class="font-semibold">${sanitizeInput(provinceName)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">البلدية</p>
                                <p class="font-semibold">${sanitizeInput(ac.address?.municipality || '—')}</p>
                            </div>
                            ${ac.address?.details ? `
                            <div class="col-span-2">
                                <p class="text-sm text-gray-500">التفاصيل</p>
                                <p class="font-semibold">${sanitizeInput(ac.address?.details || '')}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-box text-purple-600"></i>
                            محتويات السلة (${Array.isArray(ac.cart) ? ac.cart.length : 0})
                        </h4>
                        <div class="space-y-3">
                            ${(ac.cart || []).map(item => {
                                const img = getOrderItemImage(item);
                                const qty = Number(item.quantity||0);
                                const pr = Number(item.price||0);
                                return `
                                    <div class="flex items-center gap-3 bg-white rounded-lg p-3 shadow-sm">
                                        <img src="${img}" class="w-16 h-16 rounded-lg object-cover border" loading="lazy" decoding="async" onerror="this.src='${NO_IMAGE_PLACEHOLDER}'">
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${sanitizeInput(item.name || '')}</div>
                                            ${item.variantLabel ? `<div class="text-xs text-gray-500 mt-0.5">${sanitizeInput(item.variantLabel)}</div>` : ''}
                                            <div class="text-sm text-gray-600">${pr.toLocaleString('ar-DZ')} دج × ${qty}</div>
                                        </div>
                                        <div class="font-bold text-green-600">${(pr * qty).toLocaleString('ar-DZ')} دج</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                        <div class="flex justify-between">
                            <span class="font-bold text-lg">الإجمالي:</span>
                            <span class="font-bold text-xl text-green-600">${Number(ac.total||0).toLocaleString('ar-DZ')} دج</span>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('orderDetailsModal').classList.remove('hidden');
        }

        async function deleteAbandonedCart(abandonedId) {
            if (!confirm('حذف هذه السلة المتروكة؟')) return;
            try {
                if (supabaseReady && supabaseClient) {
                    const { error } = await supabaseClient.from('abandoned_carts').delete().eq('id', abandonedId);
                    if (error) throw error;
                }
                abandonedCarts = abandonedCarts.filter(x => x.id !== abandonedId);
                renderAbandonedCartsTable();
                showNotification('تم حذف السلة المتروكة', 'success');
            } catch (e) {
                console.error(e);
                showNotification('فشل حذف السلة المتروكة', 'error');
            }
        }

        async function refreshAbandonedCarts() {
            await loadAbandonedCartsFromSupabase();
            renderAbandonedCartsTable();
        }

        // ==================== إعدادات المتجر (Supabase Settings Sync) ====================
        // نستخدم جدول store_settings لتخزين الإعدادات بشكل دائم (يعمل على كل الأجهزة)
        // Schema المقترح:
        // create table if not exists public.store_settings (
        //   id text primary key,
        //   public jsonb default '{}'::jsonb,
        //   private jsonb default '{}'::jsonb,
        //   updated_at timestamptz default now()
        // );

        function pickPublicSettings(all) {
            const keys = [
                'storeName','phone','email','whatsapp',
                'emailJsKey','emailJsService','emailJsTemplate',
                'sheetUrl',
                'facebookPixel','tiktokPixel','googleAnalytics','conversionProxyUrl',
                'facebookUrl','instagramUrl','tiktokUrl','twitterUrl','youtubeUrl','snapchatUrl','telegramUrl',
                'adminEmails',
                // tracking toggles
                'enableFacebookPixel','enableTikTokPixel','enableGoogleAnalytics'
            ];
            const out = {};
            keys.forEach(k => {
                if (typeof all[k] !== 'undefined') out[k] = all[k];
            });
            return out;
        }

        function pickPrivateSettings(all) {
            // ⚠️ هذه مفاتيح حساسة — الأفضل نقلها إلى Proxy/Edge Function وعدم وضعها في المتصفح.
            const keys = [
                'facebookAccessToken','facebookTestCode',
                'tiktokAccessToken','tiktokTestCode'
            ];
            const out = {};
            keys.forEach(k => {
                if (typeof all[k] !== 'undefined') out[k] = all[k];
            });
            return out;
        }

        async function loadStoreSettingsFromSupabase({ includePrivate = false } = {}) {
            if (!supabaseReady || !supabaseClient) return false;
            try {
                const selectCols = includePrivate ? 'public,private' : 'public';
                const { data, error } = await supabaseClient
                    .from('store_settings')
                    .select(selectCols)
                    .eq('id', 'main')
                    .maybeSingle();

                if (error) throw error;
                if (!data) return false;

                const publicData = data.public || {};
                const privateData = includePrivate ? (data.private || {}) : {};

                settings = {
                    ...CONFIG,
                    ...(settings || {}),
                    ...publicData,
                    ...privateData
                };

                // كاش محلي (يساعد دوال التحويل التي تقرأ من localStorage)
                localStorage.setItem('storeSettings', JSON.stringify(settings));
                window.settings = settings;
                return true;
            } catch (e) {
                console.warn('loadStoreSettingsFromSupabase failed:', e?.message || e);
                return false;
            }
        }

        async function saveStoreSettingsToSupabase() {
            if (!supabaseReady || !supabaseClient) return false;
            try {
                const payload = {
                    id: 'main',
                    public: pickPublicSettings(settings),
                    private: pickPrivateSettings(settings),
                    updated_at: new Date().toISOString()
                };
                const { error } = await supabaseClient
                    .from('store_settings')
                    .upsert(payload, { onConflict: 'id' });
                if (error) throw error;
                return true;
            } catch (e) {
                console.warn('saveStoreSettingsToSupabase failed:', e);
                return false;
            }
        }

        function getStoreSettingsSql() {
            return `-- 1) Create store_settings table\ncreate table if not exists public.store_settings (\n  id text primary key,\n  public jsonb default '{}'::jsonb,\n  private jsonb default '{}'::jsonb,\n  updated_at timestamptz default now()\n);\n\n-- 2) Enable RLS\nalter table public.store_settings enable row level security;\n\n-- 3) Policies\n-- Anyone can read public settings (for visitors)\ndrop policy if exists \"public read store settings\" on public.store_settings;\ncreate policy \"public read store settings\"\n  on public.store_settings\n  for select\n  to anon, authenticated\n  using (true);\n\n-- Only authenticated can write (admin)\ndrop policy if exists \"admin write store settings\" on public.store_settings;\ncreate policy \"admin write store settings\"\n  on public.store_settings\n  for insert\n  to authenticated\n  with check (true);\n\ndrop policy if exists \"admin update store settings\" on public.store_settings;\ncreate policy \"admin update store settings\"\n  on public.store_settings\n  for update\n  to authenticated\n  using (true)\n  with check (true);\n\n-- 4) Insert default row\ninsert into public.store_settings (id, public, private)\nvalues ('main', '{}'::jsonb, '{}'::jsonb)\non conflict (id) do nothing;`;
        }

        function getReviewsSql() {
            return `-- Reviews table (product reviews)\ncreate table if not exists public.reviews (\n  id bigserial primary key,\n  product_id bigint not null,\n  customer_name text not null,\n  rating int not null check (rating >= 1 and rating <= 5),\n  comment text not null,\n  image_base64 text,\n  created_at timestamptz default now()\n);\n\ncreate index if not exists reviews_product_id_idx on public.reviews(product_id);\n\n-- RLS\nalter table public.reviews enable row level security;\n\n-- Public can read reviews\ndrop policy if exists \"public read reviews\" on public.reviews;\ncreate policy \"public read reviews\"\n  on public.reviews\n  for select\n  to anon, authenticated\n  using (true);\n\n-- Anyone can insert a review (public)\ndrop policy if exists \"public insert reviews\" on public.reviews;\ncreate policy \"public insert reviews\"\n  on public.reviews\n  for insert\n  to anon, authenticated\n  with check (true);\n\n-- Only authenticated can delete (moderation in admin panel if you add it later)\ndrop policy if exists \"admin delete reviews\" on public.reviews;\ncreate policy \"admin delete reviews\"\n  on public.reviews\n  for delete\n  to authenticated\n  using (true);`;
        }

        function getAbandonedSql() {
            return `-- Abandoned carts (draft checkout sessions)\ncreate table if not exists public.abandoned_carts (\n  id text primary key,\n  visitor_id text,\n  customer jsonb default '{}'::jsonb,\n  address jsonb default '{}'::jsonb,\n  cart jsonb default '[]'::jsonb,\n  subtotal int default 0,\n  total int default 0,\n  status text default 'open',\n  updated_at timestamptz default now(),\n  created_at timestamptz default now()\n);\n\ncreate index if not exists abandoned_carts_updated_at_idx on public.abandoned_carts(updated_at);\ncreate index if not exists abandoned_carts_visitor_id_idx on public.abandoned_carts(visitor_id);\n\n-- RLS\nalter table public.abandoned_carts enable row level security;\n\n-- Anyone can upsert their own abandoned cart (we do not enforce ownership here in policy to keep it simple)\n-- For stricter security, you can restrict by visitor_id and a hash token.\ndrop policy if exists \"public upsert abandoned carts\" on public.abandoned_carts;\ncreate policy \"public upsert abandoned carts\"\n  on public.abandoned_carts\n  for insert\n  to anon, authenticated\n  with check (true);\n\ndrop policy if exists \"public update abandoned carts\" on public.abandoned_carts;\ncreate policy \"public update abandoned carts\"\n  on public.abandoned_carts\n  for update\n  to anon, authenticated\n  using (true)\n  with check (true);\n\n-- Only authenticated (admin) can read/delete abandoned carts\ndrop policy if exists \"admin read abandoned carts\" on public.abandoned_carts;\ncreate policy \"admin read abandoned carts\"\n  on public.abandoned_carts\n  for select\n  to authenticated\n  using (true);\n\ndrop policy if exists \"admin delete abandoned carts\" on public.abandoned_carts;\ncreate policy \"admin delete abandoned carts\"\n  on public.abandoned_carts\n  for delete\n  to authenticated\n  using (true);`;
        }

        function copyStoreSettingsSql() {
            const el = document.getElementById('storeSettingsSql');
            if (!el) return;
            navigator.clipboard.writeText(el.value || '').then(() => {
                showNotification('تم نسخ SQL', 'success');
            }).catch(() => {
                showNotification('تعذر نسخ SQL', 'error');
            });
        }

        function copyReviewsSql() {
            const el = document.getElementById('reviewsSql');
            if (!el) return;
            navigator.clipboard.writeText(el.value || '').then(() => {
                showNotification('تم نسخ SQL', 'success');
            }).catch(() => {
                showNotification('تعذر نسخ SQL', 'error');
            });
        }

        function copyAbandonedSql() {
            const el = document.getElementById('abandonedSql');
            if (!el) return;
            navigator.clipboard.writeText(el.value || '').then(() => {
                showNotification('تم نسخ SQL', 'success');
            }).catch(() => {
                showNotification('تعذر نسخ SQL', 'error');
            });
        }

        // ==================== Reviews (Supabase) ====================
        let currentProductReviews = [];

        async function loadReviewsForProduct(productId) {
            if (!supabaseReady || !supabaseClient) return [];
            try {
                const pid = Number(productId);
                if (!Number.isFinite(pid)) return [];
                const { data, error } = await supabaseClient
                    .from('reviews')
                    .select('*')
                    .eq('product_id', pid)
                    .order('created_at', { ascending: false })
                    .limit(50);
                if (error) throw error;
                currentProductReviews = (data || []).map(r => ({
                    id: r.id,
                    product_id: r.product_id,
                    customer_name: r.customer_name,
                    rating: r.rating,
                    comment: r.comment,
                    image_base64: r.image_base64,
                    created_at: r.created_at
                }));
                return currentProductReviews;
            } catch (e) {
                console.warn('loadReviewsForProduct failed:', e?.message || e);
                currentProductReviews = [];
                return [];
            }
        }

        async function addReviewForProduct({ productId, customerName, rating, comment, imageBase64 }) {
            if (!supabaseReady || !supabaseClient) throw new Error('supabase_not_ready');
            const pid = Number(productId);
            if (!Number.isFinite(pid)) throw new Error('invalid_product');

            const payload = {
                product_id: pid,
                customer_name: String(customerName || '').trim().slice(0, 80),
                rating: Number(rating),
                comment: String(comment || '').trim().slice(0, 800),
                image_base64: imageBase64 || null
            };

            const { error } = await supabaseClient.from('reviews').insert(payload);
            if (error) throw error;
        }

        function renderStarsStatic(rating) {
            const r = Math.max(1, Math.min(5, Number(rating) || 0));
            return `<div class=\"flex text-yellow-400\">${Array.from({length:5}).map((_,i)=>`<i class=\"fas fa-star ${i < r ? '' : 'opacity-30'}\"></i>`).join('')}</div>`;
        }

        function formatReviewDate(iso) {
            try { return new Date(iso).toLocaleDateString('ar-DZ'); } catch (_) { return ''; }
        }

        async function fileToBase64(file, { maxBytes = 350 * 1024 } = {}) {
            if (!file) return null;
            if (file.size > maxBytes) {
                throw new Error('image_too_large');
            }
            return await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(String(reader.result || ''));
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function renderReviewsTab(product) {
            const list = currentProductReviews || [];
            const avg = list.length ? (list.reduce((s, r) => s + (Number(r.rating)||0), 0) / list.length) : 0;

            const summaryHtml = `
                <div class="flex items-center justify-between gap-4 mb-6">
                    <div>
                        <div class="text-lg font-bold text-gray-800">تقييمات العملاء</div>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="text-2xl font-extrabold text-yellow-500">${avg ? avg.toFixed(1) : '—'}</div>
                            <div class="text-sm text-gray-500">(${list.length} تقييم)</div>
                        </div>
                    </div>
                    <div class="hidden md:block">${avg ? renderStarsStatic(Math.round(avg)) : ''}</div>
                </div>
            `;

            const formHtml = `
                <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 mb-6">
                    <div class="font-bold text-gray-800 mb-3">أضف تقييمك</div>
                    <form id="reviewForm" class="space-y-3" autocomplete="off">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input id="reviewName" type="text" placeholder="اسمك (اختياري)" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <div class="flex items-center justify-between px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                <div class="text-sm font-semibold text-gray-700">التقييم:</div>
                                <div id="reviewStars" class="flex gap-1">
                                    ${[1,2,3,4,5].map(i => `<button type="button" class="star-btn" data-star="${i}" aria-label="${i} stars"><i class="fas fa-star text-gray-300"></i></button>`).join('')}
                                </div>
                                <input type="hidden" id="reviewRating" value="5">
                            </div>
                        </div>
                        <textarea id="reviewComment" rows="3" placeholder="اكتب رأيك عن المنتج..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none resize-none" required></textarea>
                        <div class="flex items-center justify-between gap-3">
                            <label class="flex items-center gap-2 px-4 py-2 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-purple-300">
                                <i class="fas fa-camera text-purple-600"></i>
                                <span class="text-sm font-semibold text-gray-700">إضافة صورة (اختياري)</span>
                                <input id="reviewImage" type="file" accept="image/*" class="hidden">
                            </label>
                            <button id="submitReviewBtn" type="submit" class="px-6 py-3 gradient-btn text-white font-bold rounded-xl">إرسال التقييم</button>
                        </div>
                        <p class="text-xs text-gray-500">* سيتم نشر التقييم مباشرة. تجنب مشاركة معلومات شخصية حساسة.</p>
                    </form>
                </div>
            `;

            const listHtml = list.length ? `
                <div class="space-y-4">
                    ${list.map(r => `
                        <div class="bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <div class="font-bold text-gray-800">${sanitizeInput(r.customer_name || 'زبون')}</div>
                                    <div class="mt-1 flex items-center gap-2">
                                        ${renderStarsStatic(r.rating)}
                                        <span class="text-xs text-gray-400">${formatReviewDate(r.created_at)}</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-gray-700 mt-3 leading-relaxed">${sanitizeInput(r.comment || '')}</p>
                            ${r.image_base64 ? `
                                <div class="mt-3">
                                    <img src="${r.image_base64}" alt="صورة من العميل" class="review-thumb w-full max-w-sm rounded-xl border object-cover" loading="lazy" decoding="async">
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : `<div class="text-center text-gray-500 py-8"><i class="fas fa-comments text-4xl mb-4"></i><p>لا توجد تقييمات بعد. كن أول من يقيّم هذا المنتج!</p></div>`;

            const containerHtml = summaryHtml + formHtml + listHtml;
            document.getElementById('tabContent').innerHTML = containerHtml;

            // Star UI
            const starsWrap = document.getElementById('reviewStars');
            const ratingInput = document.getElementById('reviewRating');
            const setActiveStars = (val) => {
                const v = Math.max(1, Math.min(5, Number(val) || 5));
                ratingInput.value = String(v);
                starsWrap.querySelectorAll('.star-btn').forEach(btn => {
                    const s = Number(btn.dataset.star);
                    btn.classList.toggle('active', s <= v);
                    const icon = btn.querySelector('i');
                    if (icon) icon.className = `fas fa-star ${s <= v ? 'text-yellow-400' : 'text-gray-300'}`;
                });
            };
            setActiveStars(5);
            starsWrap.addEventListener('click', (e) => {
                const btn = e.target.closest('.star-btn');
                if (!btn) return;
                setActiveStars(Number(btn.dataset.star));
            });

            // Submit
            const form = document.getElementById('reviewForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentProduct) return;

                const btn = document.getElementById('submitReviewBtn');
                btn.disabled = true;
                btn.textContent = 'جاري الإرسال...';

                try {
                    const customerName = document.getElementById('reviewName').value.trim() || 'زبون';
                    const rating = Number(document.getElementById('reviewRating').value || 5);
                    const comment = document.getElementById('reviewComment').value.trim();
                    const file = document.getElementById('reviewImage').files?.[0] || null;

                    if (!comment) {
                        showNotification('اكتب تعليقاً قبل الإرسال', 'error');
                        return;
                    }

                    let imageBase64 = null;
                    if (file) {
                        imageBase64 = await fileToBase64(file);
                    }

                    await addReviewForProduct({
                        productId: currentProduct.id,
                        customerName,
                        rating,
                        comment,
                        imageBase64
                    });

                    showNotification('تم إرسال تقييمك بنجاح', 'success');

                    // Reload reviews and re-render
                    await loadReviewsForProduct(currentProduct.id);
                    renderReviewsTab(currentProduct);
                } catch (err) {
                    console.error(err);
                    if ((err?.message || '') === 'image_too_large') {
                        showNotification('حجم الصورة كبير. اختر صورة أصغر (حد أقصى ~350KB)', 'error');
                    } else if ((err?.message || '').includes('relation') || (err?.message || '').includes('reviews')) {
                        showNotification('جدول التقييمات reviews غير موجود في Supabase. أنشئه من SQL داخل الإعدادات.', 'error');
                    } else {
                        showNotification('تعذر إرسال التقييم حالياً', 'error');
                    }
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'إرسال التقييم';
                }
            });
        }

        async function manualSyncStoreSettings() {
            if (!supabaseReady || !supabaseClient) {
                showNotification('Supabase غير جاهز', 'error');
                return;
            }
            try {
                const ok = await loadStoreSettingsFromSupabase({ includePrivate: isAdmin });
                if (ok) {
                    updateWhatsAppButton();
                    updateFooterSocialLinks();
                    updateFooterInfo();
                    initializePixels({ immediate: isAdmin });
                    showNotification('تمت مزامنة الإعدادات من Supabase', 'success');
                } else {
                    showNotification('تعذر مزامنة الإعدادات: تأكد من إنشاء جدول store_settings وسياسات RLS', 'error');
                }
            } catch (e) {
                const msg = (e?.message || '').toLowerCase();
                if (msg.includes('relation') && msg.includes('store_settings')) {
                    showNotification('جدول store_settings غير موجود. افتح SQL أدناه وأنشئ الجدول ثم حاول مرة أخرى.', 'error');
                } else if (msg.includes('permission denied') || msg.includes('row level security')) {
                    showNotification('RLS يمنع الوصول. طبّق سياسات store_settings ثم حاول مرة أخرى.', 'error');
                } else {
                    showNotification('تعذر مزامنة الإعدادات: ' + (e?.message || 'خطأ غير معروف'), 'error');
                }
            }
        }

        // Supabase Test (نفس زر Firebase في الواجهة الحالية)
        async function testFirebaseConnection() {
            // نُبقي نفس اسم الدالة حتى لا نغيّر HTML كثيراً
            const statusDiv = document.getElementById('firebaseStatus');
            statusDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800');
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري الاختبار...';
            statusDiv.classList.add('bg-gray-100');

            try {
                const ok = initSupabase();
                if (!ok) throw new Error('Supabase init failed');
                const { error } = await supabaseClient.from('categories').select('id').limit(1);
                if (error) throw error;

                statusDiv.innerHTML = '<i class="fas fa-check-circle ml-2"></i>تم الاتصال بـ Supabase بنجاح ✅';
                statusDiv.classList.remove('bg-gray-100');
                statusDiv.classList.add('bg-green-100', 'text-green-800');
            } catch (e) {
                statusDiv.innerHTML = `<i class="fas fa-times-circle ml-2"></i>فشل الاتصال: ${e.message}`;
                statusDiv.classList.remove('bg-gray-100');
                statusDiv.classList.add('bg-red-100', 'text-red-800');
            }
        }

        async function uploadLocalDataToFirebase() {
            // نُبقي نفس اسم الدالة حتى لا نغيّر HTML كثيراً
            if (!supabaseReady || !supabaseClient) {
                initSupabase();
            }
            if (!supabaseReady || !supabaseClient) {
                showNotification('تعذر الاتصال بـ Supabase', 'error');
                return;
            }

            const statusDiv = document.getElementById('firebaseStatus');
            statusDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري رفع البيانات إلى Supabase...';
            statusDiv.classList.add('bg-blue-100', 'text-blue-800');

            try {
                // إذا لا توجد بيانات محلية في Supabase، ارفع الافتراضي (للبداية فقط)
                const { data: existingProducts, error: pErr } = await supabaseClient.from('products').select('id').limit(1);
                if (pErr) throw pErr;

                if (!existingProducts || existingProducts.length === 0) {
                    // ارفع المنتجات الافتراضية + التصنيفات الافتراضية
                    const catsPayload = defaultCategories.map(mapCategoryToDb);
                    const prodsPayload = defaultProducts.map(mapProductToDb);

                    const cUp = await supabaseClient.from('categories').upsert(catsPayload, { onConflict: 'id' });
                    if (cUp.error) throw cUp.error;

                    const pUp = await supabaseClient.from('products').upsert(prodsPayload, { onConflict: 'id' });
                    if (pUp.error) throw pUp.error;

                    await loadDataFromSupabase();
                    statusDiv.innerHTML = `<i class="fas fa-check-circle ml-2"></i>تم رفع البيانات الافتراضية بنجاح! (${defaultProducts.length} منتج، ${defaultCategories.length} تصنيف)`;
                } else {
                    statusDiv.innerHTML = `<i class="fas fa-check-circle ml-2"></i>قاعدة البيانات تحتوي على بيانات بالفعل.`;
                }

                statusDiv.classList.remove('bg-blue-100', 'text-blue-800');
                statusDiv.classList.add('bg-green-100', 'text-green-800');
                showNotification('تمت المزامنة مع Supabase', 'success');

                // تحديث الواجهة
                renderCategoryButtons();
                updateProductCategoryOptions();
                renderProducts();
            } catch (e) {
                console.error(e);
                statusDiv.innerHTML = `<i class="fas fa-times-circle ml-2"></i>خطأ: ${e.message}`;
                statusDiv.classList.remove('bg-blue-100', 'text-blue-800');
                statusDiv.classList.add('bg-red-100', 'text-red-800');
                showNotification('فشل الرفع', 'error');
            }
        }

        // ==================== الإعدادات ====================
        function openSettings() {
            document.getElementById('settingStoreName').value = settings.storeName || '';
            document.getElementById('settingPhone').value = settings.phone || '';
            document.getElementById('settingEmail').value = settings.email || '';
            document.getElementById('settingWhatsapp').value = settings.whatsapp || '';
            document.getElementById('settingEmailJsKey').value = settings.emailJsKey || '';
            document.getElementById('settingEmailJsService').value = settings.emailJsService || '';
            document.getElementById('settingEmailJsTemplate').value = settings.emailJsTemplate || '';
            document.getElementById('settingSheetUrl').value = settings.sheetUrl || '';

            // SQL helper (store_settings + reviews)
            const sqlBox = document.getElementById('storeSettingsSql');
            if (sqlBox) sqlBox.value = getStoreSettingsSql();
            const reviewsBox = document.getElementById('reviewsSql');
            if (reviewsBox) reviewsBox.value = getReviewsSql();
            const abandonedBox = document.getElementById('abandonedSql');
            if (abandonedBox) abandonedBox.value = getAbandonedSql();

            // Firebase (قديمة/مخفية)
            document.getElementById('settingFirebaseApiKey').value = settings.firebaseApiKey || '';
            document.getElementById('settingFirebaseProjectId').value = settings.firebaseProjectId || '';
            document.getElementById('settingFirebaseAuthDomain').value = settings.firebaseAuthDomain || '';
            document.getElementById('settingFirebaseStorageBucket').value = settings.firebaseStorageBucket || '';
            document.getElementById('firebaseStatus').classList.add('hidden');
            // Pixels
            document.getElementById('settingFacebookPixel').value = settings.facebookPixel || '';
            document.getElementById('settingFacebookAccessToken').value = settings.facebookAccessToken || '';
            document.getElementById('settingFacebookTestCode').value = settings.facebookTestCode || '';
            document.getElementById('settingTikTokPixel').value = settings.tiktokPixel || '';
            document.getElementById('settingTikTokAccessToken').value = settings.tiktokAccessToken || '';
            document.getElementById('settingTikTokTestCode').value = settings.tiktokTestCode || '';
            document.getElementById('settingGoogleAnalytics').value = settings.googleAnalytics || '';
            document.getElementById('settingConversionProxyUrl').value = settings.conversionProxyUrl || '';
            document.getElementById('conversionApiStatus').classList.add('hidden');

            // Tracking toggles
            document.getElementById('settingEnableFacebookPixel').checked = settings.enableFacebookPixel !== false;
            document.getElementById('settingEnableTikTokPixel').checked = settings.enableTikTokPixel !== false;
            document.getElementById('settingEnableGoogleAnalytics').checked = settings.enableGoogleAnalytics !== false;
            // Social Media Links
            document.getElementById('settingFacebook').value = settings.facebookUrl || '';
            document.getElementById('settingInstagram').value = settings.instagramUrl || '';
            document.getElementById('settingTiktokUrl').value = settings.tiktokUrl || '';
            document.getElementById('settingTwitter').value = settings.twitterUrl || '';
            document.getElementById('settingYoutube').value = settings.youtubeUrl || '';
            document.getElementById('settingSnapchat').value = settings.snapchatUrl || '';
            document.getElementById('settingTelegram').value = settings.telegramUrl || '';
            document.getElementById('settingAdminEmails').value = (settings.adminEmails || []).join(', ');
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }

        async function saveSettings() {
            settings.storeName = document.getElementById('settingStoreName').value;
            settings.phone = document.getElementById('settingPhone').value;
            settings.email = document.getElementById('settingEmail').value;
            settings.whatsapp = document.getElementById('settingWhatsapp').value;
            settings.emailJsKey = document.getElementById('settingEmailJsKey').value;
            settings.emailJsService = document.getElementById('settingEmailJsService').value;
            settings.emailJsTemplate = document.getElementById('settingEmailJsTemplate').value;
            settings.sheetUrl = document.getElementById('settingSheetUrl').value;
            // Firebase (حقول مخفية/قديمة)
            settings.firebaseApiKey = document.getElementById('settingFirebaseApiKey').value;
            settings.firebaseProjectId = document.getElementById('settingFirebaseProjectId').value;
            settings.firebaseAuthDomain = document.getElementById('settingFirebaseAuthDomain').value;
            settings.firebaseStorageBucket = document.getElementById('settingFirebaseStorageBucket').value;
            // Pixels & Conversion APIs
            settings.facebookPixel = document.getElementById('settingFacebookPixel').value;
            settings.facebookAccessToken = document.getElementById('settingFacebookAccessToken').value;
            settings.facebookTestCode = document.getElementById('settingFacebookTestCode').value;
            settings.tiktokPixel = document.getElementById('settingTikTokPixel').value;
            settings.tiktokAccessToken = document.getElementById('settingTikTokAccessToken').value;
            settings.tiktokTestCode = document.getElementById('settingTikTokTestCode').value;
            settings.googleAnalytics = document.getElementById('settingGoogleAnalytics').value;
            settings.conversionProxyUrl = document.getElementById('settingConversionProxyUrl').value;

            // Tracking toggles
            settings.enableFacebookPixel = document.getElementById('settingEnableFacebookPixel').checked;
            settings.enableTikTokPixel = document.getElementById('settingEnableTikTokPixel').checked;
            settings.enableGoogleAnalytics = document.getElementById('settingEnableGoogleAnalytics').checked;

            // Social Media Links
            settings.facebookUrl = document.getElementById('settingFacebook').value;
            settings.instagramUrl = document.getElementById('settingInstagram').value;
            settings.tiktokUrl = document.getElementById('settingTiktokUrl').value;
            settings.twitterUrl = document.getElementById('settingTwitter').value;
            settings.youtubeUrl = document.getElementById('settingYoutube').value;
            settings.snapchatUrl = document.getElementById('settingSnapchat').value;
            settings.telegramUrl = document.getElementById('settingTelegram').value;

            // Admin Emails allowlist (Supabase Auth)
            settings.adminEmails = (document.getElementById('settingAdminEmails').value || '')
                .split(',')
                .map(s => s.trim().toLowerCase())
                .filter(Boolean);

            const newPassword = document.getElementById('settingNewPassword').value;
            const confirmPassword = document.getElementById('settingConfirmPassword').value;
            if (newPassword && newPassword === confirmPassword) {
                localStorage.setItem('adminPasswordHash', hashPassword(newPassword));
            }

            // ✅ كاش محلي
            localStorage.setItem('storeSettings', JSON.stringify(settings));
            window.settings = settings;

            // ✅ حفظ إلى Supabase (لتظهر في كل الأجهزة)
            // ملاحظة أمنية: التوكنات الأفضل تخزينها في private مع RLS (Authenticated only)
            let savedToCloud = false;
            if (supabaseReady && supabaseClient) {
                savedToCloud = await saveStoreSettingsToSupabase();
                if (!savedToCloud) {
                    console.warn('Settings cloud sync failed. Check store_settings table + RLS.');
                }
            } else {
                console.warn('Supabase not ready; settings saved locally only.');
            }

            // تحديث الواجهة فوراً
            updateWhatsAppButton();
            updateFooterSocialLinks();
            updateFooterInfo();
            initializePixels(); // إعادة تهيئة البيكسلات
            closeSettings();

            showNotification(savedToCloud ? 'تم حفظ الإعدادات (Supabase + Local)' : 'تم حفظ الإعدادات محلياً (تعذر الحفظ على Supabase)', savedToCloud ? 'success' : 'warning');
        }
        
        // تحديث روابط التواصل الاجتماعي في الفوتر
        function updateFooterSocialLinks() {
            const container = document.getElementById('footerSocialLinks');
            const socialLinks = [
                { url: settings.facebookUrl, icon: 'fab fa-facebook-f', bg: 'bg-blue-600' },
                { url: settings.instagramUrl, icon: 'fab fa-instagram', bg: 'bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400' },
                { url: settings.tiktokUrl, icon: 'fab fa-tiktok', bg: 'bg-black' },
                { url: settings.twitterUrl, icon: 'fab fa-twitter', bg: 'bg-sky-500' },
                { url: settings.youtubeUrl, icon: 'fab fa-youtube', bg: 'bg-red-600' },
                { url: settings.snapchatUrl, icon: 'fab fa-snapchat-ghost', bg: 'bg-yellow-400' },
                { url: settings.telegramUrl, icon: 'fab fa-telegram-plane', bg: 'bg-blue-500' },
                { url: settings.whatsapp ? `https://wa.me/${settings.whatsapp}` : '', icon: 'fab fa-whatsapp', bg: 'bg-green-500' }
            ];
            
            const linksHtml = socialLinks
                .filter(link => link.url)
                .map(link => `
                    <a href="${link.url}" target="_blank" rel="noopener noreferrer" 
                       class="w-10 h-10 ${link.bg} rounded-full flex items-center justify-center hover:opacity-80 hover:scale-110 transition-all">
                        <i class="${link.icon} text-white"></i>
                    </a>
                `).join('');
            
            container.innerHTML = linksHtml || '<p class="text-purple-200 text-sm">لم يتم إضافة روابط بعد</p>';
        }
        
        // تحديث معلومات الفوتر
        function updateFooterInfo() {
            if (settings.phone) document.getElementById('footerPhone').textContent = settings.phone;
            if (settings.email) document.getElementById('footerEmail').textContent = settings.email;
        }
        
        // تهيئة جميع البيكسلات
        // تحميل البيكسلات بشكل مؤجل لتحسين سرعة التحميل (Lazy Loading)
        function initializePixels({ immediate = false } = {}) {
            const load = () => {
                // Respect client-side toggles (useful when AdBlock blocks pixels)
                const fbEnabled = settings.enableFacebookPixel !== false;
                // TikTok Pixel: نفعّله فقط إذا كان true صراحةً لتجنب ERR_BLOCKED_BY_CLIENT على أغلب المتصفحات
                // كما نوقفه داخل iframe (TikTok Preview) لتقليل الأخطاء والبطء
                const isInIframe = (() => { try { return window.self !== window.top; } catch (_) { return true; } })();
                const ttEnabled = settings.enableTikTokPixel === true && !isInIframe;
                const gaEnabled = settings.enableGoogleAnalytics !== false;

                if (fbEnabled && settings.facebookPixel) initFacebookPixel(settings.facebookPixel);
                if (ttEnabled && settings.tiktokPixel) initTikTokPixel(settings.tiktokPixel);
                if (gaEnabled && settings.googleAnalytics) initGoogleAnalytics(settings.googleAnalytics);
            };

            if (immediate) {
                load();
                return;
            }

            // 1) بعد اكتمال تحميل الصفحة
            window.addEventListener('load', () => setTimeout(load, 1200), { once: true });

            // 2) أو عند أول تفاعل من المستخدم (الأسرع للتتبّع بدون إبطاء التحميل)
            const onFirstInteraction = () => {
                load();
                window.removeEventListener('scroll', onFirstInteraction);
                window.removeEventListener('mousemove', onFirstInteraction);
                window.removeEventListener('touchstart', onFirstInteraction);
                window.removeEventListener('keydown', onFirstInteraction);
            };
            window.addEventListener('scroll', onFirstInteraction, { once: true, passive: true });
            window.addEventListener('mousemove', onFirstInteraction, { once: true, passive: true });
            window.addEventListener('touchstart', onFirstInteraction, { once: true, passive: true });
            window.addEventListener('keydown', onFirstInteraction, { once: true });
        }
        
        // تتبع جميع المنصات - مشاهدة المنتج
        function trackViewContent(product) {
            // Browser-side tracking
            fbTrackViewContent(product);
            ttTrackViewContent(product);
            gaTrackViewItem(product);
            
            // Server-side tracking (Conversion APIs)
            sendConversionEvent('ViewContent', {
                content_ids: [product.id.toString()],
                content_name: product.name,
                content_type: 'product',
                content_category: product.category,
                value: product.price,
                currency: 'DZD'
            });
        }
        
        // تتبع جميع المنصات - إضافة للسلة
        function trackAddToCart(product, quantity) {
            // Browser-side tracking
            fbTrackAddToCart(product, quantity);
            ttTrackAddToCart(product, quantity);
            gaTrackAddToCart(product, quantity);
            
            // Server-side tracking (Conversion APIs)
            sendConversionEvent('AddToCart', {
                content_ids: [product.id.toString()],
                content_name: product.name,
                content_type: 'product',
                quantity: quantity,
                value: product.price * quantity,
                currency: 'DZD'
            });
        }
        
        // تتبع جميع المنصات - بدء الشراء
        function trackInitiateCheckout(cart, total) {
            // Browser-side tracking
            fbTrackInitiateCheckout(cart, total);
            ttTrackInitiateCheckout(cart, total);
            gaTrackBeginCheckout(cart, total);
            
            // Server-side tracking (Conversion APIs)
            sendConversionEvent('InitiateCheckout', {
                content_ids: cart.map(item => item.id.toString()),
                content_type: 'product',
                num_items: cart.reduce((sum, item) => sum + item.quantity, 0),
                value: total,
                currency: 'DZD'
            });
        }
        
        // تتبع جميع المنصات - إتمام الشراء
        function trackPurchase(order) {
            // Browser-side tracking
            fbTrackPurchase(order);
            ttTrackCompletePayment(order);
            gaTrackPurchase(order);
            
            // Server-side tracking (Conversion APIs)
            sendConversionEvent('Purchase', {
                content_ids: order.items.map(item => item.id.toString()),
                content_type: 'product',
                num_items: order.items.reduce((sum, item) => sum + item.quantity, 0),
                value: order.total,
                currency: 'DZD',
                order_id: order.id
            });
        }

        function updateWhatsAppButton() {
            document.getElementById('whatsappBtn').href = `https://wa.me/${settings.whatsapp}`;
        }

        // ==================== التنقل ====================
        function showPage(page, opts = {}) {
            const push = opts.push !== false;

            // Update URL for navigation (without breaking modals)
            if (push && typeof setUrlParams === 'function' && !window.__routeApplying) {
                if (page === 'home') setUrlParams({ page: 'home' });
                else if (page === 'track') setUrlParams({ page: 'track' });
                // product handled in viewProduct so we keep product id
                else if (page === 'admin') setUrlParams({ page: 'admin' });
            }

            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('productPage').classList.add('hidden');
            document.getElementById('trackPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');

            if (page === 'home') document.getElementById('homePage').classList.remove('hidden');
            else if (page === 'product') document.getElementById('productPage').classList.remove('hidden');
            else if (page === 'track') document.getElementById('trackPage').classList.remove('hidden');
            else if (page === 'admin') {
                if (!isAdmin) { showAdminLogin(); return; }
                document.getElementById('adminPage').classList.remove('hidden');
                // تحميل الطلبات + السلات المتروكة من Supabase (خاص بالمدير)
                if (supabaseReady && supabaseClient) {
                    Promise.all([
                        loadOrdersFromSupabase(),
                        loadAbandonedCartsFromSupabase()
                    ]).then(() => {
                        loadAdminData();
                        // Render abandoned carts table if tab is visible
                        renderAbandonedCartsTable();
                    });
                } else {
                    loadAdminData();
                }
            }
        }

        // ==================== Routing (URL) ====================
        function setUrlParams(params = {}) {
            const url = new URL(window.location.href);
            // clear known params first
            url.searchParams.delete('page');
            url.searchParams.delete('id');
            Object.entries(params).forEach(([k, v]) => {
                if (v === null || typeof v === 'undefined' || v === '') return;
                url.searchParams.set(k, String(v));
            });
            history.pushState(params, '', url.toString());
        }

        function getUrlRoute() {
            const url = new URL(window.location.href);
            let page = url.searchParams.get('page');
            let id = url.searchParams.get('id') || url.searchParams.get('pid') || url.searchParams.get('product_id');

            // TikTok/UTM may rewrite query params. If id exists without page, assume product.
            if (!page && id) page = 'product';
            if (!page) page = 'home';

            // Hash fallback (more robust against query rewriting)
            const hash = (window.location.hash || '').trim();
            if (!id && hash) {
                // supports: #/product/123  OR  #product-123  OR #product=123
                const m = hash.match(/(?:#\/product\/|#product[-=])(\d+)/);
                if (m) {
                    id = m[1];
                    if (!url.searchParams.get('page')) page = 'product';
                }
            }

            return { page, id };
        }

        async function applyRouteFromUrl() {
            const { page, id } = getUrlRoute();

            // If deep-linked to product, don't flash home even if data is not ready yet.
            if (page === 'product' && id) {
                showPage('product', { push: false });
            }

            // If arrays not ready, stop here (initializeApp will re-call this after loading)
            if (!Array.isArray(products) || !Array.isArray(categories)) {
                if (page !== 'product') showPage('home', { push: false });
                return;
            }

            window.__routeApplying = true;
            try {
                if (page === 'product' && id) {
                    const pid = Number(id);
                    if (Number.isFinite(pid) && products.some(p => p.id === pid)) {
                        viewProduct(pid, { push: false });
                        return;
                    }

                    // Try to load product fast from Supabase (for ad previews)
                    if (supabaseReady && supabaseClient && Number.isFinite(pid)) {
                        const p = await loadSingleProductFromSupabase(pid);
                        if (p) {
                            viewProduct(pid, { push: false });
                            return;
                        }
                    }

                    // Fallback
                    showPage('home', { push: false });
                } else if (page === 'track') {
                    showPage('track', { push: false });
                } else if (page === 'admin') {
                    showPage('admin', { push: false });
                } else {
                    showPage('home', { push: false });
                }
            } finally {
                window.__routeApplying = false;
            }
        }

        window.addEventListener('popstate', () => {
            // back/forward navigation
            applyRouteFromUrl();
        });

        // ==================== التهيئة ====================
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const filtered = products.filter(p => p.name.toLowerCase().includes(query));
            const grid = document.getElementById('productsGrid');
            document.getElementById('productCount').textContent = `${filtered.length} منتج`;
            grid.innerHTML = filtered.map(product => {
                const discount = Math.round((1 - product.price / product.oldPrice) * 100);
                return `
                    <div class="product-card bg-white rounded-2xl overflow-hidden shadow-md cursor-pointer" onclick="viewProduct(${product.id})">
                        <div class="relative">
                            <img src="${product.images[0]}" alt="${product.name}" loading="lazy" decoding="async" class="w-full h-40 md:h-48 object-cover" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27400%27%20height%3D%27400%27%3E%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27%23e5e7eb%27/%3E%3Ctext%20x%3D%2750%25%27%20y%3D%2750%25%27%20dominant-baseline%3D%27middle%27%20text-anchor%3D%27middle%27%20fill%3D%27%236b7280%27%20font-family%3D%27Arial%27%20font-size%3D%2724%27%3ENo%20Image%3C/text%3E%3C/svg%3E'">
                            ${product.badge ? `<span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">${product.badge}</span>` : ''}
                            <span class="absolute top-2 left-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">-${discount}%</span>
                        </div>
                        <div class="p-3 md:p-4">
                            <h4 class="font-semibold text-gray-800 text-sm md:text-base mb-2">${product.name}</h4>
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-lg font-bold text-green-600">${product.price.toLocaleString('ar-DZ')} دج</span>
                                <span class="text-sm text-gray-400 line-through">${product.oldPrice.toLocaleString('ar-DZ')} دج</span>
                            </div>
                            <button onclick="event.stopPropagation(); viewProduct(${product.id})" class="w-full py-2 gradient-btn text-white font-semibold rounded-xl text-sm">عرض المنتج</button>
                        </div>
                    </div>
                `;
            }).join('');
        });

        // Initialize
        async function initializeApp() {
            if (appInitialized) return;
            appInitialized = true;

            console.log('🚀 بدء تشغيل التطبيق...');

            // Fix: remove stale cache that may show default products then switch
            purgeDefaultProductsCache();

            // Detect if running inside an iframe (TikTok preview, FB preview, etc.)
            const inIframe = (() => {
                try { return window.self !== window.top; } catch (_) { return true; }
            })();

            // Prevent autofocus issues in cross-origin iframes (console warning)
            if (inIframe) {
                try {
                    HTMLInputElement.prototype.focus = function() {};
                    HTMLTextAreaElement.prototype.focus = function() {};
                } catch (_) {}
            }

            // 0) Apply route EARLY for better UX (avoid showing home first on product deep links)
            // If URL indicates a product, show product page immediately (skeleton) while data loads.
            try {
                const earlyRoute = getUrlRoute();
                if (earlyRoute.page === 'product' && earlyRoute.id) {
                    renderProductPageSkeleton(Number(earlyRoute.id));
                }
            } catch (_) {}

            // 1) عرض فوري من الكاش (سريع)
            // لكن نمنع عرض الكاش إذا كان عبارة عن منتجات افتراضية حتى لا يظهر "فلاش".
            loadCachedDataQuickly();
            if (shouldUseCacheForUI() || categories.length) {
                try {
                    renderCategoryButtons();
                    updateProductCategoryOptions();
                    renderProducts();
                } catch (_) {}
            } else {
                // واجهة سريعة أثناء التحميل لأول مرة
                renderProductsSkeleton(8);
            }

            updateCartCount();

            // 2) تهيئة Supabase
            const ok = initSupabase();
            console.log('Supabase Ready:', ok);

            // 3) تحميل الإعدادات + البيانات بالتوازي ثم تحديث الواجهة مرة واحدة
            if (ok) {
                try {
                    const [settingsOk, dataOk] = await Promise.all([
                        loadStoreSettingsFromSupabase({ includePrivate: false }).catch(() => false),
                        loadDataFromSupabase().catch(() => false)
                    ]);

                    if (settingsOk) {
                        // تحديث UI المبني على الإعدادات
                        updateWhatsAppButton();
                        updateFooterSocialLinks();
                        updateFooterInfo();
                    }

                    if (dataOk) {
                        dataFetchedOnce = true;
                        // حدّث الكاش المحلي بعد التحميل من Supabase
                        try {
                            localStorage.setItem('storeProducts', JSON.stringify(products));
                            localStorage.setItem('storeCategories', JSON.stringify(categories));
                            markCacheAsSupabaseFresh();
                        } catch (_) {}

                        renderCategoryButtons();
                        updateProductCategoryOptions();
                        renderProducts();

                        // إذا الصفحة مفتوحة على منتج (من TikTok/Ad) أعد تطبيق الراوت الآن بدون فلاش
                        try {
                            const r = getUrlRoute();
                            if (r.page === 'product' && r.id) {
                                const pid = Number(r.id);
                                if (Number.isFinite(pid) && products.some(p => p.id === pid)) {
                                    viewProduct(pid, { push: false });
                                }
                            }
                        } catch (_) {}

                        console.log('✅ تم تحميل البيانات من Supabase بنجاح!');
                        console.log('📦 المنتجات:', products.length);
                        console.log('📂 التصنيفات:', categories.length);
                    } else {
                        // إذا فشل Supabase: لا نعرض defaultProducts تلقائياً حتى لا يظهر محتوى خاطئ للزوار.
                        // فقط لو لا يوجد أي بيانات (كاش/سابقة) نُظهر رسالة.
                        if (!products.length) {
                            document.getElementById('productCount').textContent = '';
                            const grid = document.getElementById('productsGrid');
                            if (grid) {
                                grid.innerHTML = '<div class="col-span-full bg-white rounded-2xl p-6 text-center text-gray-600">تعذر تحميل المنتجات حالياً. تحقق من اتصال الإنترنت وحاول تحديث الصفحة.</div>';
                            }
                        }
                        console.log('⚠️ تعذر تحميل بيانات من Supabase');
                    }
                } catch (e) {
                    console.warn('Supabase load failed:', e);
                }
            } else {
                console.log('❌ فشل تهيئة Supabase');
            }

            // تهيئة البيكسلات بعد ما نقرأ الإعدادات (lazy)
            // داخل iframe/preview نوقف تحميل TikTok Pixel Browser لتقليل الأخطاء والبطء
            if (inIframe) {
                settings.enableTikTokPixel = false;
            }
            initializePixels();

            // Apply route from URL (after data is ready)
            await applyRouteFromUrl();

            // مزامنة حالة دخول الأدمن عبر Supabase Auth
            try {
                if (supabaseReady && supabaseClient) {
                    await refreshAdminSession();
                    supabaseClient.auth.onAuthStateChange((_event, _session) => {
                        refreshAdminSession();
                    });
                }
            } catch (e) {
                console.error('Admin session init error:', e);
            }

            console.log('✅ تم تشغيل التطبيق بنجاح!');
        }

        // تشغيل التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            // تأخير بسيط جداً حتى تتهيأ العناصر الأساسية
            requestAnimationFrame(() => initializeApp());
        });

        // Global error handler (حتى لا يبدو أن الأزرار لا تعمل)
        window.addEventListener('error', (e) => {
            console.error('Global error:', e?.error || e);
            try { showNotification('حدث خطأ في الموقع. افتح Console (F12) لمعرفة السبب.', 'error'); } catch (_) {}
        });
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled rejection:', e?.reason || e);
            try { showNotification('حدث خطأ غير متوقع. افتح Console (F12) لمعرفة السبب.', 'error'); } catch (_) {}
        });

        // تشغيل احتياطي (بدون ازدواج) في حال لم يعمل DOMContentLoaded
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            // إذا لم يبدأ التطبيق بعد، شغّله
            setTimeout(() => {
                if (!appInitialized) initializeApp();
            }, 150);
        }
    </script>
</body>
</html>
