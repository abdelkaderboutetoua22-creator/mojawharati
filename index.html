<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="متجرنا - أفضل المنتجات بأسعار مناسبة مع التوصيل لجميع ولايات الجزائر">
    <meta name="robots" content="index, follow">
    <title>متجرنا - التسوق الإلكتروني في الجزائر</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Runtime config generated at build time (see scripts/generate-config.mjs) -->
    <script src="/config.js"></script>

    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    <!-- Meta Pixel base (initialized after consent + config) -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap');

        * { font-family: 'Cairo', sans-serif; }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        .product-card { transition: all 0.3s ease; }

        .gallery-thumb.active {
            border-color: #2563eb;
            opacity: 1;
        }
        .gallery-thumb {
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .gallery-thumb:hover { opacity: 1; }

        .toast { animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .consent-banner { animation: slideUp 0.4s ease; }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-overlay { animation: fadeIn 0.2s ease; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .upsell-popup { animation: bounceIn 0.4s ease; }
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }

        .option-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.35);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between gap-4">
                    <a href="/" onclick="event.preventDefault(); navigate('home')" class="text-2xl font-bold text-blue-600">متجرنا</a>

                    <div class="flex-1 max-w-xl">
                        <div class="relative">
                            <input type="text" id="searchInput"
                                   placeholder="ابحث عن منتج..."
                                   class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   onkeyup="handleSearch(event)">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                    </div>

                    <a href="/cart" onclick="event.preventDefault(); navigate('cart')" class="relative p-2 text-gray-700 hover:text-blue-600 block" aria-label="سلة المشتريات">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <span id="cartBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </a>
                </div>

                <nav id="categoriesNav" class="mt-3 flex gap-2 overflow-x-auto pb-2">
                    <!-- Categories loaded dynamically -->
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main id="mainContent" class="max-w-7xl mx-auto px-4 py-6"></main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-12">
            <div class="max-w-7xl mx-auto px-4 py-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <h3 class="text-lg font-bold mb-4">متجرنا</h3>
                        <p class="text-gray-400">أفضل المنتجات بأسعار مناسبة مع التوصيل لجميع ولايات الجزائر</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4">روابط مهمة</h3>
                        <ul class="space-y-2 text-gray-400">
                            <li><a href="/" onclick="event.preventDefault(); navigate('home')" class="hover:text-white">الرئيسية</a></li>
                            <li><a href="/cart" onclick="event.preventDefault(); navigate('cart')" class="hover:text-white">سلة المشتريات</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-4">تواصل معنا</h3>
                        <div id="socialLinks" class="flex gap-4"></div>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                    <p>© 2024 متجرنا. جميع الحقوق محفوظة.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 left-4 z-50 flex flex-col gap-2"></div>

    <!-- Consent Banner -->
    <div id="consentBanner" class="fixed bottom-0 left-0 right-0 bg-gray-900 text-white p-4 z-50 consent-banner hidden">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <p class="text-sm">نستخدم ملفات تعريف الارتباط لتحسين تجربتك. بالمتابعة، أنت توافق على سياسة الخصوصية.</p>
            <div class="flex gap-3">
                <button onclick="acceptConsent()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 text-sm focus-ring">موافق</button>
                <button onclick="rejectConsent()" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm focus-ring">رفض</button>
            </div>
        </div>
    </div>

    <!-- Upsell Modal -->
    <div id="upsellModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-xl max-w-md w-full p-6 upsell-popup">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold">عرض خاص لك!</h3>
                <button onclick="closeUpsellModal()" class="text-gray-400 hover:text-gray-600" aria-label="إغلاق">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="upsellContent"></div>
        </div>
    </div>

    <!-- Downsell Modal -->
    <div id="downsellModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-xl max-w-md w-full p-6 upsell-popup">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold">انتظر! لدينا عرض أفضل</h3>
                <button onclick="closeDownsellModal()" class="text-gray-400 hover:text-gray-600" aria-label="إغلاق">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="downsellContent"></div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION (loaded from /config.js)
        // ========================================
        const ENV = (window.__APP_CONFIG__ || {});
        const CONFIG = {
            SUPABASE_URL: ENV.NEXT_PUBLIC_SUPABASE_URL || '',
            SUPABASE_ANON_KEY: ENV.NEXT_PUBLIC_SUPABASE_ANON_KEY || '',
            TURNSTILE_SITE_KEY: ENV.NEXT_PUBLIC_TURNSTILE_SITE_KEY || '',
            CLOUDFLARE_IMAGES_ACCOUNT: ENV.NEXT_PUBLIC_CF_IMAGES_ACCOUNT_ID || '',
            GA_MEASUREMENT_ID: ENV.NEXT_PUBLIC_GA_MEASUREMENT_ID || '',
            META_PIXEL_ID: ENV.NEXT_PUBLIC_META_PIXEL_ID || '',
            TIKTOK_PIXEL_ID: ENV.NEXT_PUBLIC_TIKTOK_PIXEL_ID || '',
            ABANDONED_CART_MINUTES: 60
        };

        function ensureConfigOrShowError() {
            const missing = [];
            if (!CONFIG.SUPABASE_URL) missing.push('NEXT_PUBLIC_SUPABASE_URL');
            if (!CONFIG.SUPABASE_ANON_KEY) missing.push('NEXT_PUBLIC_SUPABASE_ANON_KEY');
            if (!CONFIG.TURNSTILE_SITE_KEY) missing.push('NEXT_PUBLIC_TURNSTILE_SITE_KEY');
            if (!CONFIG.CLOUDFLARE_IMAGES_ACCOUNT) missing.push('NEXT_PUBLIC_CF_IMAGES_ACCOUNT_ID');
            if (missing.length) {
                console.warn('Missing config:', missing);
                showToast('إعدادات المتجر غير مكتملة. راجع INSTALL.md', 'error');
                return false;
            }
            return true;
        }

        // ========================================
        // STATE
        // ========================================
        const state = {
            cart: JSON.parse(localStorage.getItem('cart') || '[]'),
            cartId: localStorage.getItem('cartId') || null,
            currentRoute: 'home',
            routeParams: {},
            products: [],
            categories: [],
            wilayas: [],
            shippingRates: [],
            settings: {},
            upsellRules: [],
            downsellRules: [],
            consentGiven: localStorage.getItem('consentGiven'),
            lastActivity: Date.now(),
            currentProductSelection: { size: null, color: null },
            // Turnstile (SPA-safe)
            turnstileToken: null,
            turnstileWidgetId: null
        };

        // ========================================
        // UTILS
        // ========================================
        function generateEventId() {
            return 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('ar-DZ', { style: 'decimal', minimumFractionDigits: 0 }).format(price) + ' د.ج';
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast px-4 py-3 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function cartLineId(productId, options) {
            const size = options?.size ? encodeURIComponent(options.size) : '';
            const color = options?.color ? encodeURIComponent(options.color) : '';
            return `${productId}::${size}::${color}`;
        }

        function formatOptions(options) {
            if (!options) return '';
            const parts = [];
            if (options.size) parts.push(`المقاس: ${options.size}`);
            if (options.color) parts.push(`اللون: ${options.color}`);
            return parts.join(' - ');
        }

        // ========================================
        // SUPABASE REST HELPERS
        // ========================================
        async function supabaseQuery(table, options = {}) {
            let url = `${CONFIG.SUPABASE_URL}/rest/v1/${table}`;
            const params = new URLSearchParams();

            if (options.select) params.append('select', options.select);
            if (options.filter) {
                Object.entries(options.filter).forEach(([key, value]) => params.append(key, value));
            }
            if (options.order) params.append('order', options.order);
            if (options.limit) params.append('limit', options.limit);

            const queryString = params.toString();
            if (queryString) url += '?' + queryString;

            const response = await fetch(url, {
                headers: {
                    'apikey': CONFIG.SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                }
            });

            if (!response.ok) throw new Error('API Error');
            return response.json();
        }

        async function supabaseInsert(table, data) {
            const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/${table}`, {
                method: 'POST',
                headers: {
                    'apikey': CONFIG.SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Insert Error');
            return response.json();
        }

        function uuidv4() {
            // RFC4122 v4
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function callEdgeFunction(name, body) {
            const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/${name}`, {
                method: 'POST',
                headers: {
                    // Some Supabase setups require apikey on Functions requests.
                    'apikey': CONFIG.SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            const ct = String(response.headers.get('content-type') || '').toLowerCase();
            const data = ct.includes('application/json') ? await response.json().catch(() => ({})) : {};
            if (!response.ok) throw new Error(data.error || `Function Error (HTTP ${response.status})`);
            return data;
        }

        // ========================================
        // TRACKING
        // ========================================
        function initTracking() {
            if (state.consentGiven !== 'true') return;

            // GA4 dynamic loader
            if (CONFIG.GA_MEASUREMENT_ID && !window.gtag) {
                const s = document.createElement('script');
                s.async = true;
                s.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(CONFIG.GA_MEASUREMENT_ID)}`;
                document.head.appendChild(s);

                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);} // eslint-disable-line
                gtag('js', new Date());
                gtag('config', CONFIG.GA_MEASUREMENT_ID);
                window.gtag = gtag;
            }

            // Meta Pixel init
            if (CONFIG.META_PIXEL_ID && typeof fbq !== 'undefined') {
                fbq('init', CONFIG.META_PIXEL_ID);
                fbq('track', 'PageView');
            }

            // TikTok Pixel init
            if (CONFIG.TIKTOK_PIXEL_ID && !window.ttq) {
                !function (w, d, t) {
                    w.TiktokAnalyticsObject=t;
                    var ttq=w[t]=w[t]||[];
                    ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"],
                    ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))} };
                    for(var i=0;i<ttq.methods.length;i++) ttq.setAndDefer(ttq,ttq.methods[i]);
                    ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++) ttq.setAndDefer(e,ttq.methods[n]);return e};
                    ttq.load=function(e,n){
                        var i="https://analytics.tiktok.com/i18n/pixel/events.js";
                        ttq._i=ttq._i||{};ttq._i[e]=[];ttq._i[e]._u=i;ttq._t=ttq._t||{};ttq._t[e]=+new Date;ttq._o=ttq._o||{};ttq._o[e]=n||{};
                        var o=d.createElement("script");o.type="text/javascript";o.async=!0;o.src=i+"?sdkid="+e+"&lib="+t;
                        var a=d.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)
                    };
                    ttq.load(CONFIG.TIKTOK_PIXEL_ID);
                    ttq.page();
                }(window, document, 'ttq');
            }
        }

        function trackEvent(eventName, params = {}) {
            if (state.consentGiven !== 'true') return;

            const eventId = generateEventId();
            params.event_id = eventId;

            // GA4: map to ecommerce events
            if (window.gtag) {
                const gaMap = {
                    'ViewContent': 'view_item',
                    'AddToCart': 'add_to_cart',
                    'InitiateCheckout': 'begin_checkout',
                    'Purchase': 'purchase'
                };
                const mapped = gaMap[eventName] || eventName;
                gtag('event', mapped, params);
            }

            // Meta Pixel
            if (typeof fbq !== 'undefined') {
                const fbParams = { ...params };
                const map = {
                    'ViewContent': 'ViewContent',
                    'AddToCart': 'AddToCart',
                    'InitiateCheckout': 'InitiateCheckout',
                    'Purchase': 'Purchase'
                };
                if (map[eventName]) {
                    fbq('track', map[eventName], fbParams, { eventID: eventId });
                }
            }

            // TikTok Pixel
            if (window.ttq) {
                const ttMap = {
                    'ViewContent': 'ViewContent',
                    'AddToCart': 'AddToCart',
                    'InitiateCheckout': 'InitiateCheckout',
                    'Purchase': 'CompletePayment'
                };
                const ttEvent = ttMap[eventName];
                if (ttEvent) {
                    const contents = (params.items || []).map(it => ({
                        content_id: it.item_id || it.id,
                        content_name: it.item_name,
                        quantity: it.quantity,
                        price: it.price
                    }));
                    const payload = {
                        content_id: params.content_ids?.[0],
                        content_name: params.content_name,
                        value: params.value,
                        currency: params.currency || 'DZD',
                        contents
                    };
                    window.ttq.track(ttEvent, payload);
                }
            }

            return eventId;
        }

        // ========================================
        // CONSENT
        // ========================================
        function checkConsent() {
            if (state.consentGiven === null) {
                document.getElementById('consentBanner').classList.remove('hidden');
            } else if (state.consentGiven === 'true') {
                initTracking();
            }
        }

        function acceptConsent() {
            localStorage.setItem('consentGiven', 'true');
            state.consentGiven = 'true';
            document.getElementById('consentBanner').classList.add('hidden');
            initTracking();
        }

        function rejectConsent() {
            localStorage.setItem('consentGiven', 'false');
            state.consentGiven = 'false';
            document.getElementById('consentBanner').classList.add('hidden');
        }

        // ========================================
        // WHATSAPP
        // ========================================
        function buildWhatsAppLink(input, message = '') {
            const raw = String(input || '').trim();
            if (!raw) return '';

            // If already wa.me / api.whatsapp.com link
            if (raw.includes('wa.me') || raw.includes('api.whatsapp.com') || raw.startsWith('https://chat.whatsapp.com')) {
                const url = raw;
                if (!message) return url;
                const sep = url.includes('?') ? '&' : '?';
                return url + sep + 'text=' + encodeURIComponent(message);
            }

            // If it's a phone number: accept 0XXXXXXXXX or +213XXXXXXXXX or 213XXXXXXXXX
            let digits = raw.replace(/\s+/g, '').replace(/[^\d+]/g, '');
            if (digits.startsWith('+')) digits = digits.slice(1);
            if (digits.startsWith('0') && digits.length === 10) digits = '213' + digits.slice(1);
            if (digits.startsWith('213') && digits.length >= 11) {
                const base = 'https://wa.me/' + digits;
                return message ? base + '?text=' + encodeURIComponent(message) : base;
            }

            // Fallback: treat as URL
            try {
                const u = new URL(raw);
                if (!message) return u.toString();
                u.searchParams.set('text', message);
                return u.toString();
            } catch {
                return '';
            }
        }

        // ========================================
        // IMAGE HANDLING
        // ========================================
        function getImageUrl(imageId, variant = 'public') {
            if (!imageId) {
                const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400">
                    <defs>
                        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0" stop-color="#f3f4f6"/>
                            <stop offset="1" stop-color="#e5e7eb"/>
                        </linearGradient>
                    </defs>
                    <rect width="400" height="400" fill="url(#g)"/>
                    <rect x="40" y="40" width="320" height="320" rx="24" fill="#ffffff" opacity="0.7"/>
                    <path d="M120 250l45-55 35 40 35-30 65 80H120z" fill="#d1d5db"/>
                    <circle cx="160" cy="160" r="18" fill="#cbd5e1"/>
                    <text x="200" y="310" text-anchor="middle" font-family="Cairo, Arial" font-size="20" fill="#6b7280">لا توجد صورة</text>
                </svg>`;
                return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
            }
            if (imageId.startsWith('http')) return imageId;
            return `https://imagedelivery.net/${CONFIG.CLOUDFLARE_IMAGES_ACCOUNT}/${imageId}/${variant}`;
        }

        // ========================================
        // CART
        // ========================================
        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            const count = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(state.cart));
            updateCartBadge();
            syncCartToServer();
        }

        async function syncCartToServer() {
            // Best-effort sync only
            // NOTE: With strict RLS, INSERT/UPDATE can be allowed without SELECT.
            // PostgREST "return=representation" may require SELECT policy on the same table.
            // To avoid RLS-related 401 while keeping security, we:
            // - Generate a local cartId (UUID) once
            // - Use Prefer: return=minimal so PostgREST doesn't need to return the inserted row
            // - Only PATCH by id (no SELECT required)
            try {
                if (!CONFIG.SUPABASE_URL || !CONFIG.SUPABASE_ANON_KEY) return;

                if (!state.cartId) {
                    state.cartId = uuidv4();
                    localStorage.setItem('cartId', state.cartId);

                    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/carts`, {
                        method: 'POST',
                        headers: {
                            'apikey': CONFIG.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            id: state.cartId,
                            items: state.cart,
                            total_value: calculateSubtotal()
                        })
                    });
                } else {
                    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/carts?id=eq.${state.cartId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': CONFIG.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            items: state.cart,
                            total_value: calculateSubtotal(),
                            updated_at: new Date().toISOString()
                        })
                    });
                }
            } catch (e) {
                // ignore
            }
        }

        function addToCart(product, quantity = 1, options = null) {
            const lineId = cartLineId(product.id, options);
            const existing = state.cart.find(item => item.lineId === lineId);

            if (existing) {
                existing.quantity += quantity;
            } else {
                state.cart.push({
                    lineId,
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.images?.[0] || '',
                    quantity,
                    options: options || null
                });
            }

            saveCart();
            showToast('تمت الإضافة إلى السلة');

            trackEvent('AddToCart', {
                content_ids: [product.id],
                content_name: product.name,
                content_type: 'product',
                value: product.price * quantity,
                currency: 'DZD'
            });

            checkUpsell(product.id);
        }

        function removeFromCart(lineId) {
            const item = state.cart.find(i => i.lineId === lineId);
            if (item) {
                checkDownsell(item.id);
            }
            state.cart = state.cart.filter(item => item.lineId !== lineId);
            saveCart();
            if (state.currentRoute === 'cart') renderCart();
        }

        function updateQuantity(lineId, quantity) {
            const item = state.cart.find(i => i.lineId === lineId);
            if (item) {
                item.quantity = Math.max(1, quantity);
                saveCart();
                if (state.currentRoute === 'cart') renderCart();
            }
        }

        function calculateSubtotal() {
            return state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        // ========================================
        // UPSELL / DOWNSELL
        // ========================================
        function checkUpsell(productId) {
            const rule = state.upsellRules.find(r => r.trigger_product_id === productId);
            if (rule && rule.upsell_product) {
                showUpsellModal(rule.upsell_product, rule.discount_percent);
            }
        }

        function checkDownsell(productId) {
            const rule = state.downsellRules.find(r => r.trigger_product_id === productId);
            if (rule && rule.downsell_product) {
                showDownsellModal(rule.downsell_product, rule.discount_percent);
            }
        }

        function showUpsellModal(product, discount) {
            const finalPrice = discount ? product.price * (1 - discount / 100) : product.price;
            document.getElementById('upsellContent').innerHTML = `
                <div class="flex gap-4">
                    <img src="${getImageUrl(product.images?.[0])}" alt="${escapeHtml(product.name)}" class="w-24 h-24 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-bold">${escapeHtml(product.name)}</h4>
                        ${discount ? `
                            <p class="text-gray-400 line-through text-sm">${formatPrice(product.price)}</p>
                            <p class="text-green-600 font-bold">${formatPrice(finalPrice)}</p>
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">خصم ${discount}%</span>
                        ` : `
                            <p class="text-blue-600 font-bold">${formatPrice(product.price)}</p>
                        `}
                    </div>
                </div>
                <button onclick="addUpsellToCart('${product.id}', ${finalPrice})" class="w-full mt-4 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold focus-ring">
                    أضف إلى السلة
                </button>
            `;
            document.getElementById('upsellModal').classList.remove('hidden');
        }

        function addUpsellToCart(productId, price) {
            // In minimal mode we might not have full products list; rely on upsell_product payload.
            const rule = state.upsellRules.find(r => r.upsell_product?.id === productId);
            const product = rule?.upsell_product || state.products.find(p => p.id === productId);
            if (product) {
                addToCart({ ...product, price });
            }
            closeUpsellModal();
        }

        function closeUpsellModal() {
            document.getElementById('upsellModal').classList.add('hidden');
        }

        function showDownsellModal(product, discount) {
            const finalPrice = discount ? product.price * (1 - discount / 100) : product.price;
            document.getElementById('downsellContent').innerHTML = `
                <p class="text-gray-600 mb-4">ربما يناسبك هذا المنتج البديل:</p>
                <div class="flex gap-4">
                    <img src="${getImageUrl(product.images?.[0])}" alt="${escapeHtml(product.name)}" class="w-24 h-24 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-bold">${escapeHtml(product.name)}</h4>
                        ${discount ? `
                            <p class="text-gray-400 line-through text-sm">${formatPrice(product.price)}</p>
                            <p class="text-green-600 font-bold">${formatPrice(finalPrice)}</p>
                            <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">خصم ${discount}%</span>
                        ` : `
                            <p class="text-blue-600 font-bold">${formatPrice(product.price)}</p>
                        `}
                    </div>
                </div>
                <div class="flex gap-3 mt-4">
                    <button onclick="addDownsellToCart('${product.id}', ${finalPrice})" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-bold focus-ring">
                        نعم، أريد هذا
                    </button>
                    <button onclick="closeDownsellModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 focus-ring">
                        لا شكراً
                    </button>
                </div>
            `;
            document.getElementById('downsellModal').classList.remove('hidden');
        }

        function addDownsellToCart(productId, price) {
            const rule = state.downsellRules.find(r => r.downsell_product?.id === productId);
            const product = rule?.downsell_product || state.products.find(p => p.id === productId);
            if (product) {
                addToCart({ ...product, price });
            }
            closeDownsellModal();
        }

        function closeDownsellModal() {
            document.getElementById('downsellModal').classList.add('hidden');
        }

        // ========================================
        // ROUTING (path-based + hash fallback)
        // ========================================
        function navigate(route, params = {}) {
            state.currentRoute = route;
            state.routeParams = params;

            let path = '/';
            switch(route) {
                case 'home': path = '/'; break;
                case 'category': path = `/category/${params.id}`; break;
                case 'product':
                    if (params.slug) path = `/product/${params.slug}`;
                    else path = `/products/${params.id}`;
                    break;
                case 'cart': path = '/cart'; break;
                case 'checkout': path = '/checkout'; break;
                case 'order-success':
                    path = `/order-success/${params.orderId}${params.publicToken ? '/' + params.publicToken : ''}`;
                    break;
                case 'search': path = `/search/${encodeURIComponent(params.query || '')}`; break;
            }

            if (window.location.pathname !== path) {
                history.pushState(null, '', path);
            }

            renderCurrentRoute();
        }

        function parseRouteFromLocation() {
            const path = window.location.pathname || '/';
            const hash = window.location.hash || '';

            // Path routing
            if (path === '/' || path === '') return { route: 'home', params: {} };
            const seg = path.split('/').filter(Boolean);

            if (seg[0] === 'products' && seg[1]) return { route: 'product', params: { id: seg[1] } };
            if (seg[0] === 'product' && seg[1]) return { route: 'product', params: { slug: seg[1] } };
            if (seg[0] === 'category' && seg[1]) return { route: 'category', params: { id: seg[1] } };
            if (seg[0] === 'cart') return { route: 'cart', params: {} };
            if (seg[0] === 'checkout') return { route: 'checkout', params: {} };
            if (seg[0] === 'order-success' && seg[1]) return { route: 'order-success', params: { orderId: seg[1], publicToken: seg[2] || '' } };
            if (seg[0] === 'search' && seg[1]) return { route: 'search', params: { query: decodeURIComponent(seg.slice(1).join('/')) } };

            // Hash fallback (old links)
            if (hash.startsWith('#/')) {
                const hpath = hash.slice(2);
                const hseg = hpath.split('/').filter(Boolean);
                if (!hseg.length) return { route: 'home', params: {} };
                if (hseg[0] === 'product' && hseg[1]) return { route: 'product', params: { id: hseg[1] } };
                if (hseg[0] === 'category' && hseg[1]) return { route: 'category', params: { id: hseg[1] } };
                if (hseg[0] === 'cart') return { route: 'cart', params: {} };
                if (hseg[0] === 'checkout') return { route: 'checkout', params: {} };
                if (hseg[0] === 'order-success' && hseg[1]) return { route: 'order-success', params: { orderId: hseg[1] } };
                if (hseg[0] === 'search' && hseg[1]) return { route: 'search', params: { query: decodeURIComponent(hseg[1]) } };
            }

            return { route: 'home', params: {} };
        }

        function handleRouteChange() {
            const { route, params } = parseRouteFromLocation();
            state.currentRoute = route;
            state.routeParams = params;
            renderCurrentRoute();
        }

        window.addEventListener('popstate', handleRouteChange);
        window.addEventListener('hashchange', handleRouteChange);

        // ========================================
        // RENDER
        // ========================================
        function renderCurrentRoute() {
            const route = state.currentRoute;
            const params = state.routeParams;

            switch(route) {
                case 'home': renderHome(); break;
                case 'category': renderCategory(params.id); break;
                case 'product': renderProduct(params); break;
                case 'cart': renderCart(); break;
                case 'checkout': renderCheckout(); break;
                case 'order-success': renderOrderSuccess(params.orderId); break;
                case 'search': renderSearchResults(params.query); break;
                default: renderNotFound();
            }

            window.scrollTo(0, 0);
        }

        function renderNotFound() {
            const main = document.getElementById('mainContent');
            document.title = 'الصفحة غير موجودة - متجرنا';
            main.innerHTML = `
                <div class="max-w-lg mx-auto text-center py-16">
                    <h1 class="text-2xl font-bold mb-3">الصفحة غير موجودة</h1>
                    <p class="text-gray-600 mb-6">قد يكون الرابط غير صحيح أو تم حذف المحتوى.</p>
                    <button onclick="navigate('home')" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 focus-ring">العودة للرئيسية</button>
                </div>
            `;
        }

        function renderHome() {
            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <section class="bg-gradient-to-l from-blue-600 to-blue-800 rounded-2xl p-8 mb-8 text-white">
                    <div class="max-w-2xl">
                        <h1 class="text-3xl md:text-4xl font-bold mb-4">مرحباً بك في متجرنا</h1>
                        <p class="text-lg opacity-90 mb-6">اكتشف أفضل المنتجات بأسعار لا تُقاوم مع توصيل سريع لجميع الولايات</p>
                        <button onclick="document.getElementById('productsGrid').scrollIntoView({behavior: 'smooth'})" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-bold hover:bg-gray-100 focus-ring">
                            تسوق الآن
                        </button>
                    </div>
                </section>

                <section id="productsGrid">
                    <h2 class="text-2xl font-bold mb-6">منتجاتنا</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="productsContainer">
                        ${renderProductsGrid(state.products)}
                    </div>
                </section>
            `;
        }

        function renderProductsGrid(products) {
            if (!products.length) {
                return '<p class="col-span-full text-center text-gray-500 py-12">لا توجد منتجات</p>';
            }

            return products.map(product => {
                const href = product.slug ? `/product/${product.slug}` : `/products/${product.id}`;
                return `
                    <a href="${href}"
                       class="product-card bg-white rounded-xl shadow-sm overflow-hidden cursor-pointer block"
                       onclick="event.preventDefault(); navigate('product', ${product.slug ? `{slug: '${product.slug}'}` : `{id: '${product.id}'}`})">
                        <div class="aspect-square relative">
                            <img src="${getImageUrl(product.images?.[0], 'thumbnail')}"
                                 alt="${escapeHtml(product.name)}"
                                 loading="lazy"
                                 class="w-full h-full object-cover">
                            ${product.compare_price ? `
                                <span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded">تخفيض</span>
                            ` : ''}
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-sm mb-2 line-clamp-2">${escapeHtml(product.name)}</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-blue-600 font-bold">${formatPrice(product.price)}</span>
                                ${product.compare_price ? `<span class="text-gray-400 line-through text-sm">${formatPrice(product.compare_price)}</span>` : ''}
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
        }

        function renderCategory(categoryId) {
            const category = state.categories.find(c => c.id === categoryId);
            const products = state.products.filter(p => p.category_id === categoryId);

            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <nav class="flex items-center gap-2 text-sm mb-6">
                    <a href="/" onclick="event.preventDefault(); navigate('home')" class="text-blue-600 hover:underline">الرئيسية</a>
                    <span class="text-gray-400">/</span>
                    <span class="text-gray-600">${escapeHtml(category?.name || 'التصنيف')}</span>
                </nav>

                <h1 class="text-2xl font-bold mb-6">${escapeHtml(category?.name || 'التصنيف')}</h1>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    ${renderProductsGrid(products)}
                </div>
            `;
        }

        async function fetchProductById(id) {
            const rows = await supabaseQuery('products', {
                filter: { id: `eq.${id}`, is_active: 'eq.true' },
                limit: 1
            });
            return rows?.[0] || null;
        }

        async function fetchProductBySlug(slug) {
            const rows = await supabaseQuery('products', {
                filter: { slug: `eq.${slug}`, is_active: 'eq.true' },
                limit: 1
            });
            return rows?.[0] || null;
        }

        async function loadUpsellRulesForTrigger(triggerProductId) {
            try {
                state.upsellRules = await supabaseQuery('upsell_rules', {
                    filter: { is_active: 'eq.true', type: 'eq.upsell', trigger_product_id: `eq.${triggerProductId}` },
                    select: '*,upsell_product:products!upsell_product_id(*)'
                });
            } catch { state.upsellRules = []; }
        }

        async function loadDownsellRulesForTrigger(triggerProductId) {
            try {
                state.downsellRules = await supabaseQuery('upsell_rules', {
                    filter: { is_active: 'eq.true', type: 'eq.downsell', trigger_product_id: `eq.${triggerProductId}` },
                    select: '*,downsell_product:products!upsell_product_id(*)'
                });
            } catch { state.downsellRules = []; }
        }

        async function renderProduct(params) {
            let product = null;

            try {
                if (params.id) {
                    product = state.products.find(p => p.id === params.id) || await fetchProductById(params.id);
                } else if (params.slug) {
                    product = await fetchProductBySlug(params.slug);
                }
            } catch (e) {
                product = null;
            }

            if (!product) {
                renderNotFound();
                return;
            }

            // Load only relevant upsell/downsell rules for this product (avoid loading full catalog)
            await Promise.all([
                loadUpsellRulesForTrigger(product.id),
                loadDownsellRulesForTrigger(product.id)
            ]);

            // SEO
            document.title = `${product.name} - متجرنا`;
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                const descText = product.description ?
                    product.description.replace(/<[^>]*>/g, '').substring(0, 160) :
                    `${product.name} - اشترِ الآن بسعر ${formatPrice(product.price)} مع التوصيل لجميع ولايات الجزائر`;
                metaDesc.setAttribute('content', descText);
            }

            trackEvent('ViewContent', {
                content_ids: [product.id],
                content_name: product.name,
                content_type: 'product',
                value: product.price,
                currency: 'DZD'
            });

            // Reviews
            let reviews = [];
            try {
                reviews = await supabaseQuery('reviews', {
                    filter: { product_id: `eq.${product.id}`, status: 'eq.approved' },
                    order: 'created_at.desc',
                    limit: 10
                });
            } catch (e) {}

            const category = state.categories.find(c => c.id === product.category_id);
            const images = product.images || [];

            // Description: safest approach: treat as plain text always.
            const descriptionPlain = product.description ? escapeHtml(String(product.description)).replace(/\n/g, '<br>') : '';

            // Options default selections
            const sizes = Array.isArray(product.sizes) ? product.sizes : [];
            const colors = Array.isArray(product.colors) ? product.colors : [];
            state.currentProductSelection = {
                size: sizes[0] || null,
                color: colors[0] || null
            };

            // Upsell suggestions on product page
            const upsellProducts = state.upsellRules
                .map(r => r.upsell_product)
                .filter(Boolean);

            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <nav class="flex items-center gap-2 text-sm mb-6">
                    <a href="/" onclick="event.preventDefault(); navigate('home')" class="text-blue-600 hover:underline">الرئيسية</a>
                    ${category ? `
                        <span class="text-gray-400">/</span>
                        <a href="/category/${category.id}" onclick="event.preventDefault(); navigate('category', {id: '${category.id}'})" class="text-blue-600 hover:underline">${escapeHtml(category.name)}</a>
                    ` : ''}
                    <span class="text-gray-400">/</span>
                    <span class="text-gray-600">${escapeHtml(product.name)}</span>
                </nav>

                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <div class="aspect-square rounded-xl overflow-hidden bg-gray-100 mb-4">
                            <img id="mainProductImage" src="${getImageUrl(images[0])}" alt="${escapeHtml(product.name)}" class="w-full h-full object-cover">
                        </div>
                        ${images.length > 1 ? `
                            <div class="flex gap-2 overflow-x-auto">
                                ${images.map((img, i) => `
                                    <button type="button" onclick="changeMainImage('${img}', this)" class="gallery-thumb w-20 h-20 rounded-lg overflow-hidden border-2 border-transparent ${i === 0 ? 'active' : ''}" aria-label="عرض الصورة ${i + 1}">
                                        <img src="${getImageUrl(img, 'thumbnail')}" alt="صورة ${i + 1}" class="w-full h-full object-cover">
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <div>
                        <h1 class="text-2xl font-bold mb-4">${escapeHtml(product.name)}</h1>

                        <div class="flex items-center gap-3 mb-6">
                            <span class="text-3xl font-bold text-blue-600">${formatPrice(product.price)}</span>
                            ${product.compare_price ? `
                                <span class="text-xl text-gray-400 line-through">${formatPrice(product.compare_price)}</span>
                                <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-sm">وفر ${Math.round((1 - product.price / product.compare_price) * 100)}%</span>
                            ` : ''}
                        </div>

                        ${sizes.length ? `
                            <div class="mb-5">
                                <h3 class="font-bold mb-2">المقاس</h3>
                                <div class="flex flex-wrap gap-2" id="sizeOptions">
                                    ${sizes.map(s => `
                                        <button type="button" class="option-btn px-3 py-2 border rounded-lg text-sm hover:bg-blue-50 focus-ring ${s === sizes[0] ? 'active' : ''}" onclick="selectProductOption('size', '${escapeHtml(String(s)).replace(/'/g, "\\'")}')" aria-label="اختيار المقاس ${escapeHtml(String(s))}">${escapeHtml(String(s))}</button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${colors.length ? `
                            <div class="mb-5">
                                <h3 class="font-bold mb-2">اللون</h3>
                                <div class="flex flex-wrap gap-2" id="colorOptions">
                                    ${colors.map(c => `
                                        <button type="button" class="option-btn px-3 py-2 border rounded-lg text-sm hover:bg-blue-50 focus-ring ${c === colors[0] ? 'active' : ''}" onclick="selectProductOption('color', '${escapeHtml(String(c)).replace(/'/g, "\\'")}')" aria-label="اختيار اللون ${escapeHtml(String(c))}">${escapeHtml(String(c))}</button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="flex items-center gap-4 mb-6">
                            <div class="flex items-center border rounded-lg">
                                <button type="button" onclick="decrementQty()" class="px-4 py-2 hover:bg-gray-100 focus-ring" aria-label="تقليل الكمية">-</button>
                                <input type="number" id="productQty" value="1" min="1" class="w-16 text-center border-x py-2 focus:outline-none" aria-label="الكمية">
                                <button type="button" onclick="incrementQty()" class="px-4 py-2 hover:bg-gray-100 focus-ring" aria-label="زيادة الكمية">+</button>
                            </div>
                        </div>

                        <!-- CTA Buttons: Buy Now (RIGHT/Primary) + Add to Cart (LEFT/Secondary) -->
                        <div class="flex gap-3 mb-6">
                            <button id="addToCartBtn" onclick="handleAddToCart('${product.id}')" class="flex-1 border-2 border-blue-600 text-blue-600 py-4 rounded-xl font-bold text-lg hover:bg-blue-50 transition focus-ring disabled:opacity-50 disabled:cursor-not-allowed" aria-label="إضافة إلى السلة">
                                إضافة إلى السلة
                            </button>
                            <button id="buyNowBtn" onclick="handleBuyNow('${product.id}')" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 transition focus-ring disabled:opacity-50 disabled:cursor-not-allowed" aria-label="إشتري الآن">
                                إشتري الآن
                            </button>
                        </div>

                        <div class="p-4 bg-gray-50 rounded-xl">
                            <h3 class="font-bold mb-2">معلومات التوصيل</h3>
                            <p class="text-sm text-gray-600">التوصيل متاح لجميع الولايات الـ 58</p>
                            <p class="text-sm text-gray-600">الدفع عند الاستلام</p>
                        </div>
                    </div>
                </div>

                ${descriptionPlain ? `
                    <section class="mt-8 bg-white rounded-xl p-6 shadow-sm">
                        <h2 class="text-xl font-bold mb-4">وصف المنتج</h2>
                        <div class="text-gray-700 leading-relaxed">${descriptionPlain}</div>
                    </section>
                ` : ''}

                ${upsellProducts.length > 0 ? `
                    <section class="mt-12">
                        <h2 class="text-xl font-bold mb-4">منتجات مقترحة</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${renderProductsGrid(upsellProducts)}
                        </div>
                    </section>
                ` : ''}

                <section class="mt-12">
                    <h2 class="text-xl font-bold mb-6">تقييمات العملاء</h2>

                    <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                        <h3 class="font-bold mb-4">أضف تقييمك</h3>
                        <form onsubmit="submitReview(event, '${product.id}')" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">الاسم</label>
                                <input type="text" name="reviewer_name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">التقييم</label>
                                <div class="flex gap-2" id="ratingStars">
                                    ${[1,2,3,4,5].map(i => `
                                        <button type="button" onclick="setRating(${i})" class="text-2xl text-gray-300 hover:text-yellow-400" aria-label="تقييم ${i}">★</button>
                                    `).join('')}
                                </div>
                                <input type="hidden" name="rating" id="ratingInput" value="5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">التعليق</label>
                                <textarea name="comment" rows="3" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus-ring">إرسال التقييم</button>
                        </form>
                    </div>

                    <div class="space-y-4">
                        ${reviews.length > 0 ? reviews.map(review => `
                            <div class="bg-white rounded-xl p-6 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-bold">${escapeHtml(review.reviewer_name)}</span>
                                    <div class="flex text-yellow-400">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</div>
                                </div>
                                <p class="text-gray-600">${escapeHtml(review.comment || '')}</p>
                                <span class="text-xs text-gray-400 mt-2 block">${new Date(review.created_at).toLocaleDateString('ar-DZ')}</span>
                            </div>
                        `).join('') : `
                            <p class="text-center text-gray-500 py-8">لا توجد تقييمات بعد</p>
                        `}
                    </div>
                </section>
            `;

            setRating(5);
        }

        function changeMainImage(imageId, btnEl) {
            document.getElementById('mainProductImage').src = getImageUrl(imageId);
            document.querySelectorAll('.gallery-thumb').forEach(btn => btn.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');
        }

        function incrementQty() {
            const input = document.getElementById('productQty');
            input.value = parseInt(input.value) + 1;
        }

        function decrementQty() {
            const input = document.getElementById('productQty');
            input.value = Math.max(1, parseInt(input.value) - 1);
        }

        function selectProductOption(type, value) {
            if (type === 'size') {
                state.currentProductSelection.size = value;
                document.querySelectorAll('#sizeOptions .option-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === value);
                });
            }
            if (type === 'color') {
                state.currentProductSelection.color = value;
                document.querySelectorAll('#colorOptions .option-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === value);
                });
            }
        }

        function setRating(rating) {
            document.getElementById('ratingInput').value = rating;
            const stars = document.querySelectorAll('#ratingStars button');
            stars.forEach((star, i) => {
                star.classList.toggle('text-yellow-400', i < rating);
                star.classList.toggle('text-gray-300', i >= rating);
            });
        }

        async function submitReview(e, productId) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            try {
                await supabaseInsert('reviews', {
                    product_id: productId,
                    reviewer_name: formData.get('reviewer_name'),
                    rating: parseInt(formData.get('rating')),
                    comment: formData.get('comment'),
                    status: 'pending'
                });

                showToast('تم إرسال تقييمك وسيظهر بعد المراجعة');
                form.reset();
                setRating(5);
            } catch (error) {
                showToast('حدث خطأ، حاول مرة أخرى', 'error');
            }
        }

        function getSelectedOptions() {
            const options = {};
            if (state.currentProductSelection.size) options.size = state.currentProductSelection.size;
            if (state.currentProductSelection.color) options.color = state.currentProductSelection.color;
            return Object.keys(options).length ? options : null;
        }

        function addProductToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            const qty = parseInt(document.getElementById('productQty')?.value || 1);
            const options = getSelectedOptions();

            if (product) {
                addToCart(product, qty, options);
                return;
            }

            // Minimal mode: fetch product then add
            fetchProductById(productId).then(p => {
                if (p) addToCart(p, qty, options);
            });
        }

        // Button state management to prevent double submissions
        let isProcessingAction = false;

        function handleAddToCart(productId) {
            if (isProcessingAction) return;
            isProcessingAction = true;

            const addBtn = document.getElementById('addToCartBtn');
            const buyBtn = document.getElementById('buyNowBtn');
            if (addBtn) addBtn.disabled = true;
            if (buyBtn) buyBtn.disabled = true;

            try {
                addProductToCart(productId);
            } finally {
                setTimeout(() => {
                    if (addBtn) addBtn.disabled = false;
                    if (buyBtn) buyBtn.disabled = false;
                    isProcessingAction = false;
                }, 500);
            }
        }

        async function handleBuyNow(productId) {
            if (isProcessingAction) return;
            isProcessingAction = true;

            const addBtn = document.getElementById('addToCartBtn');
            const buyBtn = document.getElementById('buyNowBtn');
            if (addBtn) addBtn.disabled = true;
            if (buyBtn) buyBtn.disabled = true;

            try {
                const qty = parseInt(document.getElementById('productQty')?.value || 1);
                const options = getSelectedOptions();

                // Use product from state if available, otherwise fetch
                let product = state.products.find(p => p.id === productId);
                if (!product) {
                    product = await fetchProductById(productId);
                }

                if (product) {
                    // Add without toast (redirect)
                    const lineId = cartLineId(product.id, options);
                    const existing = state.cart.find(item => item.lineId === lineId);
                    if (existing) existing.quantity += qty;
                    else state.cart.push({
                        lineId,
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.images?.[0] || '',
                        quantity: qty,
                        options: options || null
                    });

                    saveCart();

                    trackEvent('AddToCart', {
                        content_ids: [product.id],
                        content_name: product.name,
                        content_type: 'product',
                        value: product.price * qty,
                        currency: 'DZD'
                    });

                    navigate('checkout');
                }
            } finally {
                setTimeout(() => { isProcessingAction = false; }, 1000);
            }
        }

        function renderCart() {
            const main = document.getElementById('mainContent');

            if (state.cart.length === 0) {
                main.innerHTML = `
                    <div class="text-center py-16">
                        <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <h2 class="text-2xl font-bold text-gray-600 mb-2">سلة المشتريات فارغة</h2>
                        <p class="text-gray-500 mb-6">أضف بعض المنتجات للبدء</p>
                        <button onclick="navigate('home')" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 focus-ring">تصفح المنتجات</button>
                    </div>
                `;
                return;
            }

            const subtotal = calculateSubtotal();

            main.innerHTML = `
                <h1 class="text-2xl font-bold mb-6">سلة المشتريات</h1>

                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-4">
                        ${state.cart.map(item => `
                            <div class="bg-white rounded-xl p-4 shadow-sm flex gap-4">
                                <img src="${getImageUrl(item.image, 'thumbnail')}" alt="${escapeHtml(item.name)}" class="w-24 h-24 object-cover rounded-lg">
                                <div class="flex-1">
                                    <h3 class="font-bold mb-1">${escapeHtml(item.name)}</h3>
                                    ${item.options ? `<p class="text-xs text-gray-500">${escapeHtml(formatOptions(item.options))}</p>` : ''}
                                    <p class="text-blue-600 font-bold">${formatPrice(item.price)}</p>
                                    <div class="flex items-center gap-4 mt-2">
                                        <div class="flex items-center border rounded-lg">
                                            <button onclick="updateQuantity('${item.lineId}', ${item.quantity - 1})" class="px-3 py-1 hover:bg-gray-100 focus-ring" aria-label="تقليل">-</button>
                                            <span class="px-3">${item.quantity}</span>
                                            <button onclick="updateQuantity('${item.lineId}', ${item.quantity + 1})" class="px-3 py-1 hover:bg-gray-100 focus-ring" aria-label="زيادة">+</button>
                                        </div>
                                        <button onclick="removeFromCart('${item.lineId}')" class="text-red-500 hover:text-red-700 focus-ring" aria-label="حذف">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-left"><span class="font-bold">${formatPrice(item.price * item.quantity)}</span></div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm h-fit sticky top-24">
                        <h3 class="font-bold text-lg mb-4">ملخص الطلب</h3>
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between">
                                <span class="text-gray-600">المجموع الفرعي</span>
                                <span class="font-bold">${formatPrice(subtotal)}</span>
                            </div>
                            <div class="flex justify-between text-gray-500">
                                <span>التوصيل</span>
                                <span>يُحسب لاحقاً</span>
                            </div>
                        </div>
                        <button onclick="navigate('checkout')" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 focus-ring">إتمام الطلب</button>
                    </div>
                </div>
            `;
        }

        function renderCheckout() {
            if (state.cart.length === 0) {
                navigate('cart');
                return;
            }

            trackEvent('InitiateCheckout', {
                content_ids: state.cart.map(i => i.id),
                num_items: state.cart.reduce((s, i) => s + i.quantity, 0),
                value: calculateSubtotal(),
                currency: 'DZD'
            });

            const subtotal = calculateSubtotal();

            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <h1 class="text-2xl font-bold mb-6">إتمام الطلب</h1>

                <form id="checkoutForm" onsubmit="submitOrder(event)" class="grid lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h3 class="font-bold text-lg mb-4">معلومات التواصل</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">الاسم الكامل <span class="text-red-500">*</span></label>
                                    <input type="text" name="full_name" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">رقم الهاتف <span class="text-red-500">*</span></label>
                                    <input type="tel" name="phone" required pattern="^0[567][0-9]{8}$" placeholder="0555123456" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">يجب أن يبدأ بـ 05 أو 06 أو 07</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h3 class="font-bold text-lg mb-4">معلومات التوصيل</h3>
                            <div class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">الولاية <span class="text-red-500">*</span></label>
                                        <select name="wilaya" required onchange="onWilayaChange(this.value)" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">اختر الولاية</option>
                                            ${state.wilayas.map(w => `<option value="${w.code}">${w.code} - ${w.name_ar || w.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">البلدية</label>
                                        <input type="text" name="commune" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">نوع التوصيل <span class="text-red-500">*</span></label>
                                    <div id="deliveryTypes" class="grid md:grid-cols-2 gap-4">
                                        <label class="delivery-option border-2 rounded-xl p-4 cursor-pointer hover:border-blue-300 hidden">
                                            <input type="radio" name="delivery_type" value="office" class="hidden" onchange="onDeliveryTypeChange()">
                                            <div class="flex items-center gap-3">
                                                <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center delivery-radio"><div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div></div>
                                                <div>
                                                    <span class="font-medium">استلام من المكتب</span>
                                                    <p class="text-sm text-gray-500" id="officePrice"></p>
                                                </div>
                                            </div>
                                        </label>
                                        <label class="delivery-option border-2 rounded-xl p-4 cursor-pointer hover:border-blue-300 hidden">
                                            <input type="radio" name="delivery_type" value="home" class="hidden" onchange="onDeliveryTypeChange()">
                                            <div class="flex items-center gap-3">
                                                <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center delivery-radio"><div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div></div>
                                                <div>
                                                    <span class="font-medium">توصيل للمنزل</span>
                                                    <p class="text-sm text-gray-500" id="homePrice"></p>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div id="addressField" class="hidden">
                                    <label class="block text-sm font-medium mb-1">العنوان بالتفصيل <span class="text-red-500">*</span></label>
                                    <textarea name="address" rows="2" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="الحي، الشارع، رقم العمارة..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-1">ملاحظات (اختياري)</label>
                                    <textarea name="note" rows="2" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="أي تعليمات إضافية..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h3 class="font-bold text-lg mb-4">التحقق الأمني</h3>
                            <div id="turnstileContainer" class="min-h-[70px]"></div>
                            <p class="text-xs text-gray-500 mt-2">قد لا يظهر التحقق إذا كان AdBlock/Brave Shields مفعّل.</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm h-fit sticky top-24">
                        <h3 class="font-bold text-lg mb-4">ملخص الطلب</h3>

                        <div class="space-y-3 mb-4">
                            ${state.cart.map(item => `
                                <div class="flex gap-3">
                                    <img src="${getImageUrl(item.image, 'thumbnail')}" class="w-16 h-16 rounded-lg object-cover">
                                    <div class="flex-1">
                                        <p class="text-sm font-medium">${escapeHtml(item.name)}</p>
                                        ${item.options ? `<p class="text-xs text-gray-500">${escapeHtml(formatOptions(item.options))}</p>` : ''}
                                        <p class="text-xs text-gray-500">الكمية: ${item.quantity}</p>
                                    </div>
                                    <span class="font-bold text-sm">${formatPrice(item.price * item.quantity)}</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="border-t pt-4 space-y-2">
                            <div class="flex justify-between"><span class="text-gray-600">المجموع الفرعي</span><span id="checkoutSubtotal">${formatPrice(subtotal)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">التوصيل</span><span id="checkoutShipping">--</span></div>
                            <div class="flex justify-between text-lg font-bold border-t pt-2"><span>الإجمالي</span><span id="checkoutTotal" class="text-blue-600">${formatPrice(subtotal)}</span></div>
                        </div>

                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 flex items-center gap-2">
                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                الدفع عند الاستلام
                            </p>
                        </div>

                        <button type="submit" id="submitOrderBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold mt-6 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed focus-ring">تأكيد الطلب</button>
                    </div>
                </form>
            `;

            // Render Turnstile in SPA mode (Turnstile script loads async)
            renderTurnstileWidget();
        }

        let selectedShipping = 0;

        function onWilayaChange(wilayaCode) {
            const rates = state.shippingRates.filter(r => r.wilaya_code === wilayaCode);
            const officeRate = rates.find(r => r.delivery_type === 'office' && r.is_enabled);
            const homeRate = rates.find(r => r.delivery_type === 'home' && r.is_enabled);

            const officeLabel = document.querySelector('[value="office"]').closest('label');
            const homeLabel = document.querySelector('[value="home"]').closest('label');

            if (officeRate) {
                officeLabel.classList.remove('hidden');
                document.getElementById('officePrice').textContent = formatPrice(officeRate.price);
            } else {
                officeLabel.classList.add('hidden');
            }

            if (homeRate) {
                homeLabel.classList.remove('hidden');
                document.getElementById('homePrice').textContent = formatPrice(homeRate.price);
            } else {
                homeLabel.classList.add('hidden');
            }

            document.querySelectorAll('[name="delivery_type"]').forEach(r => r.checked = false);
            document.querySelectorAll('.delivery-option').forEach(l => l.classList.remove('border-blue-500'));
            document.querySelectorAll('.delivery-radio div').forEach(d => d.classList.add('hidden'));
            selectedShipping = 0;
            updateCheckoutTotals();
        }

        function onDeliveryTypeChange() {
            const selected = document.querySelector('[name="delivery_type"]:checked');
            if (!selected) return;

            document.querySelectorAll('.delivery-option').forEach(l => l.classList.remove('border-blue-500'));
            document.querySelectorAll('.delivery-radio div').forEach(d => d.classList.add('hidden'));
            selected.closest('label').classList.add('border-blue-500');
            selected.closest('label').querySelector('.delivery-radio div').classList.remove('hidden');

            const addressField = document.getElementById('addressField');
            const addressInput = addressField.querySelector('textarea');
            if (selected.value === 'home') {
                addressField.classList.remove('hidden');
                addressInput.required = true;
            } else {
                addressField.classList.add('hidden');
                addressInput.required = false;
            }

            const wilayaCode = document.querySelector('[name="wilaya"]').value;
            const rate = state.shippingRates.find(r => r.wilaya_code === wilayaCode && r.delivery_type === selected.value);
            selectedShipping = rate?.price || 0;
            updateCheckoutTotals();
        }

        function updateCheckoutTotals() {
            const subtotal = calculateSubtotal();
            const shippingEl = document.getElementById('checkoutShipping');
            const totalEl = document.getElementById('checkoutTotal');
            if (shippingEl) shippingEl.textContent = selectedShipping > 0 ? formatPrice(selectedShipping) : '--';
            if (totalEl) totalEl.textContent = formatPrice(subtotal + selectedShipping);
        }

        async function submitOrder(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('submitOrderBtn');

            const deliveryType = formData.get('delivery_type');
            if (!deliveryType) {
                showToast('يرجى اختيار نوع التوصيل', 'error');
                return;
            }

            if (deliveryType === 'home' && !String(formData.get('address') || '').trim()) {
                showToast('يرجى إدخال العنوان', 'error');
                return;
            }

            const turnstileResponse = state.turnstileToken || document.querySelector('[name="cf-turnstile-response"]')?.value;
            if (!turnstileResponse) {
                showToast('يرجى إكمال التحقق الأمني', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'جاري المعالجة...';

            try {
                const eventId = generateEventId();

                const orderData = {
                    full_name: formData.get('full_name'),
                    phone: formData.get('phone'),
                    wilaya: formData.get('wilaya'),
                    commune: formData.get('commune'),
                    delivery_type: deliveryType,
                    address: formData.get('address'),
                    note: formData.get('note'),
                    cart_items: state.cart.map(item => ({
                        product_id: item.id,
                        quantity: item.quantity,
                        options: item.options || null
                    })),
                    turnstile_token: turnstileResponse,
                    event_id: eventId,
                    cart_id: state.cartId
                };

                const result = await callEdgeFunction('create-order', orderData);

                state.cart = [];
                state.cartId = null;
                state.turnstileToken = null;
                state.turnstileWidgetId = null;
                localStorage.removeItem('cart');
                localStorage.removeItem('cartId');
                updateCartBadge();

                navigate('order-success', { orderId: result.order_id, publicToken: result.public_token });

            } catch (error) {
                showToast(error.message || 'حدث خطأ، حاول مرة أخرى', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'تأكيد الطلب';

                // Reset turnstile widget if possible
                if (window.turnstile && state.turnstileWidgetId !== null) {
                    try { window.turnstile.reset(state.turnstileWidgetId); } catch {}
                }
                state.turnstileToken = null;
            }
        }

        async function renderOrderSuccess(orderId) {
            const main = document.getElementById('mainContent');
            const token = String(state.routeParams?.publicToken || '');

            main.innerHTML = `
                <div class="max-w-3xl mx-auto py-10">
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </div>
                            <div class="flex-1">
                                <h1 class="text-2xl font-bold mb-1">شكراً لك! تم استلام طلبك</h1>
                                <p class="text-gray-600">الحالة: <span class="font-semibold">بانتظار تأكيد المتجر</span></p>
                                <p class="text-gray-600 mt-2">رقم الطلب: <span class="font-mono font-bold">${orderId}</span></p>
                                <p class="text-xs text-gray-400 mt-1">احتفظ بهذا الرقم للتواصل مع المتجر.</p>
                            </div>
                        </div>

                        <div class="mt-6 border-t pt-5">
                            <div id="orderDetailsBox" class="text-gray-600 text-sm">جاري تحميل تفاصيل الطلب...</div>
                        </div>

                        <div class="mt-6 flex flex-col sm:flex-row gap-3">
                            <button onclick="navigate('home')" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 focus-ring">العودة للتسوق</button>
                            <a id="orderWhatsAppBtn" href="#" target="_blank" rel="noopener" class="flex-1 border-2 border-green-600 text-green-700 px-6 py-3 rounded-xl font-bold hover:bg-green-50 text-center focus-ring">تواصل عبر واتساب</a>
                        </div>
                    </div>
                </div>
            `;

            // Load public order details via Edge Function (no auth)
            try {
                const data = await callEdgeFunction('get-order-public', { order_id: orderId, public_token: token });
                const box = document.getElementById('orderDetailsBox');
                const btn = document.getElementById('orderWhatsAppBtn');

                const order = data.order;
                const items = data.items || [];

                const created = new Date(order.created_at);

                box.innerHTML = `
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h3 class="font-bold mb-2">معلومات العميل</h3>
                            <p><span class="text-gray-500">الاسم:</span> ${escapeHtml(order.full_name)}</p>
                            <p><span class="text-gray-500">الهاتف:</span> ${escapeHtml(order.phone)}</p>
                            <p><span class="text-gray-500">الولاية:</span> ${escapeHtml(order.wilaya)}</p>
                            ${order.commune ? `<p><span class="text-gray-500">البلدية:</span> ${escapeHtml(order.commune)}</p>` : ''}
                            ${order.address ? `<p><span class="text-gray-500">العنوان:</span> ${escapeHtml(order.address)}</p>` : ''}
                            <p><span class="text-gray-500">نوع التوصيل:</span> ${order.delivery_type === 'home' ? 'للمنزل' : 'للمكتب'}</p>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h3 class="font-bold mb-2">ملخص الطلب</h3>
                            <p><span class="text-gray-500">التاريخ:</span> ${created.toLocaleString('ar-DZ')}</p>
                            <p><span class="text-gray-500">المجموع الفرعي:</span> ${formatPrice(order.subtotal)}</p>
                            <p><span class="text-gray-500">التوصيل:</span> ${formatPrice(order.shipping)}</p>
                            <p class="text-lg font-bold mt-2"><span class="text-gray-500">الإجمالي:</span> <span class="text-blue-600">${formatPrice(order.total)}</span></p>
                        </div>
                    </div>

                    <div class="mt-4 bg-white rounded-xl border p-4">
                        <h3 class="font-bold mb-3">المنتجات</h3>
                        <div class="space-y-3">
                            ${items.map(it => `
                                <div class="flex gap-3 items-center">
                                    <img class="w-14 h-14 rounded-lg object-cover" src="${getImageUrl(it.image, 'thumbnail')}" alt="${escapeHtml(it.product_name)}">
                                    <div class="flex-1">
                                        <div class="font-semibold">${escapeHtml(it.product_name)}</div>
                                        <div class="text-xs text-gray-500">الكمية: ${it.quantity} ${it.selected_size ? `- المقاس: ${escapeHtml(it.selected_size)}` : ''} ${it.selected_color ? `- اللون: ${escapeHtml(it.selected_color)}` : ''}</div>
                                    </div>
                                    <div class="font-bold">${formatPrice(it.price * it.quantity)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                // WhatsApp
                const wa = state.settings.whatsapp || '';
                const waLink = buildWhatsAppLink(wa, `مرحباً، لدي استفسار بخصوص الطلب رقم: ${orderId}`);
                if (btn) {
                    btn.href = waLink || '#';
                    btn.classList.toggle('hidden', !waLink);
                }

                // Client-side purchase tracking (optional). Only after consent.
                trackEvent('Purchase', {
                    transaction_id: orderId,
                    value: order.total,
                    currency: 'DZD',
                    content_ids: items.map(i => i.product_id).filter(Boolean),
                    num_items: items.reduce((s, i) => s + (i.quantity || 0), 0)
                });

            } catch (e) {
                const box = document.getElementById('orderDetailsBox');
                if (box) box.textContent = 'تعذر تحميل تفاصيل الطلب. يمكنك التواصل معنا عبر واتساب.';
            }
        }

        function renderSearchResults(query) {
            const q = String(query || '').trim();
            const results = state.products.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));

            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <h1 class="text-2xl font-bold mb-2">نتائج البحث</h1>
                <p class="text-gray-600 mb-6">عن: "${escapeHtml(q)}" (${results.length} نتيجة)</p>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    ${renderProductsGrid(results)}
                </div>
            `;
        }

        const handleSearch = debounce((e) => {
            const query = e.target.value.trim();
            if (query.length >= 2) {
                navigate('search', { query });
            } else if (query.length === 0 && state.currentRoute === 'search') {
                navigate('home');
            }
        }, 300);

        // ========================================
        // INITIAL DATA
        // ========================================
        async function loadInitialData({ fullProducts } = { fullProducts: true }) {
            try {
                const tasks = [];

                if (fullProducts) {
                    tasks.push(
                        supabaseQuery('products', { filter: { is_active: 'eq.true' }, order: 'created_at.desc' }).then(d => state.products = d)
                    );
                } else {
                    state.products = [];
                }

                tasks.push(
                    supabaseQuery('categories', { filter: { is_active: 'eq.true' }, order: 'sort_order.asc' }).then(d => state.categories = d)
                );
                tasks.push(
                    supabaseQuery('wilayas', { order: 'code.asc' }).then(d => state.wilayas = d)
                );
                tasks.push(
                    supabaseQuery('shipping_rates').then(d => state.shippingRates = d)
                );

                // Settings
                tasks.push(
                    supabaseQuery('settings').then(settings => {
                        state.settings = settings.reduce((acc, s) => {
                            acc[s.key] = s.value;
                            return acc;
                        }, {});
                    }).catch(() => {})
                );

                await Promise.all(tasks);

                renderCategoriesNav();
                renderSocialLinks();

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function renderCategoriesNav() {
            const nav = document.getElementById('categoriesNav');
            nav.innerHTML = `
                <button onclick="navigate('home')" class="px-4 py-2 bg-blue-600 text-white rounded-full text-sm whitespace-nowrap focus-ring">الكل</button>
                ${state.categories.map(cat => `
                    <button onclick="navigate('category', {id: '${cat.id}'})" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm whitespace-nowrap focus-ring">${escapeHtml(cat.name)}</button>
                `).join('')}
            `;
        }

        function renderSocialLinks() {
            const container = document.getElementById('socialLinks');
            const links = [];

            const iconLink = (href, label, inner) => {
                if (!href) return;
                links.push(`<a href="${href}" target="_blank" rel="noopener" class="text-gray-400 hover:text-white" aria-label="${label}">${inner}</a>`);
            };

            iconLink(state.settings.facebook, 'فيسبوك', `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.77,7.46H14.5v-1.9c0-.9.6-1.1,1-1.1h3V.5L14.17.5C10.24.5,9.25,3.44,9.25,5.32v2.15h-3v4h3v12h5v-12h3.85Z"/></svg>`);
            iconLink(state.settings.instagram, 'انستغرام', `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12,2.16c3.2,0,3.58,0,4.85.07,3.25.15,4.77,1.69,4.92,4.92.06,1.27.07,1.65.07,4.85s0,3.58-.07,4.85c-.15,3.23-1.66,4.77-4.92,4.92-1.27.06-1.65.07-4.85.07s-3.58,0-4.85-.07c-3.26-.15-4.77-1.7-4.92-4.92-.06-1.27-.07-1.65-.07-4.85s0-3.58.07-4.85C2.38,3.92,3.9,2.38,7.15,2.23,8.42,2.18,8.8,2.16,12,2.16ZM12,0C8.74,0,8.33,0,7.05.07c-4.27.2-6.78,2.71-7,7C0,8.33,0,8.74,0,12s0,3.67.07,4.95c.2,4.27,2.71,6.78,7,7C8.33,24,8.74,24,12,24s3.67,0,4.95-.07c4.27-.2,6.78-2.71,7-7C24,15.67,24,15.26,24,12s0-3.67-.07-4.95c-.2-4.27-2.71-6.78-7-7C15.67,0,15.26,0,12,0Zm0,5.84A6.16,6.16,0,1,0,18.16,12,6.16,6.16,0,0,0,12,5.84ZM12,16a4,4,0,1,1,4-4A4,4,0,0,1,12,16ZM18.41,4.15a1.44,1.44,0,1,0,1.44,1.44A1.44,1.44,0,0,0,18.41,4.15Z"/></svg>`);
            iconLink(state.settings.tiktok, 'تيك توك', `<span class="text-sm font-semibold">TikTok</span>`);

            // New social links
            iconLink(state.settings.telegram, 'تيليغرام', `<span class="text-sm font-semibold">Telegram</span>`);
            iconLink(state.settings.snapchat, 'سناب شات', `<span class="text-sm font-semibold">Snapchat</span>`);
            iconLink(state.settings.youtube, 'يوتيوب', `<span class="text-sm font-semibold">YouTube</span>`);
            iconLink(state.settings.twitter, 'تويتر / X', `<span class="text-sm font-semibold">X</span>`);
            iconLink(buildWhatsAppLink(state.settings.whatsapp), 'واتساب', `<span class="text-sm font-semibold">WhatsApp</span>`);

            container.innerHTML = links.join('') || '<p class="text-gray-400">لا توجد روابط</p>';
        }

        // ========================================
        // TURNSTILE (SPA-safe rendering)
        // ========================================
        function renderTurnstileWidget() {
            // If Turnstile is blocked by an adblocker, window.turnstile may never exist.
            if (!CONFIG.TURNSTILE_SITE_KEY) return;

            const container = document.getElementById('turnstileContainer');
            if (!container) return;

            // If turnstile script not loaded yet, retry a few times.
            if (!window.turnstile || typeof window.turnstile.render !== 'function') {
                setTimeout(renderTurnstileWidget, 350);
                return;
            }

            // Avoid double render
            if (state.turnstileWidgetId !== null) return;

            // Clear
            container.innerHTML = '';

            try {
                state.turnstileWidgetId = window.turnstile.render(container, {
                    sitekey: CONFIG.TURNSTILE_SITE_KEY,
                    theme: 'light',
                    callback: (token) => {
                        state.turnstileToken = token;
                    },
                    'error-callback': () => {
                        state.turnstileToken = null;
                    },
                    'expired-callback': () => {
                        state.turnstileToken = null;
                    }
                });
            } catch (e) {
                // If something goes wrong, retry.
                state.turnstileWidgetId = null;
                setTimeout(renderTurnstileWidget, 500);
            }
        }

        // ========================================
        // INIT
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            updateCartBadge();

            if (!ensureConfigOrShowError()) {
                // Still allow browsing cached cart UI etc, but API calls will fail.
            }

            checkConsent();

            const { route, params } = parseRouteFromLocation();
            state.currentRoute = route;
            state.routeParams = params;

            // Performance: load full catalog only for listing routes.
            const needsFullCatalog = ['home', 'category', 'search'].includes(route);
            await loadInitialData({ fullProducts: needsFullCatalog });

            renderCurrentRoute();
        });
    </script>
</body>
</html>
